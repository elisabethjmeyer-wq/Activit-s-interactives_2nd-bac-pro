<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEX n¬∞4 | Espace cours</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-bg: #eef2ff;
            --accent-yellow: #f59e0b;
            --accent-green: #10b981;
            --accent-green-light: #d1fae5;
            --accent-red: #ef4444;
            --accent-red-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --sidebar-width: 260px;
            --header-height: 64px;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-height);
            z-index: 100;
        }

        .header-inner {
            height: 100%;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            width: 42px; height: 42px;
            background: var(--gray-100);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--gray-600);
            transition: all 0.2s;
        }

        .menu-toggle:hover { background: var(--primary-bg); color: var(--primary); }
        .menu-toggle.active { background: var(--primary); color: white; }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--gray-800);
        }

        .logo-icon {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .logo-text { font-weight: 700; font-size: 16px; }
        .logo-text span { color: var(--gray-400); font-weight: 500; }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            position: fixed;
            top: var(--header-height);
            left: 0; bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar-inner { padding: 16px 12px; }
        .sidebar-section { margin-bottom: 8px; }
        .sidebar-section-title {
            font-size: 11px; font-weight: 700; color: var(--gray-400);
            text-transform: uppercase; letter-spacing: 0.05em;
            padding: 12px 12px 8px;
            display: flex; align-items: center; gap: 8px;
        }

        .sidebar-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 12px; border-radius: 10px;
            text-decoration: none; color: var(--gray-700);
            font-size: 14px; font-weight: 500; transition: all 0.15s;
        }

        .sidebar-item:hover { background: var(--primary-bg); color: var(--primary); }
        .sidebar-item.active { background: var(--primary-bg); color: var(--primary); }
        .sidebar-item.disabled { opacity: 0.5; cursor: not-allowed; }
        .sidebar-item .item-icon {
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; background: var(--gray-100); transition: all 0.15s;
        }
        .sidebar-item:hover .item-icon, .sidebar-item.active .item-icon { background: var(--primary); color: white; }
        .sidebar-item .item-text { flex: 1; }
        .sidebar-item .item-sub { display: block; font-size: 11px; color: var(--gray-400); }

        .main {
            margin-left: var(--sidebar-width);
            padding: 24px;
            padding-top: calc(var(--header-height) + 24px);
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .sidebar.collapsed ~ .main { margin-left: 0; }
        .main-inner { max-width: 1100px; margin: 0 auto; }

        .breadcrumb {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 24px; font-size: 14px;
        }
        .breadcrumb a { color: var(--gray-500); text-decoration: none; }
        .breadcrumb a:hover { color: var(--primary); }
        .breadcrumb .separator { color: var(--gray-300); }
        .breadcrumb .current { color: var(--gray-800); font-weight: 600; }

        .page-header { margin-bottom: 24px; }
        .page-header h1 { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
        .page-header p { color: var(--gray-500); font-size: 15px; }

        .timer-box {
            background: linear-gradient(135deg, var(--accent-yellow), #fbbf24);
            color: white; border-radius: var(--radius);
            padding: 16px; margin-bottom: 24px;
            text-align: center; font-size: 22px; font-weight: bold;
        }
        .timer-box.warning { background: linear-gradient(135deg, var(--accent-red), #dc2626); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }

        .instructions {
            background: white; border-radius: var(--radius);
            padding: 20px; margin-bottom: 24px;
            border-left: 4px solid var(--accent-yellow);
            box-shadow: var(--shadow);
        }
        .instructions strong { color: var(--accent-yellow); }
        .instructions p { color: var(--gray-600); margin-top: 8px; }

        .exercise-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 900px) { .exercise-layout { grid-template-columns: 1fr; } }

        .document-card {
            background: white; border-radius: var(--radius-lg);
            padding: 20px; box-shadow: var(--shadow-md);
            border: 2px solid var(--gray-200);
        }
        .document-card h3 { font-size: 16px; margin-bottom: 16px; color: var(--gray-800); }

        .document-container {
            background: var(--gray-50); border-radius: var(--radius);
            overflow: hidden;
        }
        .document-container iframe { width: 100%; height: 400px; border: none; }
        .document-container img { width: 100%; height: auto; }

        .document-legende {
            font-size: 13px; color: var(--gray-500); font-style: italic;
            padding: 12px; background: var(--gray-100);
        }

        .form-card {
            background: white; border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-md);
            border: 2px solid var(--gray-200);
        }
        .form-card h3 { font-size: 16px; margin-bottom: 16px; color: var(--gray-800); }

        .word-highlight {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 8px 16px; border-radius: 8px;
            font-size: 20px; font-weight: 700;
            display: inline-block; margin-bottom: 20px;
        }

        .step-section { margin-bottom: 24px; }
        .step-section h4 {
            font-size: 14px; font-weight: 600; color: var(--primary);
            margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
        }
        .step-section h4 .step-number {
            width: 24px; height: 24px;
            background: var(--primary); color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }
        .step-section p { font-size: 13px; color: var(--gray-500); margin-bottom: 8px; }

        .step-section textarea {
            width: 100%; min-height: 100px;
            padding: 12px; border: 2px solid var(--gray-200);
            border-radius: 8px; font-size: 14px;
            font-family: inherit; resize: vertical;
            transition: all 0.3s;
        }
        .step-section textarea:focus { outline: none; border-color: var(--primary); }

        .correction-box {
            background: var(--accent-green-light);
            border-radius: 8px; padding: 12px;
            margin-top: 12px; display: none;
            font-size: 14px; color: #065f46;
        }
        .correction-box.show { display: block; }
        .correction-box strong { color: var(--accent-green); }

        .buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        .buttons button {
            flex: 1; min-width: 120px; padding: 12px;
            border: none; border-radius: var(--radius);
            font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
            box-shadow: var(--shadow); font-family: inherit;
        }
        .buttons button:hover { transform: translateY(-2px); }
        .btn-verify { background: linear-gradient(135deg, var(--accent-green), #34d399); color: white; }
        .btn-solution { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .btn-restart { background: linear-gradient(135deg, var(--gray-500), var(--gray-400)); color: white; }

        .result {
            background: var(--accent-green-light);
            border: 2px solid var(--accent-green);
            border-radius: var(--radius);
            padding: 16px; margin-top: 20px; display: none;
        }
        .result.show { display: block; }
        .result h3 { color: #065f46; margin-bottom: 8px; font-size: 15px; }
        .result p { color: #047857; font-size: 14px; }

        .loading { text-align: center; padding: 60px 20px; color: var(--gray-500); }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-message {
            background: var(--accent-red-light);
            border: 2px solid var(--accent-red);
            border-radius: var(--radius);
            padding: 20px; text-align: center; color: #991b1b;
        }

        .overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 40; opacity: 0;
            pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.visible { opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            .sidebar { z-index: 60; }
            .main { margin-left: 0; }
            .buttons button { min-width: 100%; }
        }
    </style>
</head>
<body>

    <div class="overlay" id="overlay"></div>

    <header class="header">
        <div class="header-inner">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <a href="/Activit-s-interactives_2nd-bac-pro/index.html" class="logo">
                <div class="logo-icon">üìö</div>
                <div class="logo-text">Espace cours <span>‚Ä¢ Mme Meyer</span></div>
            </a>
        </div>
    </header>

    <aside class="sidebar collapsed" id="sidebar">
        <div class="sidebar-inner" id="sidebarContent"></div>
    </aside>

    <main class="main">
        <div class="main-inner">
            <nav class="breadcrumb">
                <a href="/Activit-s-interactives_2nd-bac-pro/index.html">üè† Accueil</a>
                <span class="separator">‚Ä∫</span>
                <a href="/Activit-s-interactives_2nd-bac-pro/pages/entrainement-bex.html">Entra√Ænement BEX</a>
                <span class="separator">‚Ä∫</span>
                <span class="current" id="breadcrumbCurrent">üìñ BEX n¬∞4</span>
            </nav>

            <div class="page-header">
                <h1 id="pageTitle">üìñ BEX n¬∞4 - D√©duire le sens d'un mot</h1>
                <p>Entra√Æne-toi √† comprendre un mot inconnu gr√¢ce au contexte.</p>
            </div>

            <div id="content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement de l'exercice...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const BASE_PATH = '/Activit-s-interactives_2nd-bac-pro';
        const CURRENT_PAGE = 'entrainement-bex';
        const SHEET_ID = '1voGqAzl_sgsa8ZKs_uDEFBanNUTBfkNz9Hq5wI1Vlzg';
        const SHEET_NAME = 'BEX4_DATA';

        let exerciseData = null;
        let timeLeft = 600;
        let timerInterval = null;

        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const overlay = document.getElementById('overlay');

        function toggleSidebar() {
            const isCollapsed = sidebar.classList.contains('collapsed');
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                menuToggle.classList.add('active');
                overlay.classList.add('visible');
            } else {
                sidebar.classList.add('collapsed');
                menuToggle.classList.remove('active');
                overlay.classList.remove('visible');
            }
            localStorage.setItem('sidebarOpen', !sidebar.classList.contains('collapsed'));
        }

        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        if (localStorage.getItem('sidebarOpen') === 'true') {
            sidebar.classList.remove('collapsed');
            menuToggle.classList.add('active');
        }

        async function loadSidebar() {
            try {
                const response = await fetch(`${BASE_PATH}/components/sidebar.html`);
                const html = await response.text();
                document.getElementById('sidebarContent').innerHTML = html;
                
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    if (item.dataset.page === CURRENT_PAGE) item.classList.add('active');
                });

                document.querySelectorAll('.sidebar-item.disabled, .sidebar-item[href="#"]').forEach(link => {
                    link.addEventListener('click', e => e.preventDefault());
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return { exo: parseInt(params.get('exo')) || 1 };
        }

        // ===== TRANSFORMATION AUTOMATIQUE DES URLs =====
        // Tu peux coller n'importe quel lien Google Drive, il sera transform√© automatiquement !
        function transformUrl(url, type) {
            if (!url) return '';
            
            // D√©tecter si c'est un lien Google Drive
            const driveMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
            const docsMatch = url.match(/docs\.google\.com\/document\/d\/([a-zA-Z0-9_-]+)/);
            const sheetsMatch = url.match(/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
            const slidesMatch = url.match(/docs\.google\.com\/presentation\/d\/([a-zA-Z0-9_-]+)/);
            
            if (driveMatch) {
                const fileId = driveMatch[1];
                // Pour les images, on utilise /preview dans un iframe (plus fiable)
                // Pour tous les fichiers Drive (PDF, images, sons, vid√©os), /preview fonctionne
                return `https://drive.google.com/file/d/${fileId}/preview`;
            }
            
            if (docsMatch) {
                const docId = docsMatch[1];
                return `https://docs.google.com/document/d/${docId}/preview`;
            }
            
            if (sheetsMatch) {
                const sheetId = sheetsMatch[1];
                return `https://docs.google.com/spreadsheets/d/${sheetId}/preview`;
            }
            
            if (slidesMatch) {
                const slideId = slidesMatch[1];
                return `https://docs.google.com/presentation/d/${slideId}/preview`;
            }
            
            // YouTube
            const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
            if (youtubeMatch) {
                return `https://www.youtube.com/embed/${youtubeMatch[1]}`;
            }
            
            // Si ce n'est pas un lien sp√©cial, retourner tel quel
            return url;
        }

        async function loadExerciseData(exoNum) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}') + 1;
                const data = JSON.parse(text.substring(jsonStart, jsonEnd));
                
                for (let row of data.table.rows) {
                    const numExo = row.c[0]?.v;
                    if (numExo === exoNum) {
                        return {
                            numExo: numExo,
                            titre: row.c[1]?.v || `Exercice ${exoNum}`,
                            mot: row.c[2]?.v || 'mot',
                            temps: row.c[3]?.v || 600,
                            documentTitre: row.c[4]?.v || 'Document',
                            documentUrl: row.c[5]?.v || '',
                            documentLegende: row.c[6]?.v || '',
                            corrigeEtape1: row.c[7]?.v || '',
                            corrigeEtape2: row.c[8]?.v || ''
                        };
                    }
                }
                
                throw new Error(`Exercice ${exoNum} non trouv√©`);
            } catch (error) {
                console.error('Erreur:', error);
                throw error;
            }
        }

        function renderExercise(data) {
            document.getElementById('breadcrumbCurrent').textContent = `üìñ BEX n¬∞4 - ${data.titre}`;
            document.getElementById('pageTitle').textContent = `üìñ BEX n¬∞4 - ${data.titre}`;
            document.title = `BEX n¬∞4 - ${data.titre} | Espace cours`;
            
            timeLeft = data.temps || 600;

            // Transformer l'URL automatiquement
            const finalUrl = transformUrl(data.documentUrl, data.documentType);
            
            let documentHtml = '';
            if (finalUrl) {
                // Utiliser iframe pour tous les types (plus flexible et compatible)
                documentHtml = `<iframe src="${finalUrl}" title="${data.documentTitre}" allow="autoplay"></iframe>`;
            } else {
                documentHtml = `<p style="padding: 20px; color: var(--gray-500);">Document non disponible</p>`;
            }

            const html = `
                <div class="timer-box" id="timer">‚è±Ô∏è Temps restant : ${formatTime(timeLeft)}</div>

                <div class="instructions">
                    <strong>üìã Consigne :</strong>
                    <p>Lis le texte et essaie de comprendre le sens du mot "<strong>${data.mot}</strong>" gr√¢ce au contexte.</p>
                </div>

                <div class="exercise-layout">
                    <div class="document-card">
                        <h3>üìÑ ${data.documentTitre}</h3>
                        <div class="document-container">
                            ${documentHtml}
                        </div>
                        <div class="document-legende">${data.documentLegende}</div>
                    </div>

                    <div class="form-card">
                        <h3>‚úèÔ∏è Analyse du mot</h3>
                        <div class="word-highlight">${data.mot}</div>

                        <div class="step-section">
                            <h4><span class="step-number">1</span> Rel√®ve les indices du texte</h4>
                            <p>Quels mots ou expressions du texte t'aident √† comprendre le sens ?</p>
                            <textarea id="etape1" placeholder="Note ici les indices que tu rep√®res dans le texte..."></textarea>
                            <div class="correction-box" id="correction1">
                                <strong>Corrig√© :</strong> ${data.corrigeEtape1}
                            </div>
                        </div>

                        <div class="step-section">
                            <h4><span class="step-number">2</span> Propose une d√©finition</h4>
                            <p>D'apr√®s les indices, que signifie ce mot selon toi ?</p>
                            <textarea id="etape2" placeholder="√âcris ta d√©finition du mot..."></textarea>
                            <div class="correction-box" id="correction2">
                                <strong>Corrig√© :</strong> ${data.corrigeEtape2}
                            </div>
                        </div>

                        <div class="buttons">
                            <button class="btn-solution" onclick="showSolution()">üìñ Voir le corrig√©</button>
                            <button class="btn-restart" onclick="restart()">üîÑ Recommencer</button>
                        </div>

                        <div class="result" id="result">
                            <h3>üìñ Corrig√© affich√©</h3>
                            <p id="resultMessage">Compare tes r√©ponses avec le corrig√© ci-dessus.</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
            startTimer();
        }

        function renderError(message) {
            document.getElementById('content').innerHTML = `
                <div class="error-message">
                    <h3>‚ùå Erreur</h3>
                    <p>${message}</p>
                    <p style="margin-top: 12px;">
                        <a href="${BASE_PATH}/pages/entrainement-bex.html">‚Üê Retour</a>
                    </p>
                </div>
            `;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = `‚è±Ô∏è Temps restant : ${formatTime(timeLeft)}`;
                    if (timeLeft <= 120) timerEl.classList.add('warning');
                    if (timeLeft <= 0) { clearInterval(timerInterval); showSolution(); }
                }
            }, 1000);
        }

        function showSolution() {
            clearInterval(timerInterval);
            document.getElementById('correction1').classList.add('show');
            document.getElementById('correction2').classList.add('show');
            document.getElementById('result').classList.add('show');
        }

        function restart() {
            document.getElementById('etape1').value = '';
            document.getElementById('etape2').value = '';
            document.getElementById('correction1').classList.remove('show');
            document.getElementById('correction2').classList.remove('show');
            document.getElementById('result').classList.remove('show');

            clearInterval(timerInterval);
            timeLeft = exerciseData.temps || 600;
            document.getElementById('timer').classList.remove('warning');
            document.getElementById('timer').textContent = `‚è±Ô∏è Temps restant : ${formatTime(timeLeft)}`;
            startTimer();
        }

        async function init() {
            await loadSidebar();
            const params = getUrlParams();
            
            try {
                exerciseData = await loadExerciseData(params.exo);
                renderExercise(exerciseData);
            } catch (error) {
                renderError(`Impossible de charger l'exercice ${params.exo}.`);
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
