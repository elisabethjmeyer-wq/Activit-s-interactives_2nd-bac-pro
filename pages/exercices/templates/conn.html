<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âvaluation de connaissances | Espace cours</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --primary-bg: #eef2ff;
            --accent-green: #10b981;
            --accent-green-light: #d1fae5;
            --accent-orange: #f59e0b;
            --accent-orange-light: #fef3c7;
            --accent-red: #ef4444;
            --accent-red-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --sidebar-width: 260px;
            --header-height: 64px;
            --radius: 12px;
            --radius-lg: 16px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* ===== HEADER ===== */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            z-index: 100;
        }

        .header-inner {
            height: 100%;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            width: 42px;
            height: 42px;
            background: var(--gray-100);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--gray-600);
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .menu-toggle:hover {
            background: var(--primary-bg);
            color: var(--primary);
        }

        .menu-toggle.active {
            background: var(--primary);
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--gray-800);
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 16px;
        }

        .logo-text span {
            color: var(--gray-400);
            font-weight: 500;
        }

        /* Timer dans le header */
        .header-timer {
            margin-left: auto;
            background: var(--accent-green);
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-timer.warning {
            background: var(--accent-orange);
            animation: pulse 1s infinite;
        }

        .header-timer.danger {
            background: var(--accent-red);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 50;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-inner {
            padding: 16px 12px;
        }

        /* ===== OVERLAY ===== */
        .overlay {
            position: fixed;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .overlay.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* ===== MAIN ===== */
        .main {
            margin-left: var(--sidebar-width);
            padding: 24px;
            padding-top: calc(var(--header-height) + 24px);
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .sidebar.collapsed ~ .main {
            margin-left: 0;
        }

        .main-inner {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* ===== BREADCRUMB ===== */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .breadcrumb a {
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb a:hover {
            color: var(--primary);
        }

        .breadcrumb .separator {
            color: var(--gray-300);
        }

        .breadcrumb .current {
            color: var(--gray-700);
            font-weight: 500;
        }

        /* ===== PAGE HEADER ===== */
        .page-header {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            border-radius: var(--radius-lg);
            padding: 24px 32px;
            margin-bottom: 24px;
            color: white;
        }

        .page-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .page-header-meta {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .meta-item {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            background: white;
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-count {
            font-size: 14px;
            color: var(--gray-500);
        }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), #34d399);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            gap: 8px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            background: var(--gray-100);
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.2s;
        }

        .progress-step.active {
            background: var(--primary);
            color: white;
        }

        .progress-step.completed {
            background: var(--accent-green-light);
            color: var(--accent-green);
        }

        .progress-step:hover:not(.active) {
            background: var(--gray-200);
        }

        /* ===== LOADING ===== */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ERROR ===== */
        .error-state {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .error-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* ===== SECTION ===== */
        .section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--gray-100);
        }

        .section-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .section-icon.chrono { background: linear-gradient(135deg, #10b981, #059669); }
        .section-icon.dates { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .section-icon.perso { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .section-icon.vocab { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .section-icon.lieux { background: linear-gradient(135deg, #ec4899, #db2777); }

        .section-info h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .section-info p {
            font-size: 14px;
            color: var(--gray-500);
        }

        /* ===== HINT BOX ===== */
        .hint-box {
            background: var(--accent-orange-light);
            border-radius: var(--radius);
            padding: 14px 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .hint-box .icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .hint-box .text {
            font-size: 14px;
            color: var(--gray-700);
        }

        /* ===== FRISE CHRONOLOGIE ===== */
        .frise-container {
            position: relative;
            padding: 50px 20px 30px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .frise-line {
            position: absolute;
            top: 50%;
            left: 20px;
            right: 20px;
            height: 6px;
            background: linear-gradient(90deg, #34d399, #10b981, #34d399);
            border-radius: 3px;
            transform: translateY(-50%);
        }

        .frise-points {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
            gap: 10px;
        }

        .frise-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 180px;
        }

        .frise-date {
            background: var(--accent-green);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: var(--shadow-md);
        }

        .frise-dot {
            width: 24px;
            height: 24px;
            background: white;
            border: 5px solid var(--accent-green);
            border-radius: 50%;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .event-input {
            width: 100%;
            max-width: 180px;
            padding: 12px 14px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            text-align: center;
            min-height: 80px;
            resize: none;
            line-height: 1.4;
            transition: all 0.2s;
        }

        .event-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .date-input {
            width: 100px;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            font-family: inherit;
            transition: all 0.2s;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .frise-event-fixed {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 12px 14px;
            max-width: 180px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            line-height: 1.4;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== QUESTIONS LIST ===== */
        .questions-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .question-item {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 20px;
            border: 2px solid var(--gray-200);
        }

        .question-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .question-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .question-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .question-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Correction styles */
        .question-input.correct, .event-input.correct, .date-input.correct {
            border-color: var(--accent-green);
            background: var(--accent-green-light);
        }

        .question-input.incorrect, .event-input.incorrect, .date-input.incorrect {
            border-color: var(--accent-red);
            background: var(--accent-red-light);
        }

        .correction-text {
            margin-top: 8px;
            font-size: 14px;
            color: var(--accent-green);
            font-weight: 600;
        }

        /* ===== BUTTONS ===== */
        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        /* ===== RESULTS ===== */
        .results-container {
            display: none;
        }

        .results-container.visible {
            display: block;
        }

        .results-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .results-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .results-score {
            font-size: 48px;
            font-weight: 800;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .results-percentage {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .results-percentage.success {
            background: var(--accent-green-light);
            color: var(--accent-green);
        }

        .results-percentage.warning {
            background: var(--accent-orange-light);
            color: var(--accent-orange);
        }

        .results-percentage.fail {
            background: var(--accent-red-light);
            color: var(--accent-red);
        }

        .results-message {
            font-size: 18px;
            color: var(--gray-600);
            margin-bottom: 24px;
        }

        .results-details {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .detail-item {
            background: var(--gray-50);
            padding: 12px 20px;
            border-radius: var(--radius);
            text-align: center;
        }

        .detail-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-800);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .sidebar {
                z-index: 60;
            }

            .main {
                margin-left: 0;
            }

            .page-header h1 {
                font-size: 20px;
            }

            .frise-container {
                padding: 30px 10px;
            }

            .frise-points {
                flex-direction: column;
                gap: 30px;
                align-items: stretch;
            }

            .frise-line {
                width: 6px;
                height: calc(100% - 60px);
                top: 30px;
                left: 50px;
                transform: none;
            }

            .frise-point {
                flex-direction: row;
                gap: 16px;
                max-width: none;
            }

            .frise-date, .date-input {
                min-width: 80px;
            }

            .event-input, .frise-event-fixed {
                flex: 1;
                max-width: none;
                min-height: 60px;
                text-align: left;
            }

            .progress-steps {
                flex-wrap: wrap;
            }

            .progress-step {
                flex: none;
                width: calc(33% - 6px);
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-inner">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <a href="/Activit-s-interactives_2nd-bac-pro/index.html" class="logo">
                <div class="logo-icon">üìö</div>
                <div class="logo-text">Espace cours <span>‚Ä¢ Mme Meyer</span></div>
            </a>
            <div class="header-timer" id="headerTimer">
                ‚è±Ô∏è <span id="timerDisplay">--:--</span>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="sidebar collapsed" id="sidebar">
        <div class="sidebar-inner" id="sidebarContent">
            <!-- Charg√© par JavaScript -->
        </div>
    </aside>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay"></div>

    <!-- MAIN -->
    <main class="main">
        <div class="main-inner">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/Activit-s-interactives_2nd-bac-pro/index.html">üè† Accueil</a>
                <span class="separator">‚Ä∫</span>
                <a href="/Activit-s-interactives_2nd-bac-pro/pages/entrainement-connaissances.html">Connaissances</a>
                <span class="separator">‚Ä∫</span>
                <span class="current" id="breadcrumbCurrent">√âvaluation</span>
            </nav>

            <!-- Page Header -->
            <div class="page-header" id="pageHeader">
                <h1>‚úÖ <span id="evalTitle">Chargement...</span></h1>
                <p id="evalSubtitle">√âvaluation de connaissances</p>
                <div class="page-header-meta" id="evalMeta">
                    <!-- Rempli par JS -->
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Chargement de l'√©valuation...</p>
            </div>

            <!-- Error -->
            <div class="error-state" id="errorState">
                <div class="icon">üòï</div>
                <h3>√âvaluation introuvable</h3>
                <p>Cette √©valuation n'existe pas ou n'est pas encore disponible.</p>
                <div class="buttons" style="margin-top: 20px;">
                    <a href="/Activit-s-interactives_2nd-bac-pro/pages/entrainement-connaissances.html" class="btn btn-primary">‚Üê Retour au menu</a>
                </div>
            </div>

            <!-- Content Container -->
            <div id="contentContainer" style="display: none;">
                
                <!-- Progress -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-header">
                        <span class="progress-title">Progression</span>
                        <span class="progress-count" id="progressCount">0 / 0 questions</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-steps" id="progressSteps">
                        <!-- G√©n√©r√© par JS -->
                    </div>
                </div>

                <!-- Sections (g√©n√©r√©es par JS) -->
                <div id="sectionsContainer"></div>

                <!-- Navigation -->
                <div class="buttons" id="navButtons">
                    <button class="btn btn-secondary" id="btnPrev" onclick="prevSection()" style="display: none;">‚Üê Pr√©c√©dent</button>
                    <button class="btn btn-primary" id="btnNext" onclick="nextSection()">Suivant ‚Üí</button>
                    <button class="btn btn-success" id="btnSubmit" onclick="submitEvaluation()" style="display: none;">‚úì Terminer l'√©valuation</button>
                </div>
            </div>

            <!-- Results -->
            <div class="results-container" id="resultsContainer">
                <div class="results-card">
                    <div class="results-icon" id="resultsIcon">üéâ</div>
                    <div class="results-score" id="resultsScore">0/0</div>
                    <div class="results-percentage" id="resultsPercentage">0%</div>
                    <div class="results-message" id="resultsMessage">Bravo !</div>
                    <div class="results-details" id="resultsDetails">
                        <!-- G√©n√©r√© par JS -->
                    </div>
                    <div class="buttons">
                        <a href="/Activit-s-interactives_2nd-bac-pro/pages/entrainement-connaissances.html" class="btn btn-secondary">‚Üê Retour au menu</a>
                        <button class="btn btn-primary" onclick="location.reload()">üîÑ Recommencer</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ===== CONFIG =====
        const BASE_PATH = '/Activit-s-interactives_2nd-bac-pro';
        const SHEET_ID = '1voGqAzl_sgsa8ZKs_uDEFBanNUTBfkNz9Hq5wI1Vlzg';
        
        // Onglets
        const SHEET_CONFIG = 'ENTRAINEMENTS/EVAL';
        const SHEET_MENU = 'MENU_CONN';
        const SHEET_CHRONO = 'Q_CHRONOLOGIE';

        // Variables globales
        let evalConfig = null;
        let leconInfo = null;
        let sections = [];
        let currentSection = 0;
        let timerInterval = null;
        let timeRemaining = 0;
        let answers = {};
        let isSubmitted = false;

        // ===== URL PARAMS =====
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                chap: params.get('chap') || 'L4',
                sujet: parseInt(params.get('sujet')) || 1
            };
        }

        // ===== SIDEBAR =====
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const overlay = document.getElementById('overlay');

        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            menuToggle.classList.toggle('active');
            overlay.classList.toggle('visible');
        }

        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        async function loadSidebar() {
            try {
                const response = await fetch(`${BASE_PATH}/components/sidebar.html`);
                if (response.ok) {
                    document.getElementById('sidebarContent').innerHTML = await response.text();
                }
            } catch (e) {
                console.error('Erreur sidebar:', e);
            }
        }

        // ===== FETCH GOOGLE SHEET =====
        async function fetchSheet(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
            const response = await fetch(url);
            const text = await response.text();
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}') + 1;
            return JSON.parse(text.substring(jsonStart, jsonEnd));
        }

        // ===== LOAD CONFIG =====
        async function loadConfig() {
            const params = getUrlParams();
            
            try {
                // 1. Charger la config depuis ENTRAINEMENTS/EVAL
                const configJson = await fetchSheet(SHEET_CONFIG);
                
                for (let row of configJson.table.rows) {
                    if (!row.c) continue;
                    const numLecon = String(row.c[0]?.v || '').trim();
                    const numExo = parseInt(row.c[1]?.v) || 0;
                    
                    if (numLecon === params.chap && numExo === params.sujet) {
                        evalConfig = {
                            numLecon: numLecon,
                            numExercice: numExo,
                            duree: parseInt(row.c[2]?.v) || 15,
                            seuil: parseInt(row.c[3]?.v) || 80,
                            nbDates: parseInt(row.c[4]?.v) || 0,
                            nbChrono: parseInt(row.c[5]?.v) || 0,
                            nbPerso: parseInt(row.c[6]?.v) || 0,
                            nbVocab: parseInt(row.c[7]?.v) || 0,
                            nbLieux: parseInt(row.c[8]?.v) || 0,
                            melanger: String(row.c[9]?.v || '').toLowerCase() === 'oui'
                        };
                        break;
                    }
                }

                if (!evalConfig) {
                    throw new Error('Config not found');
                }

                // 2. Charger les infos de la le√ßon depuis MENU_CONN
                const menuJson = await fetchSheet(SHEET_MENU);
                
                for (let row of menuJson.table.rows) {
                    if (!row.c) continue;
                    const numLecon = String(row.c[0]?.v || '').trim();
                    const numExo = parseInt(row.c[1]?.v) || 0;
                    const titreLecon = String(row.c[2]?.v || '').trim();
                    
                    if (numLecon === params.chap && numExo === 0 && titreLecon) {
                        leconInfo = {
                            titre: titreLecon,
                            matiere: String(row.c[4]?.v || '').trim()
                        };
                        break;
                    }
                }

                // 3. Charger les questions
                await loadQuestions();

                // 4. Afficher l'√©valuation
                renderEvaluation();

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }
        }

        // ===== LOAD QUESTIONS =====
        async function loadQuestions() {
            const params = getUrlParams();
            sections = [];

            // Charger Q_CHRONOLOGIE si nbChrono > 0
            if (evalConfig.nbChrono > 0) {
                const chronoJson = await fetchSheet(SHEET_CHRONO);
                const chronoGroups = {};

                for (let row of chronoJson.table.rows) {
                    if (!row.c) continue;
                    
                    const id = String(row.c[0]?.v || '').trim();
                    const lecon = String(row.c[1]?.v || '').trim();
                    const titre = String(row.c[2]?.v || '').trim();
                    const mode = String(row.c[3]?.v || 'evenements').trim().toLowerCase();
                    const date = String(row.c[4]?.v || '').trim();
                    const evenement = String(row.c[5]?.v || '').trim();
                    const statut = String(row.c[6]?.v || '').trim().toLowerCase();

                    // Skip header
                    if (id.toLowerCase().includes('identifiant')) continue;
                    if (!statut.includes('dispo')) continue;

                    // Grouper par ID
                    if (!chronoGroups[id]) {
                        chronoGroups[id] = {
                            id: id,
                            titre: titre,
                            mode: mode,
                            elements: []
                        };
                    }
                    
                    chronoGroups[id].elements.push({ date, evenement });
                }

                // Convertir en array et trier les √©l√©ments par date
                const chronoList = Object.values(chronoGroups);
                chronoList.forEach(group => {
                    group.elements.sort((a, b) => parseInt(a.date) - parseInt(b.date));
                });

                // M√©langer et prendre le nombre demand√©
                const shuffled = evalConfig.melanger ? shuffleArray(chronoList) : chronoList;
                const selected = shuffled.slice(0, evalConfig.nbChrono);

                selected.forEach((chrono, idx) => {
                    sections.push({
                        type: 'chronologie',
                        id: chrono.id,
                        title: chrono.titre || `Chronologie ${idx + 1}`,
                        mode: chrono.mode,
                        elements: chrono.elements,
                        icon: '‚è±Ô∏è',
                        iconClass: 'chrono'
                    });
                });
            }

            // TODO: Ajouter les autres types de questions (Q_DATES, Q_PERSONNAGES, etc.)
        }

        // ===== SHUFFLE ARRAY =====
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ===== RENDER EVALUATION =====
        function renderEvaluation() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'block';

            // Header
            const titre = leconInfo?.titre || evalConfig.numLecon;
            document.getElementById('evalTitle').textContent = titre;
            document.getElementById('breadcrumbCurrent').textContent = `Exercice ${evalConfig.numExercice}`;
            
            document.getElementById('evalMeta').innerHTML = `
                <span class="meta-item">‚è±Ô∏è ${evalConfig.duree} min</span>
                <span class="meta-item">üìù ${getTotalQuestions()} questions</span>
                <span class="meta-item">üéØ Seuil : ${evalConfig.seuil}%</span>
            `;

            // Progress steps
            renderProgressSteps();

            // Sections
            renderSections();

            // Timer
            startTimer(evalConfig.duree * 60);

            // Afficher premi√®re section
            showSection(0);
        }

        // ===== GET TOTAL QUESTIONS =====
        function getTotalQuestions() {
            let total = 0;
            sections.forEach(s => {
                if (s.type === 'chronologie') {
                    total += s.elements.length;
                }
            });
            return total;
        }

        // ===== RENDER PROGRESS STEPS =====
        function renderProgressSteps() {
            const container = document.getElementById('progressSteps');
            container.innerHTML = sections.map((s, idx) => `
                <div class="progress-step ${idx === 0 ? 'active' : ''}" data-section="${idx}" onclick="goToSection(${idx})">
                    ${s.icon} ${s.type === 'chronologie' ? 'Chrono' : s.type}
                </div>
            `).join('');

            updateProgressCount();
        }

        // ===== RENDER SECTIONS =====
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';

            sections.forEach((section, idx) => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'section';
                sectionEl.id = `section-${idx}`;

                if (section.type === 'chronologie') {
                    sectionEl.innerHTML = renderChronoSection(section, idx);
                }

                container.appendChild(sectionEl);
            });
        }

        // ===== RENDER CHRONO SECTION =====
        function renderChronoSection(section, sectionIdx) {
            const isModeDates = section.mode === 'dates';
            const hint = isModeDates 
                ? '<strong>Astuce :</strong> Tape l\'ann√©e correspondant √† chaque √©v√©nement (ex: 1492).'
                : '<strong>Astuce :</strong> Pas besoin d\'√©crire la phrase exacte. L\'important c\'est d\'identifier l\'√©v√©nement principal.';

            let pointsHtml = section.elements.map((el, elIdx) => {
                const inputId = `answer-${sectionIdx}-${elIdx}`;
                
                if (isModeDates) {
                    // Mode dates : √©v√©nements fixes, dates √† taper
                    return `
                        <div class="frise-point">
                            <input type="text" class="date-input" id="${inputId}" 
                                   placeholder="????" maxlength="4" 
                                   data-correct="${el.date}" 
                                   oninput="saveAnswer('${inputId}', this.value)">
                            <div class="frise-dot"></div>
                            <div class="frise-event-fixed">${el.evenement}</div>
                        </div>
                    `;
                } else {
                    // Mode √©v√©nements : dates fixes, √©v√©nements √† taper
                    return `
                        <div class="frise-point">
                            <div class="frise-date">${el.date}</div>
                            <div class="frise-dot"></div>
                            <textarea class="event-input" id="${inputId}" 
                                      placeholder="Quel √©v√©nement ?" 
                                      data-correct="${el.evenement}"
                                      oninput="saveAnswer('${inputId}', this.value)"></textarea>
                        </div>
                    `;
                }
            }).join('');

            return `
                <div class="section-header">
                    <div class="section-icon ${section.iconClass}">${section.icon}</div>
                    <div class="section-info">
                        <h2>${section.title}</h2>
                        <p>${isModeDates ? 'Retrouve la date de chaque √©v√©nement' : 'Retrouve l\'√©v√©nement correspondant √† chaque date'}</p>
                    </div>
                </div>
                <div class="hint-box">
                    <span class="icon">üí°</span>
                    <div class="text">${hint}</div>
                </div>
                <div class="frise-container">
                    <div class="frise-line"></div>
                    <div class="frise-points">
                        ${pointsHtml}
                    </div>
                </div>
            `;
        }

        // ===== SAVE ANSWER =====
        function saveAnswer(id, value) {
            answers[id] = value;
            updateProgressCount();
        }

        // ===== UPDATE PROGRESS COUNT =====
        function updateProgressCount() {
            const total = getTotalQuestions();
            const answered = Object.values(answers).filter(v => v && v.trim()).length;
            document.getElementById('progressCount').textContent = `${answered} / ${total} questions`;
            document.getElementById('progressFill').style.width = `${(answered / total) * 100}%`;
        }

        // ===== SHOW SECTION =====
        function showSection(idx) {
            // Masquer toutes les sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.progress-step').forEach(s => s.classList.remove('active'));

            // Afficher la section demand√©e
            const section = document.getElementById(`section-${idx}`);
            if (section) {
                section.classList.add('active');
            }

            // Mettre √† jour les steps
            document.querySelectorAll('.progress-step').forEach((step, i) => {
                if (i < idx) step.classList.add('completed');
                if (i === idx) step.classList.add('active');
            });

            currentSection = idx;
            updateNavButtons();
        }

        // ===== GO TO SECTION =====
        function goToSection(idx) {
            if (!isSubmitted) {
                showSection(idx);
            }
        }

        // ===== NAV BUTTONS =====
        function updateNavButtons() {
            const prevBtn = document.getElementById('btnPrev');
            const nextBtn = document.getElementById('btnNext');
            const submitBtn = document.getElementById('btnSubmit');

            prevBtn.style.display = currentSection > 0 ? 'flex' : 'none';
            
            if (currentSection === sections.length - 1) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'flex';
            } else {
                nextBtn.style.display = 'flex';
                submitBtn.style.display = 'none';
            }
        }

        function prevSection() {
            if (currentSection > 0) {
                showSection(currentSection - 1);
            }
        }

        function nextSection() {
            if (currentSection < sections.length - 1) {
                showSection(currentSection + 1);
            }
        }

        // ===== TIMER =====
        function startTimer(seconds) {
            timeRemaining = seconds;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                const timer = document.getElementById('headerTimer');
                if (timeRemaining <= 60) {
                    timer.classList.add('danger');
                } else if (timeRemaining <= 180) {
                    timer.classList.add('warning');
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitEvaluation();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // ===== SUBMIT EVALUATION =====
        function submitEvaluation() {
            if (isSubmitted) return;
            isSubmitted = true;
            clearInterval(timerInterval);

            let totalCorrect = 0;
            let totalQuestions = 0;
            const details = [];

            // Corriger chaque section
            sections.forEach((section, sIdx) => {
                let sectionCorrect = 0;
                
                section.elements.forEach((el, elIdx) => {
                    totalQuestions++;
                    const inputId = `answer-${sIdx}-${elIdx}`;
                    const input = document.getElementById(inputId);
                    const userAnswer = (answers[inputId] || '').trim();
                    const correctAnswer = input.dataset.correct;

                    let isCorrect = false;
                    if (section.mode === 'dates') {
                        isCorrect = userAnswer === correctAnswer;
                    } else {
                        isCorrect = checkEventMatch(userAnswer, correctAnswer);
                    }

                    if (isCorrect) {
                        totalCorrect++;
                        sectionCorrect++;
                        input.classList.add('correct');
                    } else {
                        input.classList.add('incorrect');
                        // Afficher la correction
                        const correction = document.createElement('div');
                        correction.className = 'correction-text';
                        correction.textContent = `‚Üí ${correctAnswer}`;
                        input.parentElement.appendChild(correction);
                    }
                    input.disabled = true;
                });

                details.push({
                    type: section.type,
                    correct: sectionCorrect,
                    total: section.elements.length
                });
            });

            // Afficher les r√©sultats
            showResults(totalCorrect, totalQuestions, details);
        }

        // ===== CHECK EVENT MATCH =====
        function checkEventMatch(userAnswer, correctAnswer) {
            if (!userAnswer) return false;

            const normalize = (str) => str.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9\s]/g, "").trim();

            const normalizedUser = normalize(userAnswer);
            const normalizedCorrect = normalize(correctAnswer);

            if (normalizedUser === normalizedCorrect) return true;

            // V√©rifier les mots cl√©s
            const correctWords = normalizedCorrect.split(' ').filter(w => w.length > 3);
            const userWords = normalizedUser.split(' ').filter(w => w.length > 3);

            let matchedWords = 0;
            for (const word of correctWords) {
                if (userWords.some(uw => uw.includes(word) || word.includes(uw))) {
                    matchedWords++;
                }
            }

            return matchedWords >= Math.ceil(correctWords.length * 0.5);
        }

        // ===== SHOW RESULTS =====
        function showResults(correct, total, details) {
            const percentage = Math.round((correct / total) * 100);
            const passed = percentage >= evalConfig.seuil;

            document.getElementById('contentContainer').style.display = 'none';
            document.getElementById('resultsContainer').classList.add('visible');

            document.getElementById('resultsIcon').textContent = passed ? 'üéâ' : 'üòï';
            document.getElementById('resultsScore').textContent = `${correct}/${total}`;
            
            const percEl = document.getElementById('resultsPercentage');
            percEl.textContent = `${percentage}%`;
            percEl.className = 'results-percentage ' + (passed ? 'success' : percentage >= 50 ? 'warning' : 'fail');

            document.getElementById('resultsMessage').textContent = passed 
                ? 'Bravo ! Tu as valid√© cette √©valuation !' 
                : `Il te faut ${evalConfig.seuil}% pour valider. Courage !`;

            document.getElementById('resultsDetails').innerHTML = details.map(d => `
                <div class="detail-item">
                    <div class="detail-label">${d.type}</div>
                    <div class="detail-value">${d.correct}/${d.total}</div>
                </div>
            `).join('');
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar();
            loadConfig();
        });
    </script>
</body>
</html>
