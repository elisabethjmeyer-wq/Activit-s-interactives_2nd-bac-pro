<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin CONN - √âvaluations de connaissances</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --primary: #7c3aed;
            --primary-light: #ede9fe;
            --primary-glow: rgba(124, 58, 237, 0.15);
            --success: #16a34a;
            --success-bg: rgba(22, 163, 74, 0.1);
            --warning: #d97706;
            --warning-bg: rgba(217, 119, 6, 0.1);
            --danger: #dc2626;
            --danger-bg: rgba(220, 38, 38, 0.1);
            --info: #2563eb;
            --info-bg: rgba(37, 99, 235, 0.1);
            --green: #10b981;
            --green-bg: rgba(16, 185, 129, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-light); color: var(--text); min-height: 100vh; line-height: 1.6; }
        .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        .sidebar { background: var(--bg-card); border-right: 1px solid var(--border); padding: 24px 16px; position: sticky; top: 0; height: 100vh; overflow-y: auto; box-shadow: var(--shadow); }
        .logo { display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 32px; }
        .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--primary), #a78bfa); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px var(--primary-glow); }
        .logo-text { font-weight: 700; font-size: 16px; color: var(--text); }
        .logo-text span { display: block; font-size: 11px; font-weight: 400; color: var(--text-muted); }
        .nav-section { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); padding: 20px 16px 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 500; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .nav-item .icon { font-size: 18px; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; color: var(--text-muted); }
        .nav-item.active .badge { background: rgba(255,255,255,0.25); color: white; }
        .main { padding: 32px; max-width: 1400px; }
        .header { margin-bottom: 32px; }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; color: var(--text); }
        .header p { color: var(--text-muted); font-size: 15px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 24px; overflow: hidden; box-shadow: var(--shadow); }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--bg-light); }
        .card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .card-body { padding: 24px; }
        .card-body.np { padding: 0; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border: none; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 8px var(--primary-glow); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px var(--primary-glow); }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: inline-flex; justify-content: center; align-items: center; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .btn-icon:hover { background: var(--bg-hover); color: var(--text); }
        .btn-icon.danger:hover { background: var(--danger-bg); border-color: var(--danger); color: var(--danger); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 14px; font-family: inherit; transition: all 0.2s; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
        .form-input::placeholder, .form-textarea::placeholder { color: var(--text-muted); }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .form-row-3 { grid-template-columns: repeat(3, 1fr); }
        .form-row-4 { grid-template-columns: repeat(4, 1fr); }
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .type-selector { display: flex; gap: 12px; margin-bottom: 20px; }
        .type-option { flex: 1; padding: 20px; background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.2s; }
        .type-option:hover { border-color: var(--primary); }
        .type-option.selected { border-color: var(--primary); background: var(--primary-light); }
        .type-option.selected.green { border-color: var(--green); background: var(--green-bg); }
        .type-option .icon { font-size: 32px; margin-bottom: 8px; }
        .type-option h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .type-option p { font-size: 12px; color: var(--text-muted); }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-event { background: var(--success-bg); color: var(--success); }
        .badge-qr { background: var(--info-bg); color: var(--info); }
        .badge-zone { background: rgba(219, 39, 119, 0.1); color: #db2777; }
        .badge-dictee { background: rgba(147, 51, 234, 0.1); color: #9333ea; }
        .badge-erreur { background: var(--warning-bg); color: var(--warning); }
        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-warning { background: var(--warning-bg); color: var(--warning); }
        .badge-green { background: var(--green-bg); color: var(--green); }
        .badge-primary { background: var(--primary-light); color: var(--primary); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); background: var(--bg-light); }
        tr:hover { background: var(--bg-hover); }
        .list-item { display: flex; align-items: center; gap: 16px; padding: 16px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s; cursor: pointer; }
        .list-item:hover { background: var(--bg-hover); }
        .list-item:last-child { border-bottom: none; }
        .list-item.active { background: var(--primary-light); border-left: 3px solid var(--primary); }
        .list-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: var(--bg-light); border: 1px solid var(--border); }
        .list-info { flex: 1; }
        .list-info h4 { font-size: 15px; font-weight: 600; margin-bottom: 2px; color: var(--text); }
        .list-info p { font-size: 13px; color: var(--text-muted); }
        .element-row { display: flex; align-items: center; gap: 12px; padding: 14px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .element-row:hover { background: var(--bg-hover); }
        .element-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .element-icon.event { background: var(--success-bg); }
        .element-icon.qr { background: var(--info-bg); }
        .element-icon.zone { background: rgba(219, 39, 119, 0.1); }
        .element-icon.dictee { background: rgba(147, 51, 234, 0.1); }
        .element-icon.erreur { background: var(--warning-bg); }
        .element-content { flex: 1; }
        .element-date { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--primary); min-width: 50px; }
        .element-text { font-size: 14px; color: var(--text); }
        .element-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .filter-btn { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover, .filter-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .format-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .format-option { padding: 20px 16px; background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.2s; }
        .format-option:hover { border-color: var(--primary); background: var(--primary-light); }
        .format-option.selected { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 3px var(--primary-glow); }
        .format-option .icon { font-size: 28px; margin-bottom: 8px; }
        .format-option h4 { font-size: 13px; font-weight: 600; color: var(--text); }
        .exercise-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .exercise-card { padding: 16px; background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.2s; }
        .exercise-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .exercise-card.selected { border-color: var(--primary); background: var(--primary-light); }
        .exercise-card .icon { font-size: 24px; margin-bottom: 8px; }
        .exercise-card h4 { font-size: 12px; font-weight: 600; color: var(--text); }
        .exercise-card p { font-size: 11px; color: var(--text-muted); }
        .config-panel { background: var(--bg-light); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-top: 20px; }
        .config-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase; }
        .bank-checks { max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px; background: var(--bg-card); }
        .bank-check { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s; }
        .bank-check:hover { background: var(--bg-hover); }
        .bank-check input { width: 18px; height: 18px; accent-color: var(--primary); }
        .bank-check label { flex: 1; font-size: 14px; cursor: pointer; color: var(--text); }
        .bank-check .count { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: translateY(20px) scale(0.95); transition: transform 0.3s; box-shadow: 0 25px 50px rgba(0,0,0,0.15); }
        .modal.lg { max-width: 900px; }
        .modal-overlay.visible .modal { transform: translateY(0) scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--bg-light); }
        .modal-header h2 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-card); border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; font-size: 18px; transition: all 0.2s; border: 1px solid var(--border); }
        .modal-close:hover { background: var(--bg-hover); color: var(--text); }
        .modal-body { padding: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 16px 24px; border-top: 1px solid var(--border); background: var(--bg-light); }
        .two-cols { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-muted); }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 60px 40px; color: var(--text-muted); }
        .empty .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .tag-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag-opt { padding: 8px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--text-muted); }
        .tag-opt:hover, .tag-opt.selected { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: var(--bg-card); border: 1px solid var(--success); border-radius: var(--radius); color: var(--success); font-weight: 600; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; box-shadow: var(--shadow-md); }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.error { border-color: var(--danger); color: var(--danger); }
        .exercise-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-light); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .exercise-item .order { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .exercise-item .info { flex: 1; }
        .exercise-item .info h4 { font-size: 14px; font-weight: 600; color: var(--text); }
        .exercise-item .info p { font-size: 12px; color: var(--text-muted); }
        .exercise-item .actions { display: flex; gap: 8px; }
        .steps { display: flex; gap: 8px; margin-bottom: 24px; }
        .step { flex: 1; padding: 12px; background: var(--bg-card); border: 2px solid var(--border); border-radius: var(--radius-sm); text-align: center; font-size: 12px; font-weight: 600; color: var(--text-muted); }
        .step.active { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        .step.done { border-color: var(--success); color: var(--success); background: var(--success-bg); }
        .link-box { background: var(--bg-light); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; margin-top: 16px; }
        .link-box h4 { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; }
        .link-box select { margin-bottom: 8px; }
        @media (max-width: 1024px) { .format-grid { grid-template-columns: repeat(3, 1fr); } .exercise-grid { grid-template-columns: repeat(2, 1fr); } .form-row, .form-row-3, .form-row-4 { grid-template-columns: 1fr; } .two-cols { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } .format-grid, .exercise-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-light);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:40px;text-align:center;max-width:400px;width:90%;box-shadow:0 25px 50px rgba(0,0,0,0.1);">
            <div style="width:64px;height:64px;background:linear-gradient(135deg,var(--primary),#a78bfa);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 24px;box-shadow:0 4px 12px var(--primary-glow);">üîê</div>
            <h1 style="font-size:24px;margin-bottom:8px;color:var(--text);">Admin CONN</h1>
            <p style="color:var(--text-muted);margin-bottom:32px;">Espace r√©serv√© √† l'enseignant</p>
            <input type="password" id="loginPassword" class="form-input" placeholder="Mot de passe" style="margin-bottom:16px;text-align:center;" onkeypress="if(event.key==='Enter')checkPassword()">
            <button class="btn btn-primary" style="width:100%;" onclick="checkPassword()">Connexion</button>
            <p id="loginError" style="color:var(--danger);margin-top:16px;display:none;">Mot de passe incorrect</p>
        </div>
    </div>

    <div class="layout" style="display:none;" id="mainApp">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üìù</div>
                <div class="logo-text">Admin CONN<span>Entra√Ænements & √âvaluations</span></div>
            </div>
            <nav>
                <div class="nav-section">Banques</div>
                <div class="nav-item active" onclick="showPage('banks')"><span class="icon">üóÉÔ∏è</span>Mes banques<span class="badge" id="navBankCount">0</span></div>
                <div class="nav-item" onclick="showPage('new-element')"><span class="icon">‚ûï</span>Nouvel √©l√©ment</div>
                <div class="nav-section">Entra√Ænements</div>
                <div class="nav-item" onclick="showPage('entrainements')"><span class="icon">üèãÔ∏è</span>Mes entra√Ænements<span class="badge" id="navEntrainCount">0</span></div>
                <div class="nav-item" onclick="startNewEval('Entrainement')"><span class="icon">‚ûï</span>Nouvel entra√Ænement</div>
                <div class="nav-section">√âvaluations</div>
                <div class="nav-item" onclick="showPage('evaluations')"><span class="icon">üìã</span>Mes √©valuations<span class="badge" id="navEvalCount">0</span></div>
                <div class="nav-item" onclick="startNewEval('Evaluation')"><span class="icon">‚ûï</span>Nouvelle √©valuation</div>
                <div class="nav-section">Menu √©l√®ve</div>
                <div class="nav-item" onclick="showPage('menu-conn')"><span class="icon">üìö</span>MENU_CONN<span class="badge" id="navMenuCount">0</span></div>
                <div class="nav-section">Syst√®me</div>
                <div class="nav-item" onclick="loadAllData()"><span class="icon">üîÑ</span>Rafra√Æchir</div>
                <div class="nav-item" onclick="openModal('modalHelp')"><span class="icon">‚ùì</span>Aide</div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- PAGE: Banques -->
            <div id="page-banks">
                <div class="header"><h1>üóÉÔ∏è Mes banques de questions</h1><p>5 formats de donn√©es pour cr√©er vos exercices</p></div>
                <div class="two-cols">
                    <div class="card">
                        <div class="card-header"><span class="card-title">üìÇ Banques</span><button class="btn btn-sm btn-primary" onclick="openModal('modalNewBank')">‚ûï</button></div>
                        <div class="card-body np" id="banksList"><div class="loading"><div class="spinner"></div> Chargement...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title" id="elementsTitle">S√©lectionnez une banque</span><button class="btn btn-sm btn-primary" onclick="showPage('new-element')" style="display:none" id="btnAddElement">‚ûï</button></div>
                        <div class="card-body np">
                            <div class="filters" id="elementsFilters" style="display:none;padding:16px 24px 0;"></div>
                            <div id="elementsList"><div class="empty"><div class="icon">üëà</div><p>S√©lectionnez une banque √† gauche</p></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: Nouvel √©l√©ment -->
            <div id="page-new-element" style="display:none">
                <div class="header"><h1>‚ûï Nouvel √©l√©ment</h1><p>Choisissez un format et remplissez les champs</p></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">1Ô∏è‚É£ Format de donn√©es</span></div>
                    <div class="card-body">
                        <div class="format-grid">
                            <div class="format-option selected" onclick="selectFormat(this,'Evenement')"><div class="icon">üìÖ</div><h4>√âv√©nement</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'QuestionReponse')"><div class="icon">‚ùì</div><h4>Question-R√©ponse</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'Zone')"><div class="icon">üó∫Ô∏è</div><h4>Zone image</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'Dictee')"><div class="icon">üéß</div><h4>Dict√©e</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'Erreur')"><div class="icon">üîç</div><h4>Erreur</h4></div>
                        </div>
                    </div>
                </div>
                <div class="card" id="formEvenement">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - √âv√©nement</span></div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Date</label><input type="text" class="form-input" id="eventDate" placeholder="Ex: 1492"></div>
                            <div class="form-group"><label class="form-label">√âv√©nement</label><input type="text" class="form-input" id="eventText" placeholder="Ex: Christophe Colomb arrive aux Antilles"></div>
                        </div>
                    </div>
                </div>
                <div class="card" id="formQuestionReponse" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Question-R√©ponse</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Question</label><textarea class="form-textarea" id="qrQuestion" placeholder="Ex: Qui a franchi le Cap de Bonne-Esp√©rance en 1488 ?"></textarea></div>
                        <div class="form-group"><label class="form-label">R√©ponse</label><input type="text" class="form-input" id="qrReponse" placeholder="Ex: Bartolomeu Dias"></div>
                        <div class="form-group"><label class="form-label">Tag</label><div class="tag-selector"><span class="tag-opt selected" onclick="selectTag(this)">Personnage</span><span class="tag-opt" onclick="selectTag(this)">Vocabulaire</span><span class="tag-opt" onclick="selectTag(this)">Lieu</span><span class="tag-opt" onclick="selectTag(this)">Date</span><span class="tag-opt" onclick="selectTag(this)">Autre</span></div></div>
                    </div>
                </div>
                <div class="card" id="formDictee" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Dict√©e</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Texte √† dicter</label><textarea class="form-textarea" id="dicteeTexte" placeholder="Ex: La caravelle est un bateau l√©ger utilis√© par les Portugais."></textarea></div>
                        <div class="form-group"><button class="btn btn-secondary" onclick="playDictee()">üîä √âcouter</button></div>
                    </div>
                </div>
                <div class="card" id="formErreur" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Trouve l'erreur</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Phrase avec erreur</label><input type="text" class="form-input" id="erreurPhrase" placeholder="Ex: Christophe Colomb arrive aux Antilles en 1498."></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Mot erron√©</label><input type="text" class="form-input" id="erreurMot" placeholder="Ex: 1498"></div><div class="form-group"><label class="form-label">Correction</label><input type="text" class="form-input" id="erreurCorrection" placeholder="Ex: 1492"></div></div>
                    </div>
                </div>
                <div class="card" id="formZone" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Zone image</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">URL de l'image</label><input type="text" class="form-input" id="zoneImage" placeholder="Ex: https://example.com/carte.jpg"></div>
                        <div class="form-group"><label class="form-label">Consigne</label><input type="text" class="form-input" id="zoneConsigne" placeholder="Ex: Localise le Cap de Bonne-Esp√©rance"></div>
                        <div class="form-row form-row-3"><div class="form-group"><label class="form-label">Position X (%)</label><input type="number" class="form-input" id="zoneX" placeholder="45"></div><div class="form-group"><label class="form-label">Position Y (%)</label><input type="number" class="form-input" id="zoneY" placeholder="78"></div><div class="form-group"><label class="form-label">Rayon</label><input type="number" class="form-input" id="zoneRayon" value="30"></div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">3Ô∏è‚É£ Banque de destination</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Ranger dans</label><select class="form-select" id="elementBanque"></select></div>
                        <div style="display:flex;gap:12px;justify-content:flex-end;"><button class="btn btn-secondary" onclick="showPage('banks')">Annuler</button><button class="btn btn-primary" onclick="saveElement()">üíæ Enregistrer</button></div>
                    </div>
                </div>
            </div>

            <!-- PAGE: Entra√Ænements -->
            <div id="page-entrainements" style="display:none">
                <div class="header"><h1>üèãÔ∏è Mes entra√Ænements</h1><p>Exercices d'entra√Ænement pour les √©l√®ves (illimit√©s, sans note)</p></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Liste des entra√Ænements</span><button class="btn btn-green" onclick="startNewEval('Entrainement')">‚ûï Nouvel entra√Ænement</button></div>
                    <div class="card-body np">
                        <table><thead><tr><th>Entra√Ænement</th><th>Le√ßon</th><th>Exercices</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="entrainementsList"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: √âvaluations -->
            <div id="page-evaluations" style="display:none">
                <div class="header"><h1>üìã Mes √©valuations</h1><p>√âvaluations not√©es avec chrono et seuil de r√©ussite</p></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Liste des √©valuations</span><button class="btn btn-primary" onclick="startNewEval('Evaluation')">‚ûï Nouvelle √©valuation</button></div>
                    <div class="card-body np">
                        <table><thead><tr><th>√âvaluation</th><th>Le√ßon</th><th>Exercices</th><th>Dur√©e</th><th>Seuil</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="evalsList"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: Menu CONN -->
            <div id="page-menu-conn" style="display:none">
                <div class="header"><h1>üìö Menu √©l√®ve (MENU_CONN)</h1><p>Structure du menu "Connaissances" c√¥t√© √©l√®ve</p></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Le√ßons et exercices</span><button class="btn btn-sm btn-primary" onclick="openModal('modalNewMenuEntry')">‚ûï Ajouter</button></div>
                    <div class="card-body np">
                        <table><thead><tr><th>Le√ßon</th><th>N¬∞</th><th>Titre</th><th>Type</th><th>Li√© √†</th><th>Statut</th></tr></thead><tbody id="menuConnList"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: Nouvelle √©val/entra√Ænement - √âtape 1 -->
            <div id="page-new-eval" style="display:none">
                <div class="header"><h1 id="newEvalTitle">‚ûï Nouvel entra√Ænement</h1><p>√âtape 1 : Param√®tres g√©n√©raux</p></div>
                <div class="steps"><div class="step active">1. Param√®tres</div><div class="step">2. Exercices</div><div class="step">3. Liaison menu</div></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">‚öôÔ∏è Param√®tres g√©n√©raux</span></div>
                    <div class="card-body">
                        <div class="form-row"><div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="evalNom" placeholder="Ex: Frise chronologique L4"></div><div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="evalDesc" placeholder="Ex: Retrouve les √©v√©nements"></div></div>
                        <div class="form-row form-row-4" id="evalParamsRow">
                            <div class="form-group"><label class="form-label">Dur√©e (min)</label><input type="number" class="form-input" id="evalDuree" value="15"></div>
                            <div class="form-group"><label class="form-label">Seuil (%)</label><input type="number" class="form-input" id="evalSeuil" value="80"></div>
                            <div class="form-group"><label class="form-label">Tentatives</label><select class="form-select" id="evalTentatives"><option value="0">Illimit√©es</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
                            <div class="form-group"><label class="form-label">Affichage</label><select class="form-select" id="evalAffichage"><option value="all">Tout d'un coup</option><option value="1">1 par page</option></select></div>
                        </div>
                        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;"><button class="btn btn-secondary" onclick="cancelEval()">Annuler</button><button class="btn btn-primary" onclick="goToStep2()">Suivant ‚Üí</button></div>
                    </div>
                </div>
            </div>

            <!-- PAGE: √âditer √©val - √âtape 2 -->
            <div id="page-edit-eval" style="display:none">
                <div class="header"><h1>‚úèÔ∏è <span id="editEvalTitle">√âvaluation</span></h1><p>Ajoutez les exercices</p></div>
                <div class="steps"><div class="step done">1. Param√®tres ‚úì</div><div class="step active">2. Exercices</div><div class="step">3. Liaison menu</div></div>
                <div class="two-cols">
                    <div class="card">
                        <div class="card-header"><span class="card-title">üìù Exercices ajout√©s</span><span class="badge badge-warning" id="exerciseCount">0</span></div>
                        <div class="card-body np" id="evalExercisesList" style="padding:16px;"></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">‚ûï Ajouter un exercice</span></div>
                        <div class="card-body">
                            <div class="form-group"><label class="form-label">Type d'exercice</label>
                                <div class="exercise-grid">
                                    <div class="exercise-card selected" onclick="selectExerciseType(this,'frise')"><div class="icon">‚è±Ô∏è</div><h4>Frise chrono</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'timeline')"><div class="icon">üîÄ</div><h4>Timeline</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'qcm')"><div class="icon">üéØ</div><h4>QCM</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'ouverte')"><div class="icon">‚ùì</div><h4>Question ouverte</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'carte')"><div class="icon">üó∫Ô∏è</div><h4>Carte cliquable</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'image')"><div class="icon">üñºÔ∏è</div><h4>Identification</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'dictee')"><div class="icon">üéß</div><h4>Dict√©e</h4></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'erreur')"><div class="icon">üîç</div><h4>Trouve l'erreur</h4></div>
                                </div>
                            </div>
                            <div class="config-panel">
                                <div class="config-title">Configuration</div>
                                <div class="form-row"><div class="form-group"><label class="form-label">Nombre de questions</label><input type="number" class="form-input" id="exoNombre" value="5" min="1" max="20"></div><div class="form-group"><label class="form-label">S√©lection</label><select class="form-select" id="exoSelection"><option value="random">Al√©atoire</option><option value="all">Toutes</option></select></div></div>
                                <div class="form-group"><label class="form-label">Banques sources</label><div class="bank-checks" id="exoBanques"></div></div>
                                <div style="display:flex;justify-content:flex-end;margin-top:16px;"><button class="btn btn-primary" onclick="addExerciseToEval()">‚ûï Ajouter</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-body" style="display:flex;justify-content:space-between;"><button class="btn btn-secondary" onclick="backToStep1()">‚Üê Retour</button><button class="btn btn-primary" onclick="goToStep3()">Suivant : Liaison menu ‚Üí</button></div></div>
            </div>

            <!-- PAGE: Liaison menu - √âtape 3 -->
            <div id="page-link-menu" style="display:none">
                <div class="header"><h1>üîó Liaison au menu √©l√®ve</h1><p>Associez cet entra√Ænement/√©valuation √† une entr√©e du menu</p></div>
                <div class="steps"><div class="step done">1. Param√®tres ‚úì</div><div class="step done">2. Exercices ‚úì</div><div class="step active">3. Liaison menu</div></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">üìö Choisir l'emplacement dans le menu √©l√®ve</span></div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Le√ßon</label>
                                <select class="form-select" id="linkLecon" onchange="updateLinkExoOptions()"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Exercice (emplacement)</label>
                                <select class="form-select" id="linkExo"></select>
                            </div>
                        </div>
                        <p class="form-hint">üí° L'entra√Ænement/√©valuation appara√Ætra √† cet emplacement dans le menu "Connaissances" des √©l√®ves.</p>
                        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                            <button class="btn btn-secondary" onclick="goBackToStep2()">‚Üê Retour</button>
                            <button class="btn btn-secondary" onclick="saveEvalAsDraft()">üíæ Brouillon</button>
                            <button class="btn btn-success" onclick="publishEval()">‚úì Publier</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalNewBank">
        <div class="modal">
            <div class="modal-header"><h2>‚ûï Nouvelle banque</h2><button class="modal-close" onclick="closeModal('modalNewBank')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="newBankNom" placeholder="Ex: L4 - Grandes explorations"></div>
                <div class="form-group"><label class="form-label">Cat√©gorie</label><select class="form-select" id="newBankCat"><option>Histoire</option><option>G√©ographie</option><option>EMC</option><option>R√©vision</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalNewBank')">Annuler</button><button class="btn btn-primary" onclick="saveBank()">‚úì Cr√©er</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalNewMenuEntry">
        <div class="modal">
            <div class="modal-header"><h2>‚ûï Nouvelle entr√©e menu</h2><button class="modal-close" onclick="closeModal('modalNewMenuEntry')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">N¬∞ Le√ßon</label><input type="text" class="form-input" id="newMenuLecon" placeholder="Ex: L4"></div>
                    <div class="form-group"><label class="form-label">N¬∞ Exercice</label><input type="number" class="form-input" id="newMenuExo" placeholder="0 = ligne titre"></div>
                </div>
                <div class="form-group"><label class="form-label">Titre Le√ßon (si N¬∞Exo = 0)</label><input type="text" class="form-input" id="newMenuTitreLecon" placeholder="Ex: La mise en relation du monde"></div>
                <div class="form-group"><label class="form-label">Titre Exercice (si N¬∞Exo > 0)</label><input type="text" class="form-input" id="newMenuTitreExo" placeholder="Ex: Exercice 1"></div>
                <div class="form-group"><label class="form-label">Mati√®re</label><select class="form-select" id="newMenuMatiere"><option>Histoire</option><option>G√©ographie</option><option>EMC</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalNewMenuEntry')">Annuler</button><button class="btn btn-primary" onclick="saveMenuEntry()">‚úì Ajouter</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfirmDelete">
        <div class="modal">
            <div class="modal-header"><h2>üóëÔ∏è Confirmer</h2><button class="modal-close" onclick="closeModal('modalConfirmDelete')">‚úï</button></div>
            <div class="modal-body"><p id="deleteConfirmText">Supprimer ?</p></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalConfirmDelete')">Annuler</button><button class="btn btn-primary" style="background:var(--danger);" onclick="confirmDelete()">üóëÔ∏è Supprimer</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalHelp">
        <div class="modal lg">
            <div class="modal-header"><h2>‚ùì Aide</h2><button class="modal-close" onclick="closeModal('modalHelp')">‚úï</button></div>
            <div class="modal-body">
                <h3 style="margin-bottom:16px;">üèãÔ∏è Entra√Ænement vs üìã √âvaluation</h3>
                <table style="margin-bottom:24px;"><thead><tr><th></th><th>Entra√Ænement</th><th>√âvaluation</th></tr></thead><tbody>
                    <tr><td><strong>But</strong></td><td>S'exercer librement</td><td>√ätre not√©</td></tr>
                    <tr><td><strong>Chrono</strong></td><td>Non</td><td>Oui</td></tr>
                    <tr><td><strong>Tentatives</strong></td><td>Illimit√©es</td><td>Limit√©es</td></tr>
                    <tr><td><strong>Score</strong></td><td>Affich√© mais non enregistr√©</td><td>Enregistr√©</td></tr>
                </tbody></table>
                <h3 style="margin-bottom:16px;">üì¶ 5 formats de donn√©es</h3>
                <table><thead><tr><th>Format</th><th>Exercices compatibles</th></tr></thead><tbody>
                    <tr><td><span class="badge badge-event">√âv√©nement</span></td><td>Frise, Timeline, QCM</td></tr>
                    <tr><td><span class="badge badge-qr">Question-R√©ponse</span></td><td>Question ouverte, QCM, Identification</td></tr>
                    <tr><td><span class="badge badge-zone">Zone</span></td><td>Carte cliquable</td></tr>
                    <tr><td><span class="badge badge-dictee">Dict√©e</span></td><td>Dict√©e</td></tr>
                    <tr><td><span class="badge badge-erreur">Erreur</span></td><td>Trouve l'erreur</td></tr>
                </tbody></table>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="closeModal('modalHelp')">Compris !</button></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>
eval' ? `Supprimer cette entr√©e ?` : 'Supprimer cet √©l√©ment ?';
            openModal('modalConfirmDelete');
        }

        async function confirmDelete() {
            if (!deleteTarget) return;
            closeModal('modalConfirmDelete');
            showToast('Suppression...');
            try {
                if (deleteTarget.type === 'element') {
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ sheet: 'ELEMENTS', action: 'delete', id: deleteTarget.id }) });
                    elements = elements.filter(e => e.ID !== deleteTarget.id);
                    renderElements();
                } else if (deleteTarget.type === 'eval') {
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ sheet: 'EVALUATIONS', action: 'delete', id: deleteTarget.id }) });
                    for (const ex of exercices.filter(ex => ex.EvalID === deleteTarget.id)) {
                        await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ sheet: 'EXERCICES', action: 'delete', id: ex.ID }) });
                    }
                    evaluations = evaluations.filter(e => e.ID !== deleteTarget.id);
                    exercices = exercices.filter(ex => ex.EvalID !== deleteTarget.id);
                    renderEntrainements(); renderEvaluations();
                    document.getElementById('navEntrainCount').textContent = evaluations.filter(e => e.Type === 'Entrainement').length;
                    document.getElementById('navEvalCount').textContent = evaluations.filter(e => e.Type === 'Evaluation').length;
                }
                showToast('‚úì Supprim√© !');
            } catch (e) { showToast('Erreur', true); }
            deleteTarget = null;
        }

        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
        document.querySelectorAll('.modal-overlay').forEach(o => { o.onclick = e => { if (e.target === o) o.classList.remove('visible'); }; });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast visible' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        loadAllData();
    </script>
</body>
</html>
