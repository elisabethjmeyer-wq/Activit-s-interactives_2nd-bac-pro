<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin CONN</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-light:#f8fafc;--bg-card:#fff;--bg-hover:#f1f5f9;--border:#e2e8f0;--text:#1e293b;--text-muted:#64748b;--primary:#7c3aed;--primary-light:#ede9fe;--primary-glow:rgba(124,58,237,.15);--success:#16a34a;--success-bg:rgba(22,163,74,.1);--warning:#d97706;--warning-bg:rgba(217,119,6,.1);--danger:#dc2626;--info:#2563eb;--info-bg:rgba(37,99,235,.1);--green:#10b981;--green-bg:rgba(16,185,129,.1);--radius:12px;--radius-sm:8px;--shadow:0 1px 3px rgba(0,0,0,.08)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg-light);color:var(--text);min-height:100vh}
        .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
        .sidebar{background:var(--bg-card);border-right:1px solid var(--border);padding:24px 16px;position:sticky;top:0;height:100vh;overflow-y:auto}
        .logo{display:flex;align-items:center;gap:12px;padding:12px 16px;margin-bottom:32px}
        .logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),#a78bfa);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .logo-text{font-weight:700;font-size:16px}.logo-text span{display:block;font-size:11px;font-weight:400;color:var(--text-muted)}
        .nav-section{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);padding:20px 16px 8px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius-sm);color:var(--text-muted);cursor:pointer;transition:all .2s;font-size:14px;font-weight:500}
        .nav-item:hover{background:var(--bg-hover);color:var(--text)}
        .nav-item.active{background:var(--primary);color:#fff}
        .nav-item .badge{margin-left:auto;background:var(--bg-hover);padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
        .nav-item.active .badge{background:rgba(255,255,255,.25)}
        .main{padding:32px;max-width:1400px}
        .header{margin-bottom:32px}.header h1{font-size:28px;font-weight:700;margin-bottom:8px}.header p{color:var(--text-muted)}
        .card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;overflow:hidden;box-shadow:var(--shadow)}
        .card-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);background:var(--bg-light)}
        .card-title{font-size:16px;font-weight:600;display:flex;align-items:center;gap:10px}
        .card-body{padding:24px}.card-body.np{padding:0}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
        .btn-primary{background:var(--primary);color:#fff}.btn-secondary{background:var(--bg-card);color:var(--text);border:1px solid var(--border)}
        .btn-success{background:var(--success);color:#fff}.btn-green{background:var(--green);color:#fff}.btn-sm{padding:8px 14px;font-size:13px}
        .btn-icon{width:36px;height:36px;padding:0;display:inline-flex;justify-content:center;align-items:center;border-radius:var(--radius-sm);background:var(--bg-card);border:1px solid var(--border);color:var(--text-muted);cursor:pointer}
        .btn-icon:hover{background:var(--bg-hover)}.btn-icon.danger:hover{background:rgba(220,38,38,.1);color:var(--danger)}
        .form-group{margin-bottom:20px}.form-label{display:block;font-size:13px;font-weight:600;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase}
        .form-input,.form-select,.form-textarea{width:100%;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px;font-family:inherit}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
        .form-textarea{min-height:100px;resize:vertical}.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        .form-row-3{grid-template-columns:repeat(3,1fr)}.form-row-4{grid-template-columns:repeat(4,1fr)}
        .format-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
        .format-option{padding:20px 16px;background:var(--bg-card);border:2px solid var(--border);border-radius:var(--radius);text-align:center;cursor:pointer;transition:all .2s}
        .format-option:hover{border-color:var(--primary)}.format-option.selected{border-color:var(--primary);background:var(--primary-light)}
        .format-option .icon{font-size:28px;margin-bottom:8px}.format-option h4{font-size:13px;font-weight:600}
        .exercise-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
        .exercise-card{padding:16px;background:var(--bg-card);border:2px solid var(--border);border-radius:var(--radius);text-align:center;cursor:pointer;transition:all .2s}
        .exercise-card:hover{border-color:var(--primary);transform:translateY(-2px)}.exercise-card.selected{border-color:var(--primary);background:var(--primary-light)}
        .exercise-card .icon{font-size:24px;margin-bottom:8px}.exercise-card h4{font-size:12px;font-weight:600}.exercise-card p{font-size:11px;color:var(--text-muted)}
        .badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
        .badge-event{background:var(--success-bg);color:var(--success)}.badge-qr{background:var(--info-bg);color:var(--info)}
        .badge-success{background:var(--success-bg);color:var(--success)}.badge-warning{background:var(--warning-bg);color:var(--warning)}
        .badge-green{background:var(--green-bg);color:var(--green)}.badge-primary{background:var(--primary-light);color:var(--primary)}
        table{width:100%;border-collapse:collapse}th,td{padding:14px 20px;text-align:left;border-bottom:1px solid var(--border)}
        th{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--text-muted);background:var(--bg-light)}tr:hover{background:var(--bg-hover)}
        .list-item{display:flex;align-items:center;gap:16px;padding:16px 24px;border-bottom:1px solid var(--border);cursor:pointer}
        .list-item:hover{background:var(--bg-hover)}.list-item.active{background:var(--primary-light);border-left:3px solid var(--primary)}
        .list-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--bg-light);border:1px solid var(--border)}
        .list-info{flex:1}.list-info h4{font-size:15px;font-weight:600;margin-bottom:2px}.list-info p{font-size:13px;color:var(--text-muted)}
        .element-row{display:flex;align-items:center;gap:12px;padding:14px 24px;border-bottom:1px solid var(--border)}.element-row:hover{background:var(--bg-hover)}
        .element-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
        .element-icon.event{background:var(--success-bg)}.element-icon.qr{background:var(--info-bg)}
        .element-content{flex:1}.element-date{font-weight:600;color:var(--primary);min-width:50px}.element-text{font-size:14px}.element-sub{font-size:12px;color:var(--text-muted);margin-top:2px}
        .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
        .filter-btn{padding:8px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;color:var(--text-muted);font-size:12px;font-weight:600;cursor:pointer}
        .filter-btn:hover,.filter-btn.active{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
        .config-panel{background:var(--bg-light);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-top:20px}
        .config-title{font-size:13px;font-weight:600;color:var(--text-muted);margin-bottom:16px;text-transform:uppercase}
        .bank-checks{max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px;background:var(--bg-card)}
        .bank-check{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--radius-sm);cursor:pointer}.bank-check:hover{background:var(--bg-hover)}
        .bank-check input{width:18px;height:18px;accent-color:var(--primary)}.bank-check label{flex:1;font-size:14px;cursor:pointer}.bank-check .count{font-size:12px;color:var(--text-muted)}
        .tag-selector{display:flex;gap:8px;flex-wrap:wrap}
        .tag-opt{padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;color:var(--text-muted)}
        .tag-opt:hover,.tag-opt.selected{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s}
        .modal-overlay.visible{opacity:1;visibility:visible}
        .modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);width:90%;max-width:600px;max-height:90vh;overflow-y:auto;transform:translateY(20px) scale(.95);transition:transform .3s}
        .modal.lg{max-width:900px}.modal-overlay.visible .modal{transform:translateY(0) scale(1)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border);background:var(--bg-light)}
        .modal-header h2{font-size:18px;font-weight:700}.modal-close{width:36px;height:36px;border:1px solid var(--border);background:var(--bg-card);border-radius:var(--radius-sm);cursor:pointer;font-size:18px}
        .modal-body{padding:24px}.modal-footer{display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid var(--border);background:var(--bg-light)}
        .two-cols{display:grid;grid-template-columns:320px 1fr;gap:24px}
        .loading{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--text-muted)}
        .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin-right:12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .empty{text-align:center;padding:60px 40px;color:var(--text-muted)}.empty .icon{font-size:48px;margin-bottom:16px;opacity:.5}
        .toast{position:fixed;bottom:24px;right:24px;padding:16px 24px;background:var(--bg-card);border:1px solid var(--success);border-radius:var(--radius);color:var(--success);font-weight:600;transform:translateY(100px);opacity:0;transition:all .3s;z-index:2000}
        .toast.visible{transform:translateY(0);opacity:1}.toast.error{border-color:var(--danger);color:var(--danger)}
        .exercise-item{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-light);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:12px}
        .exercise-item .order{width:32px;height:32px;background:var(--primary);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px}
        .exercise-item .info{flex:1}.exercise-item .info h4{font-size:14px;font-weight:600}.exercise-item .info p{font-size:12px;color:var(--text-muted)}
        .exercise-item .actions{display:flex;gap:8px}
        .steps{display:flex;gap:8px;margin-bottom:24px}
        .step{flex:1;padding:12px;background:var(--bg-card);border:2px solid var(--border);border-radius:var(--radius-sm);text-align:center;font-size:12px;font-weight:600;color:var(--text-muted)}
        .step.active{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
        .step.done{border-color:var(--success);color:var(--success);background:var(--success-bg)}
        @media(max-width:1024px){.format-grid{grid-template-columns:repeat(3,1fr)}.exercise-grid{grid-template-columns:repeat(2,1fr)}.form-row,.form-row-3,.form-row-4{grid-template-columns:1fr}.two-cols{grid-template-columns:1fr}}
        @media(max-width:768px){.layout{grid-template-columns:1fr}.sidebar{display:none}}
    </style>
</head>
<body>
    <div id="loginScreen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-light);display:flex;align-items:center;justify-content:center;z-index:9999">
        <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:40px;text-align:center;max-width:400px;width:90%">
            <div style="width:64px;height:64px;background:linear-gradient(135deg,var(--primary),#a78bfa);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 24px">üîê</div>
            <h1 style="font-size:24px;margin-bottom:8px">Admin CONN</h1>
            <p style="color:var(--text-muted);margin-bottom:32px">Espace r√©serv√© √† l'enseignant</p>
            <input type="password" id="loginPassword" class="form-input" placeholder="Mot de passe" style="margin-bottom:16px;text-align:center" onkeypress="if(event.key==='Enter')checkPassword()">
            <button class="btn btn-primary" style="width:100%" onclick="checkPassword()">Connexion</button>
            <p id="loginError" style="color:var(--danger);margin-top:16px;display:none">Mot de passe incorrect</p>
        </div>
    </div>
    <div class="layout" style="display:none" id="mainApp">
        <aside class="sidebar">
            <div class="logo"><div class="logo-icon">üìù</div><div class="logo-text">Admin CONN<span>Entra√Ænements & √âvaluations</span></div></div>
            <nav>
                <div class="nav-section">Banques</div>
                <div class="nav-item active" onclick="showPage('banks')"><span>üóÉÔ∏è</span>Mes banques<span class="badge" id="navBankCount">0</span></div>
                <div class="nav-item" onclick="showPage('new-element')"><span>‚ûï</span>Nouvel √©l√©ment</div>
                <div class="nav-section">Entra√Ænements</div>
                <div class="nav-item" onclick="showPage('entrainements')"><span>üèãÔ∏è</span>Entra√Ænements<span class="badge" id="navEntrainCount">0</span></div>
                <div class="nav-item" onclick="startNewEval('Entrainement')"><span>‚ûï</span>Nouvel entra√Ænement</div>
                <div class="nav-section">√âvaluations</div>
                <div class="nav-item" onclick="showPage('evaluations')"><span>üìã</span>√âvaluations<span class="badge" id="navEvalCount">0</span></div>
                <div class="nav-item" onclick="startNewEval('Evaluation')"><span>‚ûï</span>Nouvelle √©valuation</div>
                <div class="nav-section">Menu √©l√®ve</div>
                <div class="nav-item" onclick="showPage('menu-conn')"><span>üìö</span>MENU_CONN<span class="badge" id="navMenuCount">0</span></div>
                <div class="nav-section">Syst√®me</div>
                <div class="nav-item" onclick="loadAllData()"><span>üîÑ</span>Rafra√Æchir</div>
            </nav>
        </aside>
        <main class="main">
            <div id="page-banks">
                <div class="header"><h1>üóÉÔ∏è Mes banques de questions</h1><p>Cr√©ez des banques et ajoutez des √©l√©ments</p></div>
                <div class="two-cols">
                    <div class="card"><div class="card-header"><span class="card-title">üìÇ Banques</span><button class="btn btn-sm btn-primary" onclick="openModal('modalNewBank')">‚ûï</button></div><div class="card-body np" id="banksList"><div class="loading"><div class="spinner"></div>Chargement...</div></div></div>
                    <div class="card"><div class="card-header"><span class="card-title" id="elementsTitle">S√©lectionnez une banque</span><button class="btn btn-sm btn-primary" onclick="showPage('new-element')" style="display:none" id="btnAddElement">‚ûï</button></div><div class="card-body np"><div class="filters" id="elementsFilters" style="display:none;padding:16px 24px 0"></div><div id="elementsList"><div class="empty"><div class="icon">üëà</div><p>S√©lectionnez une banque</p></div></div></div></div>
                </div>
            </div>
            <div id="page-new-element" style="display:none">
                <div class="header"><h1>‚ûï Nouvel √©l√©ment</h1><p>Choisissez un format et remplissez les champs</p></div>
                <div class="card"><div class="card-header"><span class="card-title">1Ô∏è‚É£ Format</span></div><div class="card-body"><div class="format-grid"><div class="format-option selected" onclick="selectFormat(this,'Evenement')"><div class="icon">üìÖ</div><h4>√âv√©nement</h4></div><div class="format-option" onclick="selectFormat(this,'QuestionReponse')"><div class="icon">‚ùì</div><h4>Question-R√©ponse</h4></div><div class="format-option" onclick="selectFormat(this,'Zone')"><div class="icon">üó∫Ô∏è</div><h4>Zone image</h4></div><div class="format-option" onclick="selectFormat(this,'Dictee')"><div class="icon">üéß</div><h4>Dict√©e</h4></div><div class="format-option" onclick="selectFormat(this,'Erreur')"><div class="icon">üîç</div><h4>Erreur</h4></div></div></div></div>
                <div class="card" id="formEvenement"><div class="card-header"><span class="card-title">2Ô∏è‚É£ √âv√©nement</span></div><div class="card-body"><div class="form-row"><div class="form-group"><label class="form-label">Date</label><input type="text" class="form-input" id="eventDate" placeholder="1492"></div><div class="form-group"><label class="form-label">√âv√©nement</label><input type="text" class="form-input" id="eventText" placeholder="Christophe Colomb arrive aux Antilles"></div></div></div></div>
                <div class="card" id="formQuestionReponse" style="display:none"><div class="card-header"><span class="card-title">2Ô∏è‚É£ Question-R√©ponse</span></div><div class="card-body"><div class="form-group"><label class="form-label">Question</label><textarea class="form-textarea" id="qrQuestion" placeholder="Qui a franchi le Cap ?"></textarea></div><div class="form-group"><label class="form-label">R√©ponse</label><input type="text" class="form-input" id="qrReponse" placeholder="Bartolomeu Dias"></div><div class="form-group"><label class="form-label">Tag</label><div class="tag-selector"><span class="tag-opt selected" onclick="selectTag(this)">Personnage</span><span class="tag-opt" onclick="selectTag(this)">Vocabulaire</span><span class="tag-opt" onclick="selectTag(this)">Lieu</span><span class="tag-opt" onclick="selectTag(this)">Date</span></div></div></div></div>
                <div class="card" id="formDictee" style="display:none"><div class="card-header"><span class="card-title">2Ô∏è‚É£ Dict√©e</span></div><div class="card-body"><div class="form-group"><label class="form-label">Texte</label><textarea class="form-textarea" id="dicteeTexte" placeholder="La caravelle est un bateau l√©ger."></textarea></div><button class="btn btn-secondary" onclick="playDictee()">üîä √âcouter</button></div></div>
                <div class="card" id="formErreur" style="display:none"><div class="card-header"><span class="card-title">2Ô∏è‚É£ Erreur</span></div><div class="card-body"><div class="form-group"><label class="form-label">Phrase avec erreur</label><input type="text" class="form-input" id="erreurPhrase" placeholder="Colomb arrive en 1498."></div><div class="form-row"><div class="form-group"><label class="form-label">Mot erron√©</label><input type="text" class="form-input" id="erreurMot" placeholder="1498"></div><div class="form-group"><label class="form-label">Correction</label><input type="text" class="form-input" id="erreurCorrection" placeholder="1492"></div></div></div></div>
                <div class="card" id="formZone" style="display:none"><div class="card-header"><span class="card-title">2Ô∏è‚É£ Zone image</span></div><div class="card-body"><div class="form-group"><label class="form-label">URL image</label><input type="text" class="form-input" id="zoneImage" placeholder="https://..."></div><div class="form-group"><label class="form-label">Consigne</label><input type="text" class="form-input" id="zoneConsigne" placeholder="Localise le Cap"></div><div class="form-row form-row-3"><div class="form-group"><label class="form-label">X (%)</label><input type="number" class="form-input" id="zoneX" placeholder="45"></div><div class="form-group"><label class="form-label">Y (%)</label><input type="number" class="form-input" id="zoneY" placeholder="78"></div><div class="form-group"><label class="form-label">Rayon</label><input type="number" class="form-input" id="zoneRayon" value="30"></div></div></div></div>
                <div class="card"><div class="card-header"><span class="card-title">3Ô∏è‚É£ Banque</span></div><div class="card-body"><div class="form-group"><label class="form-label">Ranger dans</label><select class="form-select" id="elementBanque"></select></div><div style="display:flex;gap:12px;justify-content:flex-end"><button class="btn btn-secondary" onclick="showPage('banks')">Annuler</button><button class="btn btn-primary" onclick="saveElement()">üíæ Enregistrer</button></div></div></div>
            </div>
            <div id="page-entrainements" style="display:none">
                <div class="header"><h1>üèãÔ∏è Entra√Ænements</h1><p>Exercices illimit√©s sans note</p></div>
                <div class="card"><div class="card-header"><span class="card-title">Liste</span><button class="btn btn-green" onclick="startNewEval('Entrainement')">‚ûï Nouvel entra√Ænement</button></div><div class="card-body np"><table><thead><tr><th>Nom</th><th>Le√ßon</th><th>Exercices</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="entrainementsList"></tbody></table></div></div>
            </div>
            <div id="page-evaluations" style="display:none">
                <div class="header"><h1>üìã √âvaluations</h1><p>√âvaluations not√©es</p></div>
                <div class="card"><div class="card-header"><span class="card-title">Liste</span><button class="btn btn-primary" onclick="startNewEval('Evaluation')">‚ûï Nouvelle √©valuation</button></div><div class="card-body np"><table><thead><tr><th>Nom</th><th>Le√ßon</th><th>Exercices</th><th>Dur√©e</th><th>Seuil</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="evalsList"></tbody></table></div></div>
            </div>
            <div id="page-menu-conn" style="display:none">
                <div class="header"><h1>üìö Menu √©l√®ve (MENU_CONN)</h1><p>Structure du menu Connaissances</p></div>
                <div class="card"><div class="card-header"><span class="card-title">Le√ßons et exercices</span><button class="btn btn-sm btn-primary" onclick="openModal('modalNewMenuEntry')">‚ûï</button></div><div class="card-body np"><table><thead><tr><th>Le√ßon</th><th>N¬∞</th><th>Titre</th><th>Type</th><th>Li√© √†</th><th>Statut</th></tr></thead><tbody id="menuConnList"></tbody></table></div></div>
            </div>
            <div id="page-new-eval" style="display:none">
                <div class="header"><h1 id="newEvalTitle">‚ûï Nouvel entra√Ænement</h1><p>√âtape 1 : Param√®tres</p></div>
                <div class="steps"><div class="step active">1. Param√®tres</div><div class="step">2. Exercices</div><div class="step">3. Liaison</div></div>
                <div class="card"><div class="card-header"><span class="card-title">‚öôÔ∏è Param√®tres</span></div><div class="card-body"><div class="form-row"><div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="evalNom" placeholder="Frise L4"></div><div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="evalDesc" placeholder="Retrouve les √©v√©nements"></div></div><div class="form-row form-row-4" id="evalParamsRow"><div class="form-group"><label class="form-label">Dur√©e (min)</label><input type="number" class="form-input" id="evalDuree" value="15"></div><div class="form-group"><label class="form-label">Seuil (%)</label><input type="number" class="form-input" id="evalSeuil" value="80"></div><div class="form-group"><label class="form-label">Tentatives</label><select class="form-select" id="evalTentatives"><option value="0">Illimit√©es</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div><div class="form-group"><label class="form-label">Affichage</label><select class="form-select" id="evalAffichage"><option value="all">Tout</option><option value="1">1 par page</option></select></div></div><div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px"><button class="btn btn-secondary" onclick="cancelEval()">Annuler</button><button class="btn btn-primary" onclick="goToStep2()">Suivant ‚Üí</button></div></div></div>
            </div>
            <div id="page-edit-eval" style="display:none">
                <div class="header"><h1>‚úèÔ∏è <span id="editEvalTitle">√âvaluation</span></h1><p>Ajoutez les exercices</p></div>
                <div class="steps"><div class="step done">1. Param√®tres ‚úì</div><div class="step active">2. Exercices</div><div class="step">3. Liaison</div></div>
                <div class="two-cols">
                    <div class="card"><div class="card-header"><span class="card-title">üìù Exercices</span><span class="badge badge-warning" id="exerciseCount">0</span></div><div class="card-body np" id="evalExercisesList" style="padding:16px"></div></div>
                    <div class="card"><div class="card-header"><span class="card-title">‚ûï Ajouter</span></div><div class="card-body"><div class="form-group"><label class="form-label">Type</label><div class="exercise-grid"><div class="exercise-card selected" onclick="selectExerciseType(this,'frise')"><div class="icon">‚è±Ô∏è</div><h4>Frise</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'timeline')"><div class="icon">üîÄ</div><h4>Timeline</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'qcm')"><div class="icon">üéØ</div><h4>QCM</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'ouverte')"><div class="icon">‚ùì</div><h4>Question</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'carte')"><div class="icon">üó∫Ô∏è</div><h4>Carte</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'image')"><div class="icon">üñºÔ∏è</div><h4>Image</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'dictee')"><div class="icon">üéß</div><h4>Dict√©e</h4></div><div class="exercise-card" onclick="selectExerciseType(this,'erreur')"><div class="icon">üîç</div><h4>Erreur</h4></div></div></div><div class="config-panel"><div class="config-title">Configuration</div><div class="form-row"><div class="form-group"><label class="form-label">Nombre</label><input type="number" class="form-input" id="exoNombre" value="5" min="1" max="20"></div><div class="form-group"><label class="form-label">S√©lection</label><select class="form-select" id="exoSelection"><option value="random">Al√©atoire</option><option value="all">Toutes</option></select></div></div><div class="form-group"><label class="form-label">Banques</label><div class="bank-checks" id="exoBanques"></div></div><div style="display:flex;justify-content:flex-end;margin-top:16px"><button class="btn btn-primary" onclick="addExerciseToEval()">‚ûï Ajouter</button></div></div></div></div>
                </div>
                <div class="card"><div class="card-body" style="display:flex;justify-content:space-between"><button class="btn btn-secondary" onclick="backToStep1()">‚Üê Retour</button><button class="btn btn-primary" onclick="goToStep3()">Suivant ‚Üí</button></div></div>
            </div>
            <div id="page-link-menu" style="display:none">
                <div class="header"><h1>üîó Liaison menu</h1><p>Associez au menu √©l√®ve</p></div>
                <div class="steps"><div class="step done">1. Param√®tres ‚úì</div><div class="step done">2. Exercices ‚úì</div><div class="step active">3. Liaison</div></div>
                <div class="card"><div class="card-header"><span class="card-title">üìö Emplacement</span></div><div class="card-body"><div class="form-row"><div class="form-group"><label class="form-label">Le√ßon</label><select class="form-select" id="linkLecon" onchange="updateLinkExoOptions()"></select></div><div class="form-group"><label class="form-label">Exercice</label><select class="form-select" id="linkExo"></select></div></div><p style="font-size:12px;color:var(--text-muted);margin-top:12px">üí° Appara√Ætra dans le menu Connaissances</p><div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px"><button class="btn btn-secondary" onclick="goBackToStep2()">‚Üê Retour</button><button class="btn btn-secondary" onclick="saveEvalAsDraft()">üíæ Brouillon</button><button class="btn btn-success" onclick="publishEval()">‚úì Publier</button></div></div></div>
            </div>
        </main>
    </div>
    <div class="modal-overlay" id="modalNewBank"><div class="modal"><div class="modal-header"><h2>‚ûï Nouvelle banque</h2><button class="modal-close" onclick="closeModal('modalNewBank')">‚úï</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="newBankNom" placeholder="L4 - Grandes explorations"></div><div class="form-group"><label class="form-label">Cat√©gorie</label><select class="form-select" id="newBankCat"><option>Histoire</option><option>G√©ographie</option><option>EMC</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalNewBank')">Annuler</button><button class="btn btn-primary" onclick="saveBank()">‚úì Cr√©er</button></div></div></div>
    <div class="modal-overlay" id="modalNewMenuEntry"><div class="modal"><div class="modal-header"><h2>‚ûï Nouvelle entr√©e</h2><button class="modal-close" onclick="closeModal('modalNewMenuEntry')">‚úï</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label class="form-label">N¬∞ Le√ßon</label><input type="text" class="form-input" id="newMenuLecon" placeholder="L4"></div><div class="form-group"><label class="form-label">N¬∞ Exercice</label><input type="number" class="form-input" id="newMenuExo" placeholder="0 = titre"></div></div><div class="form-group"><label class="form-label">Titre Le√ßon</label><input type="text" class="form-input" id="newMenuTitreLecon" placeholder="La mise en relation du monde"></div><div class="form-group"><label class="form-label">Titre Exercice</label><input type="text" class="form-input" id="newMenuTitreExo" placeholder="Exercice 1"></div><div class="form-group"><label class="form-label">Mati√®re</label><select class="form-select" id="newMenuMatiere"><option>Histoire</option><option>G√©ographie</option><option>EMC</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalNewMenuEntry')">Annuler</button><button class="btn btn-primary" onclick="saveMenuEntry()">‚úì Ajouter</button></div></div></div>
    <div class="modal-overlay" id="modalConfirmDelete"><div class="modal"><div class="modal-header"><h2>üóëÔ∏è Confirmer</h2><button class="modal-close" onclick="closeModal('modalConfirmDelete')">‚úï</button></div><div class="modal-body"><p id="deleteConfirmText">Supprimer ?</p></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalConfirmDelete')">Annuler</button><button class="btn btn-primary" style="background:var(--danger)" onclick="confirmDelete()">üóëÔ∏è Supprimer</button></div></div></div>
    <div class="toast" id="toast"></div>

    <script>
        const ADMIN_PASSWORD = 'TEST';
        const SHEET_ID = '1zn0MzEEz-nq-KoVSqghztMA_JZV36PECO4h35xM9or8';
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzyqkUjiZBuS7MR-fo9qbb2Vrbw7JuIuBXczzNIT0qXUE6BZUu9XmJ3zVR-UmzC8SCQ/exec';
        let banques=[],elements=[],evaluations=[],exercices=[],menuConn=[];
        let selectedBanque=null,selectedFormat='Evenement',selectedTag='Personnage',selectedExerciseType='frise';
        let currentEval=null,currentEvalExercises=[],currentEvalType='Entrainement',deleteTarget=null;
        const exerciseFormats={frise:['Evenement'],timeline:['Evenement'],qcm:['Evenement','QuestionReponse'],ouverte:['QuestionReponse'],carte:['Zone'],image:['QuestionReponse'],dictee:['Dictee'],erreur:['Erreur']};
        const exerciseNames={frise:'Frise',timeline:'Timeline',qcm:'QCM',ouverte:'Question',carte:'Carte',image:'Image',dictee:'Dict√©e',erreur:'Erreur'};
        const exerciseIcons={frise:'‚è±Ô∏è',timeline:'üîÄ',qcm:'üéØ',ouverte:'‚ùì',carte:'üó∫Ô∏è',image:'üñºÔ∏è',dictee:'üéß',erreur:'üîç'};

        function checkPassword(){
            if(document.getElementById('loginPassword').value===ADMIN_PASSWORD){
                document.getElementById('loginScreen').style.display='none';
                document.getElementById('mainApp').style.display='grid';
                sessionStorage.setItem('conn_admin_auth','true');
                loadAllData();
            }else{
                document.getElementById('loginError').style.display='block';
                document.getElementById('loginPassword').value='';
            }
        }
        if(sessionStorage.getItem('conn_admin_auth')==='true'){document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='grid';loadAllData();}

        async function loadSheet(name){
            const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
            try{const r=await fetch(url);const t=await r.text();const j=JSON.parse(t.substring(47,t.length-2));if(!j.table||!j.table.rows)return[];const h=j.table.cols.map(c=>c.label||'');return j.table.rows.map(row=>{const o={};row.c.forEach((c,i)=>{o[h[i]]=c?(c.v!==null?c.v:''):'';});return o;});}catch(e){console.error(e);return[];}
        }

        async function loadAllData(){
            showToast('Chargement...');
            banques=(await loadSheet('BANQUES QUESTIONS')).filter(r=>r.ID);
            elements=(await loadSheet('ELEMENTS')).filter(r=>r.ID);
            evaluations=(await loadSheet('EVALUATIONS')).filter(r=>r.ID);
            exercices=(await loadSheet('EXERCICES')).filter(r=>r.ID);
            menuConn=await loadSheet('MENU_CONN');
            document.getElementById('navBankCount').textContent=banques.length;
            document.getElementById('navEntrainCount').textContent=evaluations.filter(e=>e.Type==='Entrainement').length;
            document.getElementById('navEvalCount').textContent=evaluations.filter(e=>e.Type==='Evaluation').length;
            document.getElementById('navMenuCount').textContent=menuConn.filter(m=>m['NumLe√ßon']).length;
            renderBanks();renderEntrainements();renderEvaluations();renderMenuConn();updateBanqueSelect();updateExoBanquesCheckboxes();updateLinkLeconOptions();
            showToast('‚úì Donn√©es charg√©es !');
        }

        function renderBanks(){
            const c=document.getElementById('banksList');
            if(banques.length===0){c.innerHTML='<div class="empty"><div class="icon">üì≠</div><p>Aucune banque</p></div>';return;}
            c.innerHTML=banques.map(b=>{const n=elements.filter(e=>e.Banque===b.ID).length;return`<div class="list-item ${selectedBanque===b.ID?'active':''}" onclick="selectBanque('${b.ID}')"><div class="list-icon">üìÇ</div><div class="list-info"><h4>${b.Nom||b.ID}</h4><p>${b['Cat√©gorie']||''} ‚Ä¢ ${n} √©l√©ments</p></div></div>`;}).join('');
        }

        function selectBanque(id){selectedBanque=id;renderBanks();renderElements();}

        function renderElements(){
            const c=document.getElementById('elementsList'),t=document.getElementById('elementsTitle'),f=document.getElementById('elementsFilters'),btn=document.getElementById('btnAddElement');
            if(!selectedBanque){c.innerHTML='<div class="empty"><div class="icon">üëà</div><p>S√©lectionnez une banque</p></div>';f.style.display='none';btn.style.display='none';return;}
            const b=banques.find(x=>x.ID===selectedBanque);t.textContent=b?b.Nom:selectedBanque;btn.style.display='block';
            const list=elements.filter(e=>e.Banque===selectedBanque);f.style.display='flex';f.innerHTML=`<button class="filter-btn active" onclick="filterElements('')">Tous (${list.length})</button>`;
            renderElementsList(list);
        }

        function filterElements(format){event.target.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));event.target.classList.add('active');let list=elements.filter(e=>e.Banque===selectedBanque);if(format)list=list.filter(e=>e.Format===format);renderElementsList(list);}

        function renderElementsList(list){
            const c=document.getElementById('elementsList');
            if(list.length===0){c.innerHTML='<div class="empty"><div class="icon">üì≠</div><p>Aucun √©l√©ment</p></div>';return;}
            c.innerHTML=list.map(e=>{let content='';if(e.Format==='Evenement')content=`<span class="element-date">${e.Date}</span><div class="element-text">${e.Evenement}</div>`;else if(e.Format==='QuestionReponse')content=`<div class="element-text">${e.Question}<div class="element-sub">‚Üí ${e.Reponse}</div></div>`;else if(e.Format==='Dictee')content=`<div class="element-text">${e.Texte}</div>`;else if(e.Format==='Erreur')content=`<div class="element-text">${e.Phrase}<div class="element-sub">${e.MotErrone} ‚Üí ${e.Correction}</div></div>`;else if(e.Format==='Zone')content=`<div class="element-text">${e.Question||'Zone'}</div>`;return`<div class="element-row"><div class="element-icon event">üìÑ</div><div class="element-content">${content}</div><span class="badge badge-event">${e.Format}</span><button class="btn-icon danger" onclick="prepareDelete('element','${e.ID}')">üóëÔ∏è</button></div>`;}).join('');
        }

        function renderEntrainements(){
            const c=document.getElementById('entrainementsList');const list=evaluations.filter(e=>e.Type==='Entrainement');
            if(list.length===0){c.innerHTML='<tr><td colspan="5" class="empty">Aucun</td></tr>';return;}
            c.innerHTML=list.map(e=>{const n=exercices.filter(x=>x.EvalID===e.ID).length;const lk=menuConn.find(m=>m.EvalID===e.ID);return`<tr><td><strong>${e.Nom||e.ID}</strong></td><td>${lk?lk['NumLe√ßon']:'-'}</td><td>${n}</td><td><span class="badge ${e.Statut==='Publie'?'badge-green':'badge-warning'}">${e.Statut||'Brouillon'}</span></td><td><button class="btn-icon" onclick="editEval('${e.ID}')">‚úèÔ∏è</button><button class="btn-icon danger" onclick="prepareDelete('eval','${e.ID}')">üóëÔ∏è</button></td></tr>`;}).join('');
        }

        function renderEvaluations(){
            const c=document.getElementById('evalsList');const list=evaluations.filter(e=>e.Type==='Evaluation');
            if(list.length===0){c.innerHTML='<tr><td colspan="7" class="empty">Aucune</td></tr>';return;}
            c.innerHTML=list.map(e=>{const n=exercices.filter(x=>x.EvalID===e.ID).length;const lk=menuConn.find(m=>m.EvalID===e.ID);return`<tr><td><strong>${e.Nom||e.ID}</strong></td><td>${lk?lk['NumLe√ßon']:'-'}</td><td>${n}</td><td>${e.Duree||'-'}min</td><td>${e.Seuil||'-'}%</td><td><span class="badge ${e.Statut==='Publie'?'badge-success':'badge-warning'}">${e.Statut||'Brouillon'}</span></td><td><button class="btn-icon" onclick="editEval('${e.ID}')">‚úèÔ∏è</button><button class="btn-icon danger" onclick="prepareDelete('eval','${e.ID}')">üóëÔ∏è</button></td></tr>`;}).join('');
        }

        function renderMenuConn(){
            const c=document.getElementById('menuConnList');const list=menuConn.filter(m=>m['NumLe√ßon']);
            if(list.length===0){c.innerHTML='<tr><td colspan="6" class="empty">Aucune</td></tr>';return;}
            c.innerHTML=list.map(m=>{const isT=!m.NumExo||m.NumExo==='0'||m.NumExo===0;const lk=m.EvalID?evaluations.find(e=>e.ID===m.EvalID):null;return`<tr style="${isT?'background:var(--bg-light);font-weight:600':''}"><td>${m['NumLe√ßon']}</td><td>${isT?'-':m.NumExo}</td><td>${isT?m['TitreLe√ßon']:m.TitreExo}</td><td>${m.Type?`<span class="badge ${m.Type==='Entrainement'?'badge-green':'badge-primary'}">${m.Type}</span>`:'-'}</td><td>${lk?lk.Nom:'-'}</td><td><span class="badge ${m.Statut==='disponible'?'badge-success':'badge-warning'}">${m.Statut||'-'}</span></td></tr>`;}).join('');
        }

        function updateBanqueSelect(){const s=document.getElementById('elementBanque');s.innerHTML=banques.length===0?'<option value="">-- Cr√©ez une banque --</option>':banques.map(b=>`<option value="${b.ID}">${b.Nom||b.ID}</option>`).join('');}

        function updateExoBanquesCheckboxes(){
            const c=document.getElementById('exoBanques');const req=exerciseFormats[selectedExerciseType]||[];
            const comp=banques.filter(b=>elements.filter(e=>e.Banque===b.ID).some(e=>req.includes(e.Format)));
            if(comp.length===0){c.innerHTML='<div style="padding:16px;color:var(--text-muted)">‚ö†Ô∏è Aucune banque compatible</div>';return;}
            c.innerHTML=comp.map(b=>{const n=elements.filter(e=>e.Banque===b.ID&&req.includes(e.Format)).length;return`<div class="bank-check"><input type="checkbox" id="bank_${b.ID}" value="${b.ID}"><label for="bank_${b.ID}">${b.Nom||b.ID}</label><span class="count">${n}</span></div>`;}).join('');
        }

        function updateLinkLeconOptions(){
            const s=document.getElementById('linkLecon');const ls=[...new Set(menuConn.filter(m=>m['NumLe√ßon']&&m['TitreLe√ßon']).map(m=>m['NumLe√ßon']))];
            s.innerHTML='<option value="">-- Choisir --</option>'+ls.map(l=>{const e=menuConn.find(m=>m['NumLe√ßon']===l&&m['TitreLe√ßon']);return`<option value="${l}">${l} - ${e?e['TitreLe√ßon']:''}</option>`;}).join('');
        }

        function updateLinkExoOptions(){
            const l=document.getElementById('linkLecon').value;const s=document.getElementById('linkExo');
            if(!l){s.innerHTML='<option value="">-- Choisir une le√ßon --</option>';return;}
            const exos=menuConn.filter(m=>m['NumLe√ßon']===l&&m.NumExo&&m.NumExo!=='0'&&m.NumExo!==0);
            s.innerHTML='<option value="">-- Choisir --</option>'+exos.map(e=>`<option value="${e.NumExo}">${e.TitreExo||'Exercice '+e.NumExo}${e.EvalID?' (li√©)':''}</option>`).join('');
        }

        function showPage(id){document.querySelectorAll('[id^="page-"]').forEach(p=>p.style.display='none');document.getElementById('page-'+id).style.display='block';document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));const map={banks:0,'new-element':1,entrainements:2,evaluations:4,'menu-conn':6};const items=document.querySelectorAll('.nav-item');if(map[id]!==undefined&&items[map[id]])items[map[id]].classList.add('active');}

        function startNewEval(type){currentEvalType=type;currentEval=null;currentEvalExercises=[];document.getElementById('evalNom').value='';document.getElementById('evalDesc').value='';document.getElementById('evalDuree').value=15;document.getElementById('evalSeuil').value=80;document.getElementById('newEvalTitle').textContent=type==='Entrainement'?'‚ûï Nouvel entra√Ænement':'‚ûï Nouvelle √©valuation';document.getElementById('evalParamsRow').style.display=type==='Entrainement'?'none':'grid';showPage('new-eval');}

        function cancelEval(){currentEval=null;currentEvalExercises=[];showPage(currentEvalType==='Entrainement'?'entrainements':'evaluations');}

        function goToStep2(){const nom=document.getElementById('evalNom').value;if(!nom){showToast('Entrez un nom',true);return;}currentEval={ID:currentEval?.ID||(currentEvalType==='Entrainement'?'ENT':'EVAL')+Date.now(),Nom:nom,Description:document.getElementById('evalDesc').value,Type:currentEvalType,Duree:currentEvalType==='Evaluation'?document.getElementById('evalDuree').value:'',Seuil:currentEvalType==='Evaluation'?document.getElementById('evalSeuil').value:'',Tentatives:currentEvalType==='Evaluation'?document.getElementById('evalTentatives').value:'0',Affichage:document.getElementById('evalAffichage').value,Statut:'Brouillon'};document.getElementById('editEvalTitle').textContent=currentEval.Nom;showPage('edit-eval');renderEvalExercises();}

        function backToStep1(){showPage('new-eval');if(currentEval){document.getElementById('evalNom').value=currentEval.Nom||'';document.getElementById('evalDesc').value=currentEval.Description||'';}}

        function goToStep3(){if(currentEvalExercises.length===0){showToast('Ajoutez au moins un exercice',true);return;}updateLinkLeconOptions();showPage('link-menu');}
        function goBackToStep2(){showPage('edit-eval');}

        function editEval(id){const ev=evaluations.find(e=>e.ID===id);if(!ev)return;currentEval={...ev};currentEvalType=ev.Type||'Entrainement';currentEvalExercises=exercices.filter(x=>x.EvalID===id).map(x=>({...x}));document.getElementById('evalNom').value=ev.Nom||'';document.getElementById('evalDesc').value=ev.Description||'';document.getElementById('evalDuree').value=ev.Duree||15;document.getElementById('evalSeuil').value=ev.Seuil||80;document.getElementById('editEvalTitle').textContent=ev.Nom;document.getElementById('evalParamsRow').style.display=currentEvalType==='Entrainement'?'none':'grid';showPage('edit-eval');renderEvalExercises();}

        function selectExerciseType(el,type){document.querySelectorAll('.exercise-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');selectedExerciseType=type;updateExoBanquesCheckboxes();}

        function addExerciseToEval(){const nb=document.getElementById('exoNombre').value;const sel=document.getElementById('exoSelection').value;const banks=[];document.querySelectorAll('#exoBanques input:checked').forEach(cb=>banks.push(cb.value));if(banks.length===0){showToast('S√©lectionnez une banque',true);return;}currentEvalExercises.push({ID:'EX'+Date.now(),EvalID:currentEval.ID,Ordre:currentEvalExercises.length+1,Type:selectedExerciseType,Mode:sel,Nombre:nb,Banques:banks.join(',')});renderEvalExercises();showToast('‚úì Exercice ajout√© !');document.querySelectorAll('#exoBanques input:checked').forEach(cb=>cb.checked=false);}

        function renderEvalExercises(){const c=document.getElementById('evalExercisesList');document.getElementById('exerciseCount').textContent=currentEvalExercises.length;if(currentEvalExercises.length===0){c.innerHTML='<div class="empty" style="padding:40px"><div class="icon">üì≠</div><p>Aucun exercice</p></div>';return;}c.innerHTML=currentEvalExercises.map((ex,i)=>{const names=ex.Banques.split(',').map(id=>{const b=banques.find(x=>x.ID===id);return b?b.Nom:id;}).join(', ');return`<div class="exercise-item"><div class="order">${i+1}</div><div class="info"><h4>${exerciseIcons[ex.Type]} ${exerciseNames[ex.Type]}</h4><p>${ex.Nombre} q ‚Ä¢ ${names}</p></div><div class="actions"><button class="btn-icon" onclick="moveExercise(${i},-1)" ${i===0?'disabled':''}>‚¨ÜÔ∏è</button><button class="btn-icon" onclick="moveExercise(${i},1)" ${i===currentEvalExercises.length-1?'disabled':''}>‚¨áÔ∏è</button><button class="btn-icon danger" onclick="removeExercise(${i})">üóëÔ∏è</button></div></div>`;}).join('');}

        function moveExercise(i,d){const n=i+d;if(n<0||n>=currentEvalExercises.length)return;[currentEvalExercises[i],currentEvalExercises[n]]=[currentEvalExercises[n],currentEvalExercises[i]];currentEvalExercises.forEach((e,x)=>e.Ordre=x+1);renderEvalExercises();}
        function removeExercise(i){currentEvalExercises.splice(i,1);currentEvalExercises.forEach((e,x)=>e.Ordre=x+1);renderEvalExercises();}

        async function saveEvalAsDraft(){await saveEvaluation('Brouillon');}
        async function publishEval(){const l=document.getElementById('linkLecon').value;const e=document.getElementById('linkExo').value;if(!l||!e){showToast('Choisissez un emplacement',true);return;}await saveEvaluation('Publie',l,e);}

        async function saveEvaluation(statut,lecon=null,exo=null){
            currentEval.Statut=statut;showToast('Enregistrement...');
            try{
                const exists=evaluations.find(e=>e.ID===currentEval.ID);
                if(exists){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'EVALUATIONS',action:'delete',id:currentEval.ID})});for(const ex of exercices.filter(e=>e.EvalID===currentEval.ID)){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'EXERCICES',action:'delete',id:ex.ID})});}}
                await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'EVALUATIONS',action:'add',row:[currentEval.ID,currentEval.Nom,currentEval.Description,currentEval.Type,currentEval.Duree,currentEval.Seuil,currentEval.Tentatives,currentEval.Affichage,'','',currentEval.Statut]})});
                for(const ex of currentEvalExercises){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'EXERCICES',action:'add',row:[ex.ID,ex.EvalID,ex.Ordre,ex.Type,ex.Mode,ex.Nombre,ex.Banques,'','']})});}
                if(statut==='Publie'&&lecon&&exo){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'MENU_CONN',action:'updateLink',numLecon:lecon,numExo:exo,type:currentEval.Type,evalId:currentEval.ID,statut:'disponible'})});}
                await loadAllData();showToast('‚úì Enregistr√© !');currentEval=null;currentEvalExercises=[];showPage(currentEvalType==='Entrainement'?'entrainements':'evaluations');
            }catch(e){console.error(e);showToast('Erreur',true);}
        }

        function selectFormat(el,f){document.querySelectorAll('.format-option').forEach(o=>o.classList.remove('selected'));el.classList.add('selected');selectedFormat=f;['Evenement','QuestionReponse','Zone','Dictee','Erreur'].forEach(x=>document.getElementById('form'+x).style.display=x===f?'block':'none');}
        function selectTag(el){document.querySelectorAll('.tag-opt').forEach(t=>t.classList.remove('selected'));el.classList.add('selected');selectedTag=el.textContent;}
        function playDictee(){const t=document.getElementById('dicteeTexte').value||'Test';const u=new SpeechSynthesisUtterance(t);u.lang='fr-FR';speechSynthesis.speak(u);}

        async function saveBank(){const nom=document.getElementById('newBankNom').value,cat=document.getElementById('newBankCat').value;if(!nom){showToast('Entrez un nom',true);return;}const id=nom.replace(/[^a-zA-Z0-9]/g,'').substring(0,10).toUpperCase()+Date.now().toString().slice(-4);showToast('Enregistrement...');try{await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'BANQUES QUESTIONS',action:'add',row:[id,nom,cat,'Actif']})});banques.push({ID:id,Nom:nom,'Cat√©gorie':cat,Statut:'Actif'});document.getElementById('navBankCount').textContent=banques.length;renderBanks();updateBanqueSelect();updateExoBanquesCheckboxes();closeModal('modalNewBank');showToast('‚úì Banque cr√©√©e !');document.getElementById('newBankNom').value='';}catch(e){showToast('Erreur',true);}}

        async function saveElement(){
            const bq=document.getElementById('elementBanque').value;if(!bq){showToast('S√©lectionnez une banque',true);return;}
            const id='E'+Date.now();const el={ID:id,Banque:bq,Format:selectedFormat,Statut:'Actif'};let row=[id,bq,selectedFormat,'','','','','','','','','','','','','','Actif'];
            if(selectedFormat==='Evenement'){el.Date=document.getElementById('eventDate').value;el.Evenement=document.getElementById('eventText').value;if(!el.Date||!el.Evenement){showToast('Remplissez',true);return;}row[3]=el.Date;row[4]=el.Evenement;}
            else if(selectedFormat==='QuestionReponse'){el.Question=document.getElementById('qrQuestion').value;el.Reponse=document.getElementById('qrReponse').value;el.Tag=selectedTag;if(!el.Question||!el.Reponse){showToast('Remplissez',true);return;}row[5]=el.Question;row[6]=el.Reponse;row[8]=el.Tag;}
            else if(selectedFormat==='Dictee'){el.Texte=document.getElementById('dicteeTexte').value;if(!el.Texte){showToast('Remplissez',true);return;}row[9]=el.Texte;}
            else if(selectedFormat==='Erreur'){el.Phrase=document.getElementById('erreurPhrase').value;el.MotErrone=document.getElementById('erreurMot').value;el.Correction=document.getElementById('erreurCorrection').value;if(!el.Phrase){showToast('Remplissez',true);return;}row[10]=el.Phrase;row[11]=el.MotErrone;row[12]=el.Correction;}
            else if(selectedFormat==='Zone'){el.Image=document.getElementById('zoneImage').value;el.Question=document.getElementById('zoneConsigne').value;el.X=document.getElementById('zoneX').value;el.Y=document.getElementById('zoneY').value;el.Rayon=document.getElementById('zoneRayon').value;row[5]=el.Question;row[7]=el.Image;row[13]=el.X;row[14]=el.Y;row[15]=el.Rayon;}
            showToast('Enregistrement...');try{await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'ELEMENTS',action:'add',row:row})});elements.push(el);showToast('‚úì Ajout√© !');document.querySelectorAll('#page-new-element .form-input, #page-new-element .form-textarea').forEach(el=>{if(!['elementBanque','zoneRayon'].includes(el.id))el.value='';});showPage('banks');selectBanque(bq);}catch(e){showToast('Erreur',true);}
        }

        async function saveMenuEntry(){const l=document.getElementById('newMenuLecon').value;const e=document.getElementById('newMenuExo').value||'0';const tl=document.getElementById('newMenuTitreLecon').value;const te=document.getElementById('newMenuTitreExo').value;const m=document.getElementById('newMenuMatiere').value;if(!l){showToast('Entrez le n¬∞ de le√ßon',true);return;}showToast('Enregistrement...');try{await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'MENU_CONN',action:'add',row:[l,e,tl,te,m,'','','']})});closeModal('modalNewMenuEntry');showToast('‚úì Ajout√© !');await loadAllData();}catch(e){showToast('Erreur',true);}}

        function prepareDelete(type,id){deleteTarget={type,id};document.getElementById('deleteConfirmText').textContent=type==='eval'?'Supprimer cette entr√©e ?':'Supprimer cet √©l√©ment ?';openModal('modalConfirmDelete');}

        async function confirmDelete(){if(!deleteTarget)return;closeModal('modalConfirmDelete');showToast('Suppression...');try{if(deleteTarget.type==='element'){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'ELEMENTS',action:'delete',id:deleteTarget.id})});elements=elements.filter(e=>e.ID!==deleteTarget.id);renderElements();}else if(deleteTarget.type==='eval'){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'EVALUATIONS',action:'delete',id:deleteTarget.id})});for(const ex of exercices.filter(x=>x.EvalID===deleteTarget.id)){await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({sheet:'EXERCICES',action:'delete',id:ex.ID}));}evaluations=evaluations.filter(e=>e.ID!==deleteTarget.id);exercices=exercices.filter(x=>x.EvalID!==deleteTarget.id);renderEntrainements();renderEvaluations();document.getElementById('navEntrainCount').textContent=evaluations.filter(e=>e.Type==='Entrainement').length;document.getElementById('navEvalCount').textContent=evaluations.filter(e=>e.Type==='Evaluation').length;}showToast('‚úì Supprim√© !');}catch(e){showToast('Erreur',true);}deleteTarget=null;}

        function openModal(id){document.getElementById(id).classList.add('visible');}
        function closeModal(id){document.getElementById(id).classList.remove('visible');}
        document.querySelectorAll('.modal-overlay').forEach(o=>{o.onclick=e=>{if(e.target===o)o.classList.remove('visible');};});

        function showToast(msg,err=false){const t=document.getElementById('toast');t.textContent=msg;t.className='toast visible'+(err?' error':'');setTimeout(()=>t.classList.remove('visible'),3000);}
    </script>
</body>
</html>
