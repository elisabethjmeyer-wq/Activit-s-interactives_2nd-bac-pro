<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin CONN - √âvaluations de connaissances</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f8f9fc;
            --bg-card: #ffffff;
            --bg-hover: #f1f3f9;
            --border: #e2e4eb;
            --text: #1a1d26;
            --text-muted: #6b7280;
            --primary: #7c3aed;
            --primary-light: #8b5cf6;
            --primary-glow: rgba(124, 58, 237, 0.15);
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.1);
            --warning: #d97706;
            --warning-bg: rgba(217, 119, 6, 0.1);
            --danger: #dc2626;
            --danger-bg: rgba(220, 38, 38, 0.1);
            --info: #2563eb;
            --info-bg: rgba(37, 99, 235, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-light); color: var(--text); min-height: 100vh; line-height: 1.6; }
        .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        .sidebar { background: var(--bg-card); border-right: 1px solid var(--border); padding: 24px 16px; position: sticky; top: 0; height: 100vh; overflow-y: auto; box-shadow: var(--shadow-sm); }
        .logo { display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 32px; }
        .logo-icon { width: 42px; height: 42px; background: linear-gradient(135deg, var(--primary), var(--primary-light)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 12px var(--primary-glow); }
        .logo-text { font-weight: 700; font-size: 16px; color: var(--text); }
        .logo-text span { display: block; font-size: 11px; font-weight: 400; color: var(--text-muted); }
        .nav-section { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); padding: 20px 16px 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; transition: all 0.2s; font-size: 14px; font-weight: 500; text-decoration: none; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .nav-item .icon { font-size: 18px; }
        .nav-item .badge { margin-left: auto; background: var(--bg-hover); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; color: var(--text-muted); }
        .nav-item.active .badge { background: rgba(255,255,255,0.25); color: white; }
        .nav-back { background: var(--bg-hover); margin-bottom: 16px; }
        .nav-back:hover { background: var(--border); }
        .main { padding: 32px; max-width: 1400px; }
        .header { margin-bottom: 32px; }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; color: var(--text); }
        .header p { color: var(--text-muted); font-size: 15px; }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 24px; overflow: hidden; box-shadow: var(--shadow-sm); }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--bg-light); }
        .card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .card-body { padding: 24px; }
        .card-body.np { padding: 0; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border: none; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; box-shadow: 0 4px 12px var(--primary-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px var(--primary-glow); }
        .btn-secondary { background: var(--bg-card); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; display: inline-flex; justify-content: center; align-items: center; border-radius: var(--radius-sm); background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .btn-icon:hover { background: var(--bg-hover); color: var(--text); }
        .btn-icon.danger:hover { background: var(--danger-bg); border-color: var(--danger); color: var(--danger); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 14px; font-family: inherit; transition: all 0.2s; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .form-row-3 { grid-template-columns: repeat(3, 1fr); }
        .form-row-4 { grid-template-columns: repeat(4, 1fr); }
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-event { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }
        .badge-qr { background: var(--info-bg); color: var(--info); border: 1px solid var(--info); }
        .badge-zone { background: rgba(219, 39, 119, 0.1); color: #db2777; border: 1px solid #db2777; }
        .badge-dictee { background: rgba(124, 58, 237, 0.1); color: #7c3aed; border: 1px solid #7c3aed; }
        .badge-erreur { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--warning); }
        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-warning { background: var(--warning-bg); color: var(--warning); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); background: var(--bg-light); }
        tr:hover { background: var(--bg-hover); }
        .list-item { display: flex; align-items: center; gap: 16px; padding: 16px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s; cursor: pointer; }
        .list-item:hover { background: var(--bg-hover); }
        .list-item:last-child { border-bottom: none; }
        .list-item.active { background: var(--primary-glow); border-left: 3px solid var(--primary); }
        .list-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: var(--bg-light); border: 1px solid var(--border); }
        .list-info { flex: 1; }
        .list-info h4 { font-size: 15px; font-weight: 600; margin-bottom: 2px; color: var(--text); }
        .list-info p { font-size: 13px; color: var(--text-muted); }
        .element-row { display: flex; align-items: center; gap: 12px; padding: 14px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .element-row:hover { background: var(--bg-hover); }
        .element-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .element-icon.event { background: var(--success-bg); }
        .element-icon.qr { background: var(--info-bg); }
        .element-icon.zone { background: rgba(219, 39, 119, 0.1); }
        .element-icon.dictee { background: rgba(124, 58, 237, 0.1); }
        .element-icon.erreur { background: var(--warning-bg); }
        .element-content { flex: 1; }
        .element-date { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--primary); min-width: 50px; }
        .element-text { font-size: 14px; color: var(--text); }
        .element-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .filter-btn { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; color: var(--text-muted); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover, .filter-btn.active { background: var(--primary-glow); border-color: var(--primary); color: var(--primary); }
        .format-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .format-option { padding: 20px 16px; background: var(--bg-light); border: 2px solid var(--border); border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.2s; }
        .format-option:hover { border-color: var(--primary); background: var(--primary-glow); }
        .format-option.selected { border-color: var(--primary); background: var(--primary-glow); box-shadow: 0 0 0 3px var(--primary-glow); }
        .format-option .icon { font-size: 28px; margin-bottom: 8px; }
        .format-option h4 { font-size: 13px; font-weight: 600; color: var(--text); }
        .exercise-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .exercise-card { padding: 16px; background: var(--bg-light); border: 2px solid var(--border); border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.2s; }
        .exercise-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .exercise-card.selected { border-color: var(--primary); background: var(--primary-glow); }
        .exercise-card .icon { font-size: 24px; margin-bottom: 8px; }
        .exercise-card h4 { font-size: 12px; font-weight: 600; color: var(--text); }
        .exercise-card p { font-size: 11px; color: var(--text-muted); }
        .config-panel { background: var(--bg-light); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-top: 20px; }
        .config-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 16px; text-transform: uppercase; }
        .bank-checks { max-height: 180px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 8px; background: var(--bg-card); }
        .bank-check { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s; }
        .bank-check:hover { background: var(--bg-hover); }
        .bank-check input { width: 18px; height: 18px; accent-color: var(--primary); }
        .bank-check label { flex: 1; font-size: 14px; cursor: pointer; color: var(--text); }
        .bank-check .count { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: translateY(20px) scale(0.95); transition: transform 0.3s; box-shadow: var(--shadow); }
        .modal.lg { max-width: 900px; }
        .modal-overlay.visible .modal { transform: translateY(0) scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-hover); border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; font-size: 18px; transition: all 0.2s; }
        .modal-close:hover { background: var(--border); color: var(--text); }
        .modal-body { padding: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 16px 24px; border-top: 1px solid var(--border); background: var(--bg-light); }
        .two-cols { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--text-muted); }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 60px 40px; color: var(--text-muted); }
        .empty .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .tag-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag-opt { padding: 8px 16px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--text-muted); }
        .tag-opt:hover, .tag-opt.selected { border-color: var(--primary); background: var(--primary-glow); color: var(--primary); }
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: var(--bg-card); border: 1px solid var(--success); border-radius: var(--radius); color: var(--success); font-weight: 600; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; box-shadow: var(--shadow); }
        .toast.visible { transform: translateY(0); opacity: 1; }
        .toast.error { border-color: var(--danger); color: var(--danger); }
        .exercise-item { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-light); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 12px; }
        .exercise-item .order { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .exercise-item .info { flex: 1; }
        .exercise-item .info h4 { font-size: 14px; font-weight: 600; color: var(--text); }
        .exercise-item .info p { font-size: 12px; color: var(--text-muted); }
        .exercise-item .actions { display: flex; gap: 8px; }
        .steps { display: flex; gap: 8px; margin-bottom: 24px; }
        .step { flex: 1; padding: 12px; background: var(--bg-light); border: 2px solid var(--border); border-radius: var(--radius-sm); text-align: center; font-size: 12px; font-weight: 600; color: var(--text-muted); }
        .step.active { border-color: var(--primary); color: var(--primary); background: var(--primary-glow); }
        .step.done { border-color: var(--success); color: var(--success); background: var(--success-bg); }
        @media (max-width: 1024px) { .format-grid { grid-template-columns: repeat(3, 1fr); } .exercise-grid { grid-template-columns: repeat(2, 1fr); } .form-row, .form-row-3, .form-row-4 { grid-template-columns: 1fr; } .two-cols { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } .format-grid, .exercise-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <div class="layout" id="mainApp">
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">üìù</div>
                <div class="logo-text">Admin CONN<span>√âvaluations de connaissances</span></div>
            </div>
            <nav>
                <a href="index.html" class="nav-item nav-back"><span class="icon">‚Üê</span>Retour au dashboard</a>
                
                <div class="nav-section">Banques</div>
                <div class="nav-item active" onclick="showPage('banks')"><span class="icon">üóÉÔ∏è</span>Mes banques<span class="badge" id="navBankCount">0</span></div>
                <div class="nav-item" onclick="showPage('new-element')"><span class="icon">‚ûï</span>Nouvel √©l√©ment</div>
                <div class="nav-section">√âvaluations</div>
                <div class="nav-item" onclick="showPage('evaluations')"><span class="icon">üìã</span>Mes √©valuations<span class="badge" id="navEvalCount">0</span></div>
                <div class="nav-item" onclick="showPage('new-eval')"><span class="icon">‚ûï</span>Nouvelle √©valuation</div>
                <div class="nav-section">Syst√®me</div>
                <div class="nav-item" onclick="loadAllData()"><span class="icon">üîÑ</span>Rafra√Æchir</div>
                <div class="nav-item" onclick="openModal('modalHelp')"><span class="icon">‚ùì</span>Aide</div>
            </nav>
        </aside>
        <main class="main">
            <div id="page-banks">
                <div class="header"><h1>üóÉÔ∏è Mes banques de questions</h1><p>5 formats de donn√©es ‚Ä¢ Cliquez sur une banque pour voir ses √©l√©ments</p></div>
                <div class="two-cols">
                    <div class="card">
                        <div class="card-header"><span class="card-title">üìÇ Banques</span><button class="btn btn-sm btn-primary" onclick="openModal('modalNewBank')">‚ûï</button></div>
                        <div class="card-body np" id="banksList"><div class="loading"><div class="spinner"></div> Chargement...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title" id="elementsTitle">S√©lectionnez une banque</span><button class="btn btn-sm btn-primary" onclick="showPage('new-element')" style="display:none" id="btnAddElement">‚ûï</button></div>
                        <div class="card-body np">
                            <div class="filters" id="elementsFilters" style="display:none;padding:16px 24px 0;"></div>
                            <div id="elementsList"><div class="empty"><div class="icon">üëà</div><p>S√©lectionnez une banque √† gauche</p></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-new-element" style="display:none">
                <div class="header"><h1>‚ûï Nouvel √©l√©ment</h1><p>Choisissez un format et remplissez les champs</p></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">1Ô∏è‚É£ Format de donn√©es</span></div>
                    <div class="card-body">
                        <div class="format-grid">
                            <div class="format-option selected" onclick="selectFormat(this,'Evenement')"><div class="icon">üìÖ</div><h4>√âv√©nement</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'QuestionReponse')"><div class="icon">‚ùì</div><h4>Question-R√©ponse</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'Zone')"><div class="icon">üó∫Ô∏è</div><h4>Zone image</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'Dictee')"><div class="icon">üéß</div><h4>Dict√©e</h4></div>
                            <div class="format-option" onclick="selectFormat(this,'Erreur')"><div class="icon">üîç</div><h4>Erreur</h4></div>
                        </div>
                    </div>
                </div>
                <div class="card" id="formEvenement">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - √âv√©nement</span></div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Date</label><input type="text" class="form-input" id="eventDate" placeholder="Ex: 1492"></div>
                            <div class="form-group"><label class="form-label">√âv√©nement</label><input type="text" class="form-input" id="eventText" placeholder="Ex: Christophe Colomb arrive aux Antilles"></div>
                        </div>
                        <p class="form-hint">üí° Utilisable pour : Frise chronologique, Timeline, QCM dates</p>
                    </div>
                </div>
                <div class="card" id="formQuestionReponse" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Question-R√©ponse</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Question / Indice</label><textarea class="form-textarea" id="qrQuestion" placeholder="Ex: Qui a franchi le Cap de Bonne-Esp√©rance en 1488 ?"></textarea></div>
                        <div class="form-group"><label class="form-label">R√©ponse attendue</label><input type="text" class="form-input" id="qrReponse" placeholder="Ex: Bartolomeu Dias"></div>
                        <div class="form-group"><label class="form-label">Tag</label><div class="tag-selector"><span class="tag-opt selected" onclick="selectTag(this)">Personnage</span><span class="tag-opt" onclick="selectTag(this)">Vocabulaire</span><span class="tag-opt" onclick="selectTag(this)">Lieu</span><span class="tag-opt" onclick="selectTag(this)">Date</span><span class="tag-opt" onclick="selectTag(this)">Autre</span></div></div>
                    </div>
                </div>
                <div class="card" id="formDictee" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Dict√©e</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Texte √† dicter</label><textarea class="form-textarea" id="dicteeTexte" placeholder="Ex: La caravelle est un bateau l√©ger utilis√© par les Portugais."></textarea></div>
                        <div class="form-group"><button class="btn btn-secondary" onclick="playDictee()">üîä √âcouter</button></div>
                    </div>
                </div>
                <div class="card" id="formErreur" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Trouve l'erreur</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Phrase avec erreur</label><input type="text" class="form-input" id="erreurPhrase" placeholder="Ex: Christophe Colomb arrive aux Antilles en 1498."></div>
                        <div class="form-row"><div class="form-group"><label class="form-label">Mot erron√©</label><input type="text" class="form-input" id="erreurMot" placeholder="Ex: 1498"></div><div class="form-group"><label class="form-label">Correction</label><input type="text" class="form-input" id="erreurCorrection" placeholder="Ex: 1492"></div></div>
                    </div>
                </div>
                <div class="card" id="formZone" style="display:none">
                    <div class="card-header"><span class="card-title">2Ô∏è‚É£ Contenu - Zone image</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">URL de l'image</label><input type="text" class="form-input" id="zoneImage" placeholder="Ex: https://example.com/carte.jpg"></div>
                        <div class="form-group"><label class="form-label">Consigne</label><input type="text" class="form-input" id="zoneConsigne" placeholder="Ex: Localise le Cap de Bonne-Esp√©rance"></div>
                        <div class="form-row form-row-3"><div class="form-group"><label class="form-label">Position X (%)</label><input type="number" class="form-input" id="zoneX" placeholder="45"></div><div class="form-group"><label class="form-label">Position Y (%)</label><input type="number" class="form-input" id="zoneY" placeholder="78"></div><div class="form-group"><label class="form-label">Rayon</label><input type="number" class="form-input" id="zoneRayon" value="30"></div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">3Ô∏è‚É£ Banque de destination</span></div>
                    <div class="card-body">
                        <div class="form-group"><label class="form-label">Ranger dans</label><select class="form-select" id="elementBanque"></select></div>
                        <div style="display:flex;gap:12px;justify-content:flex-end;"><button class="btn btn-secondary" onclick="showPage('banks')">Annuler</button><button class="btn btn-primary" onclick="saveElement()">üíæ Enregistrer</button></div>
                    </div>
                </div>
            </div>
            <div id="page-evaluations" style="display:none">
                <div class="header"><h1>üìã Mes √©valuations</h1><p>8 types d'exercices disponibles</p></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Liste des √©valuations</span><button class="btn btn-primary" onclick="showPage('new-eval')">‚ûï Nouvelle</button></div>
                    <div class="card-body np">
                        <table><thead><tr><th>√âvaluation</th><th>Exercices</th><th>Dur√©e</th><th>Seuil</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="evalsList"><tr><td colspan="6" class="loading"><div class="spinner"></div> Chargement...</td></tr></tbody></table>
                    </div>
                </div>
            </div>
            <div id="page-new-eval" style="display:none">
                <div class="header"><h1>‚ûï Nouvelle √©valuation</h1><p>√âtape 1 : Param√®tres g√©n√©raux</p></div>
                <div class="steps"><div class="step active">1. Param√®tres</div><div class="step">2. Exercices</div><div class="step">3. Validation</div></div>
                <div class="card">
                    <div class="card-header"><span class="card-title">‚öôÔ∏è Param√®tres g√©n√©raux</span></div>
                    <div class="card-body">
                        <div class="form-row form-row-3"><div class="form-group"><label class="form-label">N¬∞ Le√ßon</label><input type="text" class="form-input" id="evalNumLecon" placeholder="Ex: L4"></div><div class="form-group"><label class="form-label">Titre (pour le menu)</label><input type="text" class="form-input" id="evalNom" placeholder="Ex: Sujet 1"></div><div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="evalDesc" placeholder="Ex: Mise en relation du monde"></div></div>
                        <div class="form-row form-row-3"><div class="form-group"><label class="form-label">Mati√®re</label><select class="form-select" id="evalMatiere"><option value="Histoire">üìú Histoire</option><option value="G√©ographie">üåç G√©ographie</option><option value="EMC">‚öñÔ∏è EMC</option></select></div><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="evalType"><option value="entrainement">üèãÔ∏è Entra√Ænement</option><option value="evaluation">üìù √âvaluation</option></select></div><div class="form-group"><label class="form-label">Dur√©e (min)</label><input type="number" class="form-input" id="evalDuree" value="15"></div></div>
                        <div class="form-row form-row-3"><div class="form-group"><label class="form-label">Seuil (%)</label><input type="number" class="form-input" id="evalSeuil" value="80"></div><div class="form-group"><label class="form-label">Tentatives</label><select class="form-select" id="evalTentatives"><option value="illimit√©">Illimit√©es</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div><div class="form-group"><label class="form-label">Affichage</label><select class="form-select" id="evalAffichage"><option value="all">Tout d'un coup</option><option value="1">1 par page</option><option value="5">5 par page</option></select></div></div>
                        <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;"><button class="btn btn-secondary" onclick="showPage('evaluations')">Annuler</button><button class="btn btn-primary" onclick="goToStep2()">Suivant : Exercices ‚Üí</button></div>
                    </div>
                </div>
            </div>
            <div id="page-edit-eval" style="display:none">
                <div class="header"><h1>‚úèÔ∏è <span id="editEvalTitle">√âvaluation</span></h1><p>Ajoutez et configurez les exercices</p></div>
                <div class="steps"><div class="step done">1. Param√®tres ‚úì</div><div class="step active">2. Exercices</div><div class="step">3. Validation</div></div>
                <div class="two-cols">
                    <div class="card">
                        <div class="card-header"><span class="card-title">üìù Exercices ajout√©s</span><span class="badge badge-warning" id="exerciseCount">0</span></div>
                        <div class="card-body np" id="evalExercisesList" style="padding:16px;"><div class="empty" style="padding:40px;"><div class="icon">üì≠</div><p>Aucun exercice</p></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">‚ûï Ajouter un exercice</span></div>
                        <div class="card-body">
                            <div class="form-group"><label class="form-label">Type d'exercice</label>
                                <div class="exercise-grid">
                                    <div class="exercise-card selected" onclick="selectExerciseType(this,'frise')"><div class="icon">‚è±Ô∏è</div><h4>Frise chrono</h4><p>√âv√©nements</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'timeline')"><div class="icon">üîÄ</div><h4>Timeline</h4><p>√âv√©nements</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'qcm')"><div class="icon">üéØ</div><h4>QCM</h4><p>Q/R, √âv√©nements</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'ouverte')"><div class="icon">‚ùì</div><h4>Question ouverte</h4><p>Q/R</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'carte')"><div class="icon">üó∫Ô∏è</div><h4>Carte cliquable</h4><p>Zones</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'image')"><div class="icon">üñºÔ∏è</div><h4>Identification</h4><p>Q/R + Image</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'dictee')"><div class="icon">üéß</div><h4>Dict√©e</h4><p>Dict√©es</p></div>
                                    <div class="exercise-card" onclick="selectExerciseType(this,'erreur')"><div class="icon">üîç</div><h4>Trouve l'erreur</h4><p>Erreurs</p></div>
                                </div>
                            </div>
                            <div class="config-panel">
                                <div class="config-title">Configuration</div>
                                <div class="form-row"><div class="form-group"><label class="form-label">Nombre de questions</label><input type="number" class="form-input" id="exoNombre" value="5" min="1" max="20"></div><div class="form-group"><label class="form-label">S√©lection</label><select class="form-select" id="exoSelection"><option value="random">Al√©atoire</option><option value="all">Toutes</option></select></div></div>
                                <div class="form-group"><label class="form-label">Banques sources</label><div class="bank-checks" id="exoBanques"></div></div>
                                <div style="display:flex;justify-content:flex-end;margin-top:16px;"><button class="btn btn-primary" onclick="addExerciseToEval()">‚ûï Ajouter cet exercice</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-body" style="display:flex;justify-content:space-between;"><button class="btn btn-secondary" onclick="backToStep1()">‚Üê Retour</button><div style="display:flex;gap:12px;"><button class="btn btn-secondary" onclick="saveEvalAsDraft()">üíæ Brouillon</button><button class="btn btn-success" onclick="publishEval()">‚úì Publier</button></div></div></div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="modalNewBank">
        <div class="modal">
            <div class="modal-header"><h2>‚ûï Nouvelle banque</h2><button class="modal-close" onclick="closeModal('modalNewBank')">‚úï</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="newBankNom" placeholder="Ex: L6 - Renaissance"></div>
                <div class="form-group"><label class="form-label">Cat√©gorie</label><select class="form-select" id="newBankCat"><option>Histoire</option><option>G√©ographie</option><option>EMC</option><option>R√©vision</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalNewBank')">Annuler</button><button class="btn btn-primary" onclick="saveBank()">‚úì Cr√©er</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalConfirmDelete">
        <div class="modal">
            <div class="modal-header"><h2>üóëÔ∏è Confirmer la suppression</h2><button class="modal-close" onclick="closeModal('modalConfirmDelete')">‚úï</button></div>
            <div class="modal-body"><p id="deleteConfirmText">√ätes-vous s√ªr ?</p></div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalConfirmDelete')">Annuler</button><button class="btn btn-primary" style="background:var(--danger);" onclick="confirmDelete()">üóëÔ∏è Supprimer</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="modalHelp">
        <div class="modal lg">
            <div class="modal-header"><h2>‚ùì Aide - Formats & Exercices</h2><button class="modal-close" onclick="closeModal('modalHelp')">‚úï</button></div>
            <div class="modal-body">
                <h3 style="margin-bottom:16px;">üì¶ 5 formats de donn√©es</h3>
                <table style="margin-bottom:24px;"><thead><tr><th>Format</th><th>Champs</th><th>Exercices</th></tr></thead><tbody>
                    <tr><td><span class="badge badge-event">√âv√©nement</span></td><td>Date + √âv√©nement</td><td>Frise, Timeline, QCM</td></tr>
                    <tr><td><span class="badge badge-qr">Question-R√©ponse</span></td><td>Question + R√©ponse + Tag</td><td>Question ouverte, QCM</td></tr>
                    <tr><td><span class="badge badge-zone">Zone</span></td><td>Image + Consigne + X/Y</td><td>Carte cliquable</td></tr>
                    <tr><td><span class="badge badge-dictee">Dict√©e</span></td><td>Texte (audio auto)</td><td>Dict√©e</td></tr>
                    <tr><td><span class="badge badge-erreur">Erreur</span></td><td>Phrase + Mot + Correction</td><td>Trouve l'erreur</td></tr>
                </tbody></table>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="closeModal('modalHelp')">Compris !</button></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <!-- SCRIPTS -->
    <script src="/Activit-s-interactives_2nd-bac-pro/js/auth.js"></script>
    <script>
        // ===== V√âRIFICATION AUTH =====
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireAuth({ requireProf: true })) {
                return;
            }
            loadAllData();
        });

        // ===== CONFIG =====
        const SHEET_ID = '1zn0MzEEz-nq-KoVSqghztMA_JZV36PECO4h35xM9or8';
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzyqkUjiZBuS7MR-fo9qbb2Vrbw7JuIuBXczzNIT0qXUE6BZUu9XmJ3zVR-UmzC8SCQ/exec';

        let banques = [], elements = [], evaluations = [], exercices = [];
        let selectedBanque = null, selectedFormat = 'Evenement', selectedTag = 'Personnage', selectedExerciseType = 'frise';
        let currentEval = null, currentEvalExercises = [], deleteTarget = null;

        const exerciseFormats = { frise: ['Evenement'], timeline: ['Evenement'], qcm: ['Evenement', 'QuestionReponse'], ouverte: ['QuestionReponse'], carte: ['Zone'], image: ['QuestionReponse'], dictee: ['Dictee'], erreur: ['Erreur'] };
        const exerciseNames = { frise: 'Frise chronologique', timeline: 'Timeline', qcm: 'QCM', ouverte: 'Question ouverte', carte: 'Carte cliquable', image: 'Identification image', dictee: 'Dict√©e', erreur: "Trouve l'erreur" };
        const exerciseIcons = { frise: '‚è±Ô∏è', timeline: 'üîÄ', qcm: 'üéØ', ouverte: '‚ùì', carte: 'üó∫Ô∏è', image: 'üñºÔ∏è', dictee: 'üéß', erreur: 'üîç' };

        // ===== FONCTION loadSheet CORRIG√âE =====
        // En-t√™tes fixes pour chaque onglet (Google ne renvoie pas toujours les labels)
        const SHEET_HEADERS = {
            'BANQUES QUESTIONS': ['ID', 'Nom', 'Cat√©gorie', 'Statut'],
            'ELEMENTS': ['ID', 'Banque', 'Format', 'Date', 'Evenement', 'Question', 'Reponse', 'Image', 'Tag', 'Texte', 'Phrase', 'MotErrone', 'Correction', 'X', 'Y', 'Rayon', 'Statut'],
            'EVALUATIONS': ['ID', 'Nom', 'Description', 'Type', 'Duree', 'Seuil', 'Tentatives', 'Affichage', 'Ouverture', 'Fermeture', 'Statut'],
            'EXERCICES': ['ID', 'EvalID', 'Ordre', 'Type', 'Mode', 'Nombre', 'Banque', 'Selection', 'Config']
        };
        
        async function loadSheet(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
            try {
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                if (!json.table || !json.table.rows || json.table.rows.length === 0) return [];
                
                // Utiliser les en-t√™tes fixes
                const headers = SHEET_HEADERS[sheetName] || [];
                if (headers.length === 0) {
                    console.warn('Pas d\'en-t√™tes d√©finis pour', sheetName);
                    return [];
                }
                
                // V√©rifier si la premi√®re ligne est une ligne d'en-t√™tes ou de donn√©es
                const firstRow = json.table.rows[0];
                const firstCellValue = firstRow.c[0] ? (firstRow.c[0].v || '').toString().trim() : '';
                
                // Si la premi√®re cellule est "ID" ou similaire, c'est la ligne d'en-t√™tes, on la saute
                const startIndex = (firstCellValue === 'ID' || firstCellValue === 'id') ? 1 : 0;
                
                // Convertir les lignes en objets
                return json.table.rows.slice(startIndex).map(row => {
                    const obj = {};
                    if (row.c) {
                        row.c.forEach((cell, i) => {
                            if (headers[i]) {
                                obj[headers[i]] = cell ? (cell.v !== null && cell.v !== undefined ? cell.v : '') : '';
                            }
                        });
                    }
                    return obj;
                }).filter(row => {
                    // Filtrer les lignes vides (pas d'ID ou ID vide)
                    const id = row.ID || row.Id || row.id || '';
                    return id.toString().trim() !== '';
                });
            } catch (e) { 
                console.error('Erreur chargement', sheetName, e); 
                return []; 
            }
        }

        async function loadAllData() {
            showToast('Chargement...');
            banques = await loadSheet('BANQUES QUESTIONS');
            elements = await loadSheet('ELEMENTS');
            evaluations = await loadSheet('EVALUATIONS');
            exercices = await loadSheet('EXERCICES');
            console.log('Banques charg√©es:', banques);
            console.log('Elements charg√©s:', elements);
            document.getElementById('navBankCount').textContent = banques.length;
            document.getElementById('navEvalCount').textContent = evaluations.length;
            renderBanks(); renderEvaluations(); updateBanqueSelect(); updateExoBanquesCheckboxes();
            showToast('‚úì Donn√©es charg√©es !');
        }

        function renderBanks() {
            const container = document.getElementById('banksList');
            if (banques.length === 0) { container.innerHTML = '<div class="empty"><div class="icon">üì≠</div><p>Aucune banque</p></div>'; return; }
            container.innerHTML = banques.map(b => {
                const count = elements.filter(e => e.Banque === b.ID).length;
                const icons = { Histoire: 'üìú', G√©ographie: 'üåç', EMC: '‚öñÔ∏è', R√©vision: 'üîÑ' };
                const cat = b['Cat√©gorie'] || b.Categorie || '';
                return `<div class="list-item ${selectedBanque === b.ID ? 'active' : ''}" onclick="selectBanque('${b.ID}')"><div class="list-icon">${icons[cat] || 'üìÇ'}</div><div class="list-info"><h4>${b.Nom || b.ID}</h4><p>${cat} ‚Ä¢ ${count} √©l√©ments</p></div></div>`;
            }).join('');
        }

        function selectBanque(id) { selectedBanque = id; renderBanks(); renderElements(); }

        function renderElements() {
            const container = document.getElementById('elementsList'), title = document.getElementById('elementsTitle'), filters = document.getElementById('elementsFilters'), btnAdd = document.getElementById('btnAddElement');
            if (!selectedBanque) { container.innerHTML = '<div class="empty"><div class="icon">üëà</div><p>S√©lectionnez une banque √† gauche</p></div>'; filters.style.display = 'none'; btnAdd.style.display = 'none'; return; }
            const banque = banques.find(b => b.ID === selectedBanque);
            title.textContent = banque ? banque.Nom : selectedBanque;
            btnAdd.style.display = 'block';
            const bankElements = elements.filter(e => e.Banque === selectedBanque);
            const formats = [...new Set(bankElements.map(e => e.Format))];
            filters.style.display = 'flex';
            filters.innerHTML = `<button class="filter-btn active" onclick="filterElements('')">Tous (${bankElements.length})</button>${formats.map(f => `<button class="filter-btn" onclick="filterElements('${f}')">${formatIcon(f)} ${f} (${bankElements.filter(e => e.Format === f).length})</button>`).join('')}`;
            renderElementsList(bankElements);
        }

        function filterElements(format) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            let bankElements = elements.filter(e => e.Banque === selectedBanque);
            if (format) bankElements = bankElements.filter(e => e.Format === format);
            renderElementsList(bankElements);
        }

        function renderElementsList(list) {
            const container = document.getElementById('elementsList');
            if (list.length === 0) { container.innerHTML = '<div class="empty"><div class="icon">üì≠</div><p>Aucun √©l√©ment</p></div>'; return; }
            container.innerHTML = list.map(e => {
                const iconClass = (e.Format || '').toLowerCase().replace('questionreponse', 'qr');
                let content = '';
                if (e.Format === 'Evenement') content = `<span class="element-date">${e.Date || ''}</span><div class="element-text">${e.Evenement || ''}</div>`;
                else if (e.Format === 'QuestionReponse') content = `<div class="element-text">${e.Question || ''}<div class="element-sub">‚Üí ${e.Reponse || ''}</div></div>`;
                else if (e.Format === 'Dictee') content = `<div class="element-text">${e.Texte || ''}<div class="element-sub">üîä Audio auto</div></div>`;
                else if (e.Format === 'Erreur') content = `<div class="element-text">${e.Phrase || ''}<div class="element-sub">${e.MotErrone || ''} ‚Üí ${e.Correction || ''}</div></div>`;
                else if (e.Format === 'Zone') content = `<div class="element-text">${e.Question || 'Zone'}<div class="element-sub">üìç (${e.X || 0}, ${e.Y || 0})</div></div>`;
                return `<div class="element-row"><div class="element-icon ${iconClass}">${formatIcon(e.Format)}</div><div class="element-content">${content}</div><span class="badge badge-${iconClass}">${e.Tag || e.Format}</span><button class="btn-icon danger" onclick="prepareDelete('element','${e.ID}')">üóëÔ∏è</button></div>`;
            }).join('');
        }

        function formatIcon(format) { return { Evenement: 'üìÖ', QuestionReponse: '‚ùì', Zone: 'üó∫Ô∏è', Dictee: 'üéß', Erreur: 'üîç' }[format] || 'üìÑ'; }

        function renderEvaluations() {
            const container = document.getElementById('evalsList');
            if (evaluations.length === 0) { container.innerHTML = '<tr><td colspan="6" class="empty"><div class="icon">üì≠</div><p>Aucune √©valuation</p></td></tr>'; return; }
            container.innerHTML = evaluations.map(e => {
                const exCount = exercices.filter(ex => ex.EvalID === e.ID).length;
                const duree = e.Dur√©e || e.Duree || '-';
                return `<tr><td><strong>${e.Nom || e.ID}</strong><br><span style="font-size:12px;color:var(--text-muted)">${e.Description || ''}</span></td><td>${exCount}</td><td>${duree} min</td><td>${e.Seuil || '-'}%</td><td><span class="badge ${e.Statut === 'Publie' ? 'badge-success' : 'badge-warning'}">${e.Statut || 'Brouillon'}</span></td><td><button class="btn-icon" onclick="editEval('${e.ID}')">‚úèÔ∏è</button><button class="btn-icon danger" onclick="prepareDelete('eval','${e.ID}')">üóëÔ∏è</button></td></tr>`;
            }).join('');
        }

        function updateBanqueSelect() {
            const select = document.getElementById('elementBanque');
            select.innerHTML = banques.length === 0 ? '<option value="">-- Cr√©ez une banque --</option>' : banques.map(b => `<option value="${b.ID}">${b.Nom || b.ID}</option>`).join('');
        }

        function updateExoBanquesCheckboxes() {
            const container = document.getElementById('exoBanques');
            const requiredFormats = exerciseFormats[selectedExerciseType] || [];
            const compatibleBanks = banques.filter(b => elements.filter(e => e.Banque === b.ID).some(e => requiredFormats.includes(e.Format)));
            if (compatibleBanks.length === 0) { container.innerHTML = `<div style="padding:16px;color:var(--text-muted);font-size:13px;">‚ö†Ô∏è Aucune banque compatible</div>`; return; }
            container.innerHTML = compatibleBanks.map(b => {
                const count = elements.filter(e => e.Banque === b.ID && requiredFormats.includes(e.Format)).length;
                return `<div class="bank-check"><input type="checkbox" id="bank_${b.ID}" value="${b.ID}"><label for="bank_${b.ID}">${b.Nom || b.ID}</label><span class="count">${count}</span></div>`;
            }).join('');
        }

        function showPage(pageId) {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + pageId).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navMap = { banks: 0, 'new-element': 1, evaluations: 2, 'new-eval': 3, 'edit-eval': 2 };
            const navItems = document.querySelectorAll('.sidebar nav .nav-item:not(.nav-back)');
            if (navMap[pageId] !== undefined && navItems[navMap[pageId]]) navItems[navMap[pageId]].classList.add('active');
        }

        function goToStep2() {
            const nom = document.getElementById('evalNom').value;
            const numLecon = document.getElementById('evalNumLecon').value;
            if (!nom) { showToast('Entrez un nom', true); return; }
            if (!numLecon) { showToast('Entrez un num√©ro de le√ßon (ex: L4)', true); return; }
            currentEval = { 
                ID: currentEval?.ID || 'EVAL' + Date.now(), 
                Nom: nom, 
                Description: document.getElementById('evalDesc').value,
                Type: document.getElementById('evalType').value,
                Duree: document.getElementById('evalDuree').value, 
                Seuil: document.getElementById('evalSeuil').value, 
                Tentatives: document.getElementById('evalTentatives').value, 
                Affichage: document.getElementById('evalAffichage').value, 
                Statut: 'Brouillon',
                NumLecon: numLecon,
                Matiere: document.getElementById('evalMatiere').value
            };
            document.getElementById('editEvalTitle').textContent = currentEval.Nom;
            showPage('edit-eval');
            renderEvalExercises();
        }

        function backToStep1() {
            showPage('new-eval');
            if (currentEval) { 
                document.getElementById('evalNom').value = currentEval.Nom || ''; 
                document.getElementById('evalDesc').value = currentEval.Description || ''; 
                document.getElementById('evalDuree').value = currentEval.Duree || 15; 
                document.getElementById('evalSeuil').value = currentEval.Seuil || 80; 
                document.getElementById('evalNumLecon').value = currentEval.NumLecon || '';
                document.getElementById('evalMatiere').value = currentEval.Matiere || 'Histoire';
                document.getElementById('evalType').value = currentEval.Type || 'entrainement';
            }
        }

        function editEval(evalId) {
            const ev = evaluations.find(e => e.ID === evalId);
            if (!ev) return;
            currentEval = { ...ev };
            currentEvalExercises = exercices.filter(ex => ex.EvalID === evalId).map(ex => ({...ex}));
            document.getElementById('evalNom').value = ev.Nom || '';
            document.getElementById('evalDesc').value = ev.Description || '';
            document.getElementById('evalDuree').value = ev.Dur√©e || ev.Duree || 15;
            document.getElementById('evalSeuil').value = ev.Seuil || 80;
            document.getElementById('editEvalTitle').textContent = ev.Nom;
            showPage('edit-eval');
            renderEvalExercises();
        }

        function selectExerciseType(el, type) {
            document.querySelectorAll('.exercise-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedExerciseType = type;
            updateExoBanquesCheckboxes();
        }

        function addExerciseToEval() {
            const nombre = document.getElementById('exoNombre').value;
            const selection = document.getElementById('exoSelection').value;
            const selectedBanks = [];
            document.querySelectorAll('#exoBanques input:checked').forEach(cb => selectedBanks.push(cb.value));
            if (selectedBanks.length === 0) { showToast('S√©lectionnez une banque', true); return; }
            currentEvalExercises.push({ 
                ID: 'EX' + Date.now(), 
                EvalID: currentEval.ID, 
                Ordre: currentEvalExercises.length + 1, 
                Type: selectedExerciseType, 
                Mode: selection, 
                Nombre: nombre, 
                Banque: selectedBanks.join(','),
                Selection: '', 
                Config: '' 
            });
            renderEvalExercises();
            showToast('‚úì Exercice ajout√© !');
            document.querySelectorAll('#exoBanques input:checked').forEach(cb => cb.checked = false);
        }

        function renderEvalExercises() {
            const container = document.getElementById('evalExercisesList');
            document.getElementById('exerciseCount').textContent = currentEvalExercises.length;
            if (currentEvalExercises.length === 0) { container.innerHTML = '<div class="empty" style="padding:40px;"><div class="icon">üì≠</div><p>Aucun exercice</p></div>'; return; }
            container.innerHTML = currentEvalExercises.map((ex, i) => {
                const banqueField = ex.Banque || ex.Banques || '';
                const bankNames = banqueField.split(',').map(id => { const b = banques.find(b => b.ID === id); return b ? b.Nom : id; }).join(', ');
                return `<div class="exercise-item"><div class="order">${i + 1}</div><div class="info"><h4>${exerciseIcons[ex.Type]} ${exerciseNames[ex.Type]}</h4><p>${ex.Nombre} questions ‚Ä¢ ${bankNames}</p></div><div class="actions"><button class="btn-icon" onclick="moveExercise(${i},-1)" ${i === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button><button class="btn-icon" onclick="moveExercise(${i},1)" ${i === currentEvalExercises.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button><button class="btn-icon danger" onclick="removeExercise(${i})">üóëÔ∏è</button></div></div>`;
            }).join('');
        }

        function moveExercise(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentEvalExercises.length) return;
            [currentEvalExercises[index], currentEvalExercises[newIndex]] = [currentEvalExercises[newIndex], currentEvalExercises[index]];
            currentEvalExercises.forEach((ex, i) => ex.Ordre = i + 1);
            renderEvalExercises();
        }

        function removeExercise(index) { currentEvalExercises.splice(index, 1); currentEvalExercises.forEach((ex, i) => ex.Ordre = i + 1); renderEvalExercises(); }

        async function saveEvalAsDraft() { await saveEvaluation('Brouillon'); }
        async function publishEval() { if (currentEvalExercises.length === 0) { showToast('Ajoutez un exercice', true); return; } await saveEvaluation('Publie'); }

        async function saveEvaluation(statut) {
            currentEval.Statut = statut;
            showToast('Enregistrement...');
            try {
                const existingEval = evaluations.find(e => e.ID === currentEval.ID);
                if (existingEval) {
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'EVALUATIONS', action: 'delete', id: currentEval.ID }) });
                    for (const ex of exercices.filter(e => e.EvalID === currentEval.ID)) {
                        await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'EXERCICES', action: 'delete', id: ex.ID }) });
                    }
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'MENU_CONN', action: 'deleteByEvalId', evalId: currentEval.ID }) });
                }
                
                await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ 
                    sheet: 'EVALUATIONS', 
                    action: 'add', 
                    row: [
                        currentEval.ID, 
                        currentEval.Nom, 
                        currentEval.Description, 
                        currentEval.Type,
                        currentEval.Duree, 
                        currentEval.Seuil, 
                        currentEval.Tentatives, 
                        currentEval.Affichage, 
                        '', 
                        '', 
                        currentEval.Statut
                    ] 
                }) });
                
                for (const ex of currentEvalExercises) {
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ 
                        sheet: 'EXERCICES', 
                        action: 'add', 
                        row: [
                            ex.ID, 
                            ex.EvalID, 
                            ex.Ordre, 
                            ex.Type, 
                            ex.Mode, 
                            ex.Nombre, 
                            ex.Banque,
                            ex.Selection || '', 
                            ex.Config || ''
                        ] 
                    }) });
                }
                
                if (statut === 'Publie') {
                    const existingForLecon = await getExistingNumExoForLecon(currentEval.NumLecon);
                    const numExo = existingForLecon + 1;
                    
                    const menuRow = [
                        currentEval.NumLecon,
                        numExo,
                        currentEval.Description || currentEval.Nom,
                        currentEval.Nom,
                        currentEval.Matiere,
                        'disponible',
                        currentEval.Type,
                        currentEval.ID
                    ];
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'MENU_CONN', action: 'add', row: menuRow }) });
                    showToast(`‚úì Publi√© dans ${currentEval.Type === 'evaluation' ? '√âvaluations' : 'Entra√Ænements'} !`);
                }
                
                if (existingEval) { 
                    const idx = evaluations.findIndex(e => e.ID === currentEval.ID); 
                    evaluations[idx] = { ...currentEval }; 
                    exercices = exercices.filter(e => e.EvalID !== currentEval.ID); 
                } else { 
                    evaluations.push({ ...currentEval }); 
                }
                exercices.push(...currentEvalExercises);
                document.getElementById('navEvalCount').textContent = evaluations.length;
                renderEvaluations();
                if (statut !== 'Publie') showToast(`‚úì √âvaluation enregistr√©e !`);
                currentEval = null; currentEvalExercises = [];
                document.getElementById('evalNom').value = ''; document.getElementById('evalDesc').value = ''; document.getElementById('evalNumLecon').value = '';
                showPage('evaluations');
            } catch (e) { console.error(e); showToast('Erreur', true); }
        }
        
        async function getExistingNumExoForLecon(numLecon) {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=MENU_CONN`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                if (!json.table || !json.table.rows) return 0;
                
                let maxNumExo = 0;
                json.table.rows.forEach(row => {
                    const rowNumLecon = row.c[0]?.v || '';
                    const rowNumExo = parseInt(row.c[1]?.v) || 0;
                    if (String(rowNumLecon).trim() === numLecon && rowNumExo > maxNumExo) {
                        maxNumExo = rowNumExo;
                    }
                });
                return maxNumExo;
            } catch (e) { 
                console.error('Erreur getExistingNumExoForLecon:', e); 
                return 0; 
            }
        }

        function selectFormat(el, format) {
            document.querySelectorAll('.format-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedFormat = format;
            ['Evenement', 'QuestionReponse', 'Zone', 'Dictee', 'Erreur'].forEach(f => document.getElementById('form' + f).style.display = f === format ? 'block' : 'none');
        }

        function selectTag(el) { document.querySelectorAll('.tag-opt').forEach(t => t.classList.remove('selected')); el.classList.add('selected'); selectedTag = el.textContent; }
        function playDictee() { const text = document.getElementById('dicteeTexte').value || 'Test dict√©e.'; const u = new SpeechSynthesisUtterance(text); u.lang = 'fr-FR'; speechSynthesis.speak(u); }

        async function saveBank() {
            const nom = document.getElementById('newBankNom').value, cat = document.getElementById('newBankCat').value;
            if (!nom) { showToast('Entrez un nom', true); return; }
            const id = nom.replace(/[^a-zA-Z0-9]/g, '').substring(0, 10).toUpperCase() + Date.now().toString().slice(-4);
            showToast('Enregistrement...');
            try {
                await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'BANQUES QUESTIONS', action: 'add', row: [id, nom, cat, 'Actif'] }) });
                banques.push({ ID: id, Nom: nom, 'Cat√©gorie': cat, Statut: 'Actif' });
                document.getElementById('navBankCount').textContent = banques.length;
                renderBanks(); updateBanqueSelect(); updateExoBanquesCheckboxes();
                closeModal('modalNewBank');
                showToast('‚úì Banque cr√©√©e !');
                document.getElementById('newBankNom').value = '';
            } catch (e) { console.error(e); showToast('Erreur', true); }
        }

        async function saveElement() {
            const banque = document.getElementById('elementBanque').value;
            if (!banque) { showToast('S√©lectionnez une banque', true); return; }
            const id = 'E' + Date.now();
            const element = { ID: id, Banque: banque, Format: selectedFormat, Statut: 'Actif' };
            let row = [id, banque, selectedFormat, '', '', '', '', '', '', '', '', '', '', '', '', '', 'Actif'];
            if (selectedFormat === 'Evenement') { element.Date = document.getElementById('eventDate').value; element.Evenement = document.getElementById('eventText').value; if (!element.Date || !element.Evenement) { showToast('Remplissez tous les champs', true); return; } row[3] = element.Date; row[4] = element.Evenement; }
            else if (selectedFormat === 'QuestionReponse') { element.Question = document.getElementById('qrQuestion').value; element.Reponse = document.getElementById('qrReponse').value; element.Tag = selectedTag; if (!element.Question || !element.Reponse) { showToast('Remplissez tous les champs', true); return; } row[5] = element.Question; row[6] = element.Reponse; row[8] = element.Tag; }
            else if (selectedFormat === 'Dictee') { element.Texte = document.getElementById('dicteeTexte').value; if (!element.Texte) { showToast('Entrez le texte', true); return; } row[9] = element.Texte; }
            else if (selectedFormat === 'Erreur') { element.Phrase = document.getElementById('erreurPhrase').value; element.MotErrone = document.getElementById('erreurMot').value; element.Correction = document.getElementById('erreurCorrection').value; if (!element.Phrase || !element.MotErrone || !element.Correction) { showToast('Remplissez tous les champs', true); return; } row[10] = element.Phrase; row[11] = element.MotErrone; row[12] = element.Correction; }
            else if (selectedFormat === 'Zone') { element.Image = document.getElementById('zoneImage').value; element.Question = document.getElementById('zoneConsigne').value; element.X = document.getElementById('zoneX').value; element.Y = document.getElementById('zoneY').value; element.Rayon = document.getElementById('zoneRayon').value; row[5] = element.Question; row[7] = element.Image; row[13] = element.X; row[14] = element.Y; row[15] = element.Rayon; }
            showToast('Enregistrement...');
            try {
                await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'ELEMENTS', action: 'add', row: row }) });
                elements.push(element);
                showToast('‚úì √âl√©ment ajout√© !');
                document.querySelectorAll('#page-new-element .form-input, #page-new-element .form-textarea').forEach(el => { if (!['elementBanque', 'zoneRayon'].includes(el.id)) el.value = ''; });
                showPage('banks'); selectBanque(banque); updateExoBanquesCheckboxes();
            } catch (e) { console.error(e); showToast('Erreur', true); }
        }

        function prepareDelete(type, id) {
            deleteTarget = { type, id };
            document.getElementById('deleteConfirmText').textContent = type === 'eval' ? `Supprimer l'√©valuation "${evaluations.find(e => e.ID === id)?.Nom || id}" ?` : 'Supprimer cet √©l√©ment ?';
            openModal('modalConfirmDelete');
        }

        async function confirmDelete() {
            if (!deleteTarget) return;
            closeModal('modalConfirmDelete');
            showToast('Suppression...');
            try {
                if (deleteTarget.type === 'element') {
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'ELEMENTS', action: 'delete', id: deleteTarget.id }) });
                    elements = elements.filter(e => e.ID !== deleteTarget.id);
                    renderElements(); updateExoBanquesCheckboxes();
                } else if (deleteTarget.type === 'eval') {
                    await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'EVALUATIONS', action: 'delete', id: deleteTarget.id }) });
                    for (const ex of exercices.filter(ex => ex.EvalID === deleteTarget.id)) {
                        await fetch(WEBAPP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet: 'EXERCICES', action: 'delete', id: ex.ID }) });
                    }
                    evaluations = evaluations.filter(e => e.ID !== deleteTarget.id);
                    exercices = exercices.filter(ex => ex.EvalID !== deleteTarget.id);
                    document.getElementById('navEvalCount').textContent = evaluations.length;
                    renderEvaluations();
                }
                showToast('‚úì Supprim√© !');
            } catch (e) { console.error(e); showToast('Erreur', true); }
            deleteTarget = null;
        }

        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
        document.querySelectorAll('.modal-overlay').forEach(o => { o.onclick = e => { if (e.target === o) o.classList.remove('visible'); }; });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast visible' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }
    </script>

</body>
</html>
