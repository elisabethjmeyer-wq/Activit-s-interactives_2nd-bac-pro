<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercice Connaissances | Espace cours</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --primary-dark: #4f46e5; --primary-bg: #eef2ff;
            --accent-yellow: #f59e0b; --accent-yellow-light: #fef3c7;
            --accent-green: #10b981; --accent-green-light: #d1fae5;
            --accent-red: #ef4444; --accent-red-light: #fee2e2;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
            --gray-400: #9ca3af; --gray-500: #6b7280; --gray-600: #4b5563; --gray-700: #374151;
            --gray-800: #1f2937; --gray-900: #111827;
            --sidebar-width: 260px; --header-height: 64px;
            --radius: 12px; --radius-lg: 16px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--gray-100); color: var(--gray-800); line-height: 1.5; overflow-x: hidden; min-height: 100vh; }
        .header { background: white; border-bottom: 1px solid var(--gray-200); position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); z-index: 100; }
        .header-inner { height: 100%; padding: 0 20px; display: flex; align-items: center; gap: 16px; }
        .menu-toggle { width: 42px; height: 42px; background: var(--gray-100); border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--gray-600); transition: all 0.2s; }
        .menu-toggle:hover { background: var(--primary-bg); color: var(--primary); }
        .menu-toggle.active { background: var(--primary); color: white; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--gray-800); }
        .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .logo-text { font-weight: 700; font-size: 16px; }
        .logo-text span { color: var(--gray-400); font-weight: 500; }
        .sidebar { width: var(--sidebar-width); background: white; border-right: 1px solid var(--gray-200); position: fixed; top: var(--header-height); left: 0; bottom: 0; overflow-y: auto; transition: transform 0.3s ease; z-index: 50; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar-inner { padding: 16px 12px; }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 10px; text-decoration: none; color: var(--gray-700); font-size: 14px; font-weight: 500; transition: all 0.15s; }
        .sidebar-item:hover, .sidebar-item.active { background: var(--primary-bg); color: var(--primary); }
        .sidebar-item .item-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; background: var(--gray-100); transition: all 0.15s; }
        .sidebar-item:hover .item-icon, .sidebar-item.active .item-icon { background: var(--primary); color: white; }
        .main { margin-left: var(--sidebar-width); padding: 24px; padding-top: calc(var(--header-height) + 24px); transition: margin-left 0.3s ease; min-height: 100vh; }
        .sidebar.collapsed ~ .main { margin-left: 0; }
        .main-inner { max-width: 900px; margin: 0 auto; }
        .breadcrumb { display: flex; align-items: center; gap: 8px; margin-bottom: 24px; font-size: 14px; flex-wrap: wrap; }
        .breadcrumb a { color: var(--gray-500); text-decoration: none; }
        .breadcrumb a:hover { color: var(--primary); }
        .breadcrumb .separator { color: var(--gray-300); }
        .breadcrumb .current { color: var(--gray-800); font-weight: 600; }
        .page-header { margin-bottom: 24px; }
        .page-header h1 { font-size: 26px; font-weight: 800; margin-bottom: 6px; display: flex; align-items: center; gap: 12px; }
        .page-header p { color: var(--gray-500); font-size: 15px; }
        .timer-box { background: linear-gradient(135deg, var(--accent-yellow), #fbbf24); color: white; border-radius: var(--radius); padding: 16px; margin-bottom: 16px; text-align: center; font-size: 22px; font-weight: bold; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .timer-box.warning { background: linear-gradient(135deg, var(--accent-red), #dc2626); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .steps-breadcrumb { background: white; border-radius: var(--radius); padding: 12px 16px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; box-shadow: var(--shadow); }
        .steps-breadcrumb .step-label { font-size: 13px; color: var(--gray-500); font-weight: 500; }
        .steps-breadcrumb .step-item { font-size: 13px; color: var(--gray-400); padding: 6px 12px; border-radius: 20px; cursor: pointer; border: none; background: none; font-family: inherit; transition: all 0.2s; }
        .steps-breadcrumb .step-item:hover { background: var(--gray-100); color: var(--gray-600); }
        .steps-breadcrumb .step-item.active { background: var(--primary-bg); color: var(--primary); font-weight: 600; }
        .steps-breadcrumb .step-item.completed { color: var(--accent-green); }
        .steps-breadcrumb .step-item.completed::before { content: "‚úì "; }
        .steps-breadcrumb .step-separator { color: var(--gray-300); }
        .instructions { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 24px; border-left: 4px solid var(--primary); box-shadow: var(--shadow); }
        .instructions strong { color: var(--primary); }
        .instructions p { color: var(--gray-600); margin-top: 8px; line-height: 1.6; }
        .exercise-card { background: white; border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-md); border: 2px solid var(--gray-200); margin-bottom: 24px; }
        .exercise-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-100); }
        .exercise-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; background: var(--primary-bg); }
        .exercise-title h2 { font-size: 18px; font-weight: 700; color: var(--gray-800); }
        .exercise-title p { font-size: 13px; color: var(--gray-500); }
        .timeline-instruction { text-align: center; padding: 16px; background: var(--accent-yellow-light); border-radius: var(--radius); margin-bottom: 24px; color: #92400e; font-weight: 500; }
        .timeline-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
        .timeline-item { display: flex; align-items: center; gap: 16px; background: white; border: 2px solid var(--gray-200); border-radius: var(--radius); padding: 16px; cursor: grab; transition: all 0.2s; user-select: none; }
        .timeline-item:hover { border-color: var(--primary-light); box-shadow: var(--shadow-md); }
        .timeline-item.dragging { opacity: 0.5; border-color: var(--primary); background: var(--primary-bg); }
        .timeline-item .drag-handle { color: var(--gray-400); font-size: 20px; }
        .timeline-item .item-content { flex: 1; }
        .timeline-item .item-text { font-size: 15px; font-weight: 500; color: var(--gray-700); }
        .timeline-item .item-date { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .timeline-item .order-number { width: 32px; height: 32px; background: var(--gray-100); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--gray-500); font-size: 14px; }
        .timeline-item.correct { border-color: var(--accent-green); background: var(--accent-green-light); }
        .timeline-item.correct .item-date { color: var(--accent-green); }
        .timeline-item.incorrect { border-color: var(--accent-red); background: var(--accent-red-light); }
        .timeline-item.incorrect .item-date { color: var(--accent-red); }
        .frise-instruction { text-align: center; padding: 16px; background: var(--primary-bg); border-radius: var(--radius); margin-bottom: 24px; color: var(--primary-dark); font-weight: 500; }
        .frise-events { display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin-bottom: 24px; }
        .frise-event { background: white; border: 2px solid var(--gray-200); border-radius: var(--radius); padding: 12px 16px; cursor: grab; transition: all 0.2s; user-select: none; min-width: 150px; text-align: center; }
        .frise-event:hover { border-color: var(--primary); box-shadow: var(--shadow-md); }
        .frise-event.dragging { opacity: 0.5; cursor: grabbing; }
        .frise-event .event-text { font-size: 14px; font-weight: 500; color: var(--gray-700); }
        .frise-dropzones { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
        .frise-dropzone { flex: 1; min-width: 150px; padding: 16px; border: 2px dashed var(--gray-300); border-radius: var(--radius); min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; }
        .frise-dropzone.drag-over { border-color: var(--primary); background: var(--primary-bg); }
        .frise-dropzone .date-label { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .frise-dropzone .drop-hint { font-size: 12px; color: var(--gray-400); }
        .frise-dropzone.has-event .drop-hint { display: none; }
        .frise-dropzone .placed-event { background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; }
        .frise-dropzone.correct { border-color: var(--accent-green); background: var(--accent-green-light); }
        .frise-dropzone.incorrect { border-color: var(--accent-red); background: var(--accent-red-light); }
        .buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        .buttons button { flex: 1; min-width: 150px; padding: 14px; border: none; border-radius: var(--radius); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow); font-family: inherit; }
        .buttons button:hover { transform: translateY(-2px); }
        .btn-verify { background: linear-gradient(135deg, var(--accent-green), #34d399); color: white; }
        .btn-solution { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .btn-restart { background: linear-gradient(135deg, var(--gray-500), var(--gray-400)); color: white; }
        .result { background: var(--accent-green-light); border: 2px solid var(--accent-green); border-radius: var(--radius); padding: 20px; margin-top: 20px; display: none; }
        .result.show { display: block; }
        .result h3 { color: #065f46; margin-bottom: 8px; }
        .result p { color: #047857; }
        .nav-exercices { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 20px; background: white; border-radius: var(--radius); box-shadow: var(--shadow); }
        .nav-btn { display: flex; align-items: center; gap: 8px; padding: 12px 20px; border: none; border-radius: var(--radius); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; font-family: inherit; }
        .nav-btn.prev { background: var(--gray-100); color: var(--gray-700); }
        .nav-btn.prev:hover { background: var(--gray-200); }
        .nav-btn.next { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .nav-btn.next:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .nav-btn.menu { background: var(--gray-100); color: var(--gray-600); }
        .nav-btn.menu:hover { background: var(--primary-bg); color: var(--primary); }
        .nav-info { text-align: center; color: var(--gray-500); font-size: 13px; }
        .loading { text-align: center; padding: 60px 20px; color: var(--gray-500); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { background: var(--accent-red-light); border: 2px solid var(--accent-red); border-radius: var(--radius); padding: 20px; text-align: center; color: #991b1b; }
        .error-message a { color: #991b1b; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .overlay.visible { opacity: 1; pointer-events: auto; }
        @media (max-width: 768px) {
            .sidebar { z-index: 60; }
            .main { margin-left: 0; }
            .buttons button { min-width: 100%; }
            .nav-exercices { flex-direction: column; gap: 10px; }
            .nav-btn { width: 100%; justify-content: center; }
            .frise-dropzones { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <header class="header">
        <div class="header-inner">
            <button class="menu-toggle" id="menuToggle" title="Afficher/Masquer le menu">‚ò∞</button>
            <a href="/Activit-s-interactives_2nd-bac-pro/index.html" class="logo">
                <div class="logo-icon">üìö</div>
                <div class="logo-text">Espace cours <span>‚Ä¢ Mme Meyer</span></div>
            </a>
        </div>
    </header>
    <aside class="sidebar collapsed" id="sidebar">
        <div class="sidebar-inner" id="sidebarContent"></div>
    </aside>
    <main class="main">
        <div class="main-inner">
            <nav class="breadcrumb">
                <a href="/Activit-s-interactives_2nd-bac-pro/index.html">üè† Accueil</a>
                <span class="separator">‚Ä∫</span>
                <a href="/Activit-s-interactives_2nd-bac-pro/pages/entrainement-connaissances.html" id="menuLink">Entra√Ænement Connaissances</a>
                <span class="separator">‚Ä∫</span>
                <span class="current" id="breadcrumbCurrent">Exercice</span>
            </nav>
            <div class="page-header">
                <h1 id="pageTitle">‚úÖ Exercice de Connaissances</h1>
                <p id="pageSubtitle">√âvaluation de connaissances</p>
            </div>
            <div id="content">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement de l'exercice...</p>
                </div>
            </div>
        </div>
    </main>
    <script>
        const BASE_PATH = '/Activit-s-interactives_2nd-bac-pro';
        const CURRENT_PAGE = 'entrainement-conn';
        const SHEET_ID = '1zn0MzEEz-nq-KoVSqghztMA_JZV36PECO4h35xM9or8';
        let evaluation = null, exercices = [], elements = [], currentStepIndex = 0, totalSteps = 0, timeLeft = 600, timerInterval = null, currentExerciseData = null, stepResults = [];
        let menuConnData = [], currentMenuEntry = null, lessonExercises = [], currentLessonIndex = 0;
        const sidebar = document.getElementById('sidebar'), menuToggle = document.getElementById('menuToggle'), overlay = document.getElementById('overlay');
        function toggleSidebar() {
            const isCollapsed = sidebar.classList.contains('collapsed');
            if (isCollapsed) { sidebar.classList.remove('collapsed'); menuToggle.classList.add('active'); overlay.classList.add('visible'); }
            else { sidebar.classList.add('collapsed'); menuToggle.classList.remove('active'); overlay.classList.remove('visible'); }
            localStorage.setItem('sidebarOpen', !sidebar.classList.contains('collapsed'));
        }
        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);
        if (localStorage.getItem('sidebarOpen') === 'true') { sidebar.classList.remove('collapsed'); menuToggle.classList.add('active'); }
        async function loadSidebar() {
            try {
                const response = await fetch(BASE_PATH + '/components/sidebar.html');
                if (!response.ok) throw new Error('Sidebar not found');
                document.getElementById('sidebarContent').innerHTML = await response.text();
                document.querySelectorAll('.sidebar-item').forEach(item => { if (item.dataset.page === CURRENT_PAGE) item.classList.add('active'); });
                document.querySelectorAll('.sidebar-item.disabled, .sidebar-item[href="#"]').forEach(link => { link.addEventListener('click', e => e.preventDefault()); });
            } catch (error) { console.error('Erreur chargement sidebar:', error); }
        }
        async function loadSheet(sheetName) {
            const url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?tqx=out:json&sheet=' + encodeURIComponent(sheetName);
            try {
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                if (!json.table || !json.table.rows) return [];
                const headers = json.table.cols.map(col => (col.label || '').trim());
                const rows = [];
                for (let i = 0; i < json.table.rows.length; i++) {
                    const row = json.table.rows[i];
                    if (!row || !row.c) continue;
                    const obj = {};
                    let hasData = false;
                    row.c.forEach((cell, idx) => { const header = headers[idx]; if (header) { const value = cell ? (cell.v ?? '') : ''; obj[header] = value; if (value !== '') hasData = true; } });
                    if (hasData) rows.push(obj);
                }
                return rows;
            } catch (e) { console.error('Erreur chargement', sheetName, e); return []; }
        }
        async function loadEvaluation(evalId) {
            try {
                menuConnData = await loadSheet('MENU_CONN');
                currentMenuEntry = menuConnData.find(m => m.EvalID === evalId);
                if (currentMenuEntry) {
                    const currentLesson = currentMenuEntry['NumLe√ßon'] || currentMenuEntry.NumLecon;
                    const currentType = String(currentMenuEntry.Type || '').toLowerCase();
                    lessonExercises = menuConnData.filter(m => { const mLesson = m['NumLe√ßon'] || m.NumLecon; const mType = String(m.Type || '').toLowerCase(); return mLesson === currentLesson && mType === currentType; }).sort((a, b) => (parseInt(a.NumExo) || 0) - (parseInt(b.NumExo) || 0));
                    currentLessonIndex = lessonExercises.findIndex(m => m.EvalID === evalId);
                }
                const evaluations = await loadSheet('EVALUATIONS');
                evaluation = evaluations.find(e => e.ID === evalId);
                if (!evaluation) { renderError('√âvaluation "' + evalId + '" non trouv√©e.'); return; }
                const allExercices = await loadSheet('EXERCICES');
                exercices = allExercices.filter(ex => ex.EvalID === evalId).sort((a, b) => (parseInt(a.Ordre) || 0) - (parseInt(b.Ordre) || 0));
                if (exercices.length === 0) { renderError('Aucune √©tape trouv√©e pour cette √©valuation.'); return; }
                totalSteps = exercices.length;
                stepResults = new Array(totalSteps).fill(null);
                elements = await loadSheet('ELEMENTS');
                const evalType = String(evaluation.Type || '').toLowerCase();
                const isEvaluation = evalType === 'evaluation';
                document.getElementById('pageTitle').textContent = '‚úÖ ' + (evaluation.Nom || 'Exercice');
                document.getElementById('pageSubtitle').textContent = evaluation.Description || '√âvaluation de connaissances';
                document.getElementById('breadcrumbCurrent').textContent = '‚úÖ ' + (evaluation.Nom || 'Exercice');
                const menuLink = document.getElementById('menuLink');
                if (isEvaluation) { menuLink.href = BASE_PATH + '/pages/evaluation-connaissances.html'; menuLink.textContent = '√âval. de connaissances'; }
                const dureeMinutes = parseInt(evaluation['Dur√©e']) || parseInt(evaluation.Duree) || 10;
                timeLeft = dureeMinutes * 60;
                showStep(0);
            } catch (e) { console.error('Erreur:', e); renderError('Impossible de charger l\'√©valuation.'); }
        }
        function renderError(message) {
            document.getElementById('content').innerHTML = '<div class="error-message"><h3>‚ùå Erreur</h3><p>' + message + '</p><p style="margin-top: 12px;"><a href="' + BASE_PATH + '/pages/entrainement-connaissances.html">‚Üê Retour √† la liste des exercices</a></p></div>';
        }
        function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = seconds % 60; return m + ':' + s.toString().padStart(2, '0'); }
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(function() {
                timeLeft--;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = '‚è±Ô∏è Temps restant : ' + formatTime(timeLeft);
                    if (timeLeft <= 120) timerEl.classList.add('warning');
                    if (timeLeft <= 0) { clearInterval(timerInterval); verifyCurrentStep(); }
                }
            }, 1000);
        }
        function getStepTypeName(type) {
            const names = { 'timeline': 'Timeline', 'frise': 'Frise', 'qcm': 'QCM', 'ouverte': 'Question', 'dictee': 'Dict√©e', 'erreur': 'Erreur', 'carte': 'Carte', 'image': 'Image' };
            return names[type] || type;
        }
        function renderStepsBreadcrumb() {
            if (totalSteps <= 1) return '';
            let html = '<nav class="steps-breadcrumb"><span class="step-label">√âtapes :</span>';
            exercices.forEach(function(ex, i) {
                const isActive = i === currentStepIndex;
                const isCompleted = stepResults[i] !== null;
                let className = 'step-item';
                if (isActive) className += ' active';
                else if (isCompleted) className += ' completed';
                if (i > 0) html += '<span class="step-separator">‚Ä∫</span>';
                html += '<button class="' + className + '" onclick="goToStep(' + i + ')">' + (i + 1) + '. ' + getStepTypeName(ex.Type) + '</button>';
            });
            html += '</nav>';
            return html;
        }
        function showStep(index) {
            currentStepIndex = index;
            const exercise = exercices[index];
            const banques = exercise.Banque ? exercise.Banque.split(',').map(function(b) { return b.trim(); }) : [];
            const exerciseElements = elements.filter(function(el) { return banques.includes(el.Banque); });
            const formatMap = { 'frise': 'Evenement', 'timeline': 'Evenement', 'qcm': ['Evenement', 'QuestionReponse'], 'ouverte': 'QuestionReponse' };
            const requiredFormat = formatMap[exercise.Type];
            let filteredElements = exerciseElements;
            if (Array.isArray(requiredFormat)) { filteredElements = exerciseElements.filter(function(el) { return requiredFormat.includes(el.Format); }); }
            else if (requiredFormat) { filteredElements = exerciseElements.filter(function(el) { return el.Format === requiredFormat; }); }
            const nombre = parseInt(exercise.Nombre) || 5;
            let selectedElements = filteredElements;
            if (exercise.Mode === 'random' && filteredElements.length > nombre) { selectedElements = shuffleArray(filteredElements.slice()).slice(0, nombre); }
            else { selectedElements = filteredElements.slice(0, nombre); }
            currentExerciseData = { exercise: exercise, elements: selectedElements, startTime: Date.now() };
            renderStep(exercise, selectedElements);
        }
        function renderStep(exercise, selectedElements) {
            let exerciseHtml = '';
            if (exercise.Type === 'timeline') exerciseHtml = renderTimeline(selectedElements);
            else if (exercise.Type === 'frise') exerciseHtml = renderFrise(selectedElements);
            else exerciseHtml = '<p>Type d\'exercice "' + exercise.Type + '" non impl√©ment√©.</p>';
            const html = '<div class="timer-box" id="timer">‚è±Ô∏è Temps restant : ' + formatTime(timeLeft) + '</div>' + renderStepsBreadcrumb() + '<div class="instructions"><strong>üìã Consigne :</strong><p>' + getInstructionForType(exercise.Type) + '</p></div><div class="exercise-card">' + exerciseHtml + '<div class="buttons"><button class="btn-verify" onclick="verifyCurrentStep()">‚úì V√©rifier mes r√©ponses</button><button class="btn-solution" onclick="showSolution()">üìñ Voir le corrig√©</button><button class="btn-restart" onclick="restartStep()">üîÑ Recommencer</button></div><div class="result" id="result"><h3>üìä R√©sultat</h3><p id="resultMessage"></p></div></div>' + renderLessonNavigation();
            document.getElementById('content').innerHTML = html;
            if (exercise.Type === 'timeline') initTimelineDragDrop();
            else if (exercise.Type === 'frise') initFriseDragDrop();
            startTimer();
        }
        function getInstructionForType(type) {
            const instructions = { 'timeline': 'Remets les √©v√©nements dans l\'ordre chronologique, du plus ancien au plus r√©cent.', 'frise': 'Place chaque √©v√©nement sur la date correspondante.', 'qcm': 'S√©lectionne la bonne r√©ponse pour chaque question.', 'ouverte': 'R√©ponds aux questions suivantes.' };
            return instructions[type] || 'Compl√®te l\'exercice suivant.';
        }
        function renderTimeline(elems) {
            const shuffled = shuffleArray(elems.slice());
            let html = '<div class="exercise-header"><div class="exercise-icon">üîÄ</div><div class="exercise-title"><h2>Timeline</h2><p>Remettez les √©v√©nements dans l\'ordre chronologique</p></div></div><div class="timeline-instruction">‚ÜïÔ∏è Glissez les √©v√©nements pour les remettre dans l\'ordre chronologique (du plus ancien au plus r√©cent)</div><div class="timeline-list" id="timelineList">';
            shuffled.forEach(function(el, i) { html += '<div class="timeline-item" draggable="true" data-id="' + el.ID + '" data-date="' + el.Date + '"><span class="drag-handle">‚ò∞</span><div class="item-content"><div class="item-text">' + el.Evenement + '</div></div><div class="order-number">' + (i + 1) + '</div></div>'; });
            html += '</div>';
            return html;
        }
        function initTimelineDragDrop() {
            const list = document.getElementById('timelineList');
            if (!list) return;
            let draggedItem = null;
            list.querySelectorAll('.timeline-item').forEach(function(item) {
                item.addEventListener('dragstart', function() { draggedItem = item; item.classList.add('dragging'); });
                item.addEventListener('dragend', function() { item.classList.remove('dragging'); updateTimelineNumbers(); });
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(list, e.clientY);
                    if (afterElement == null) list.appendChild(draggedItem);
                    else list.insertBefore(draggedItem, afterElement);
                });
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = Array.from(container.querySelectorAll('.timeline-item:not(.dragging)'));
            return draggableElements.reduce(function(closest, child) {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function updateTimelineNumbers() {
            document.querySelectorAll('.timeline-item').forEach(function(item, i) { item.querySelector('.order-number').textContent = i + 1; });
        }
        function renderFrise(elems) {
            const sorted = elems.slice().sort(function(a, b) { return parseInt(a.Date) - parseInt(b.Date); });
            const shuffled = shuffleArray(elems.slice());
            let html = '<div class="exercise-header"><div class="exercise-icon">‚è±Ô∏è</div><div class="exercise-title"><h2>Frise chronologique</h2><p>Placez chaque √©v√©nement √† la bonne date</p></div></div><div class="frise-instruction">üìå Glissez-d√©posez chaque √©v√©nement sur la date correspondante</div><div class="frise-events" id="friseEvents">';
            shuffled.forEach(function(el) { html += '<div class="frise-event" draggable="true" data-id="' + el.ID + '" data-date="' + el.Date + '"><div class="event-text">' + el.Evenement + '</div></div>'; });
            html += '</div><div class="frise-dropzones" id="friseDropzones">';
            sorted.forEach(function(el) { html += '<div class="frise-dropzone" data-expected-date="' + el.Date + '" data-expected-id="' + el.ID + '"><div class="date-label">' + el.Date + '</div><div class="drop-hint">D√©posez ici</div></div>'; });
            html += '</div>';
            return html;
        }
        function initFriseDragDrop() {
            document.querySelectorAll('.frise-event').forEach(function(event) {
                event.addEventListener('dragstart', function(e) { e.dataTransfer.setData('text/plain', event.dataset.id); event.classList.add('dragging'); });
                event.addEventListener('dragend', function() { event.classList.remove('dragging'); });
            });
            document.querySelectorAll('.frise-dropzone').forEach(function(zone) {
                zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', function() { zone.classList.remove('drag-over'); });
                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const eventId = e.dataTransfer.getData('text/plain');
                    const eventEl = document.querySelector('.frise-event[data-id="' + eventId + '"]');
                    if (eventEl && !zone.classList.contains('has-event')) {
                        zone.classList.add('has-event');
                        const placedDiv = document.createElement('div');
                        placedDiv.className = 'placed-event';
                        placedDiv.textContent = eventEl.querySelector('.event-text').textContent;
                        placedDiv.dataset.id = eventId;
                        placedDiv.dataset.date = eventEl.dataset.date;
                        zone.appendChild(placedDiv);
                        eventEl.style.display = 'none';
                    }
                });
            });
        }
            if (exercise.Type === 'timeline') {
                const items = document.querySelectorAll('.timeline-item');
                const userOrder = Array.from(items).map(function(item) { return parseInt(item.dataset.date); });
                const correctOrder = userOrder.slice().sort(function(a, b) { return a - b; });
                total = items.length;
                items.forEach(function(item, i) {
                    const date = parseInt(item.dataset.date);
                    const itemContent = item.querySelector('.item-content');
                    let dateDiv = item.querySelector('.item-date');
                    if (!dateDiv) { dateDiv = document.createElement('div'); dateDiv.className = 'item-date'; itemContent.insertBefore(dateDiv, itemContent.firstChild); }
                    dateDiv.textContent = item.dataset.date;
                    if (date === correctOrder[i]) { correct++; item.classList.add('correct'); item.classList.remove('incorrect'); }
                    else { item.classList.add('incorrect'); item.classList.remove('correct'); }
                    item.draggable = false;
                });
            } else if (exercise.Type === 'frise') {
                const dropzones = document.querySelectorAll('.frise-dropzone');
                total = dropzones.length;
                dropzones.forEach(function(zone) {
                    const expectedId = zone.dataset.expectedId;
                    const placedEvent = zone.querySelector('.placed-event');
                    if (placedEvent && placedEvent.dataset.id === expectedId) { correct++; zone.classList.add('correct'); zone.classList.remove('incorrect'); }
                    else { zone.classList.add('incorrect'); zone.classList.remove('correct'); }
                });
                document.querySelectorAll('.frise-event').forEach(function(el) { el.draggable = false; });
            }
            stepResults[currentStepIndex] = { correct: correct, total: total };
            const percentage = Math.round((correct / total) * 100);
            let message = '';
            if (percentage === 100) message = 'üéâ Parfait ! Tu as tout bon ! Score : ' + correct + '/' + total;
            else if (percentage >= 75) message = 'üëç Tr√®s bien ! Tu as trouv√© ' + correct + '/' + total + ' r√©ponses correctes.';
            else if (percentage >= 50) message = 'üí™ Pas mal ! Tu as trouv√© ' + correct + '/' + total + ' r√©ponses. Continue √† t\'entra√Æner !';
            else message = 'üìö Tu as trouv√© ' + correct + '/' + total + ' r√©ponses. R√©vise et recommence !';
            if (currentStepIndex < totalSteps - 1) {
                message += ' <button onclick="goToStep(' + (currentStepIndex + 1) + ')" style="margin-left: 12px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">√âtape suivante ‚Üí</button>';
            }
            document.getElementById('resultMessage').innerHTML = message;
            document.getElementById('result').classList.add('show');
        }
        function showSolution() {
            clearInterval(timerInterval);
            const exercise = currentExerciseData.exercise;
            if (exercise.Type === 'timeline') {
                const items = Array.from(document.querySelectorAll('.timeline-item'));
                const list = document.getElementById('timelineList');
                items.sort(function(a, b) { return parseInt(a.dataset.date) - parseInt(b.dataset.date); });
                items.forEach(function(item, i) {
                    list.appendChild(item);
                    const itemContent = item.querySelector('.item-content');
                    let dateDiv = item.querySelector('.item-date');
                    if (!dateDiv) { dateDiv = document.createElement('div'); dateDiv.className = 'item-date'; itemContent.insertBefore(dateDiv, itemContent.firstChild); }
                    dateDiv.textContent = item.dataset.date;
                    dateDiv.style.color = 'var(--accent-green)';
                    item.classList.add('correct'); item.classList.remove('incorrect');
                    item.querySelector('.order-number').textContent = i + 1;
                    item.draggable = false;
                });
            } else if (exercise.Type === 'frise') {
                const dropzones = document.querySelectorAll('.frise-dropzone');
                const elems = currentExerciseData.elements;
                dropzones.forEach(function(zone) {
                    const expectedId = zone.dataset.expectedId;
                    const element = elems.find(function(el) { return el.ID === expectedId; });
                    if (element) {
                        const oldPlaced = zone.querySelector('.placed-event');
                        if (oldPlaced) oldPlaced.remove();
                        zone.classList.add('has-event', 'correct'); zone.classList.remove('incorrect');
                        const placedDiv = document.createElement('div');
                        placedDiv.className = 'placed-event';
                        placedDiv.textContent = element.Evenement;
                        zone.appendChild(placedDiv);
                    }
                });
                document.querySelectorAll('.frise-event').forEach(function(el) { el.style.display = 'none'; el.draggable = false; });
            }
            document.getElementById('resultMessage').textContent = 'üìñ Voici le corrig√© complet !';
            document.getElementById('result').classList.add('show');
        }
        function restartStep() { clearInterval(timerInterval); showStep(currentStepIndex); }
        function goToStep(index) { if (index >= 0 && index < totalSteps) { clearInterval(timerInterval); showStep(index); } }
        function renderLessonNavigation() {
            const evalType = String(evaluation.Type || '').toLowerCase();
            const isEvaluation = evalType === 'evaluation';
            const menuLink = isEvaluation ? BASE_PATH + '/pages/evaluation-connaissances.html' : BASE_PATH + '/pages/entrainement-connaissances.html';
            if (!currentMenuEntry || lessonExercises.length === 0) {
                return '<nav class="nav-exercices"><a href="' + menuLink + '" class="nav-btn menu">‚Üê Retour au menu</a><div class="nav-info">Exercice</div><a href="' + menuLink + '" class="nav-btn next">Terminer ‚úì</a></nav>';
            }
            const hasPrev = currentLessonIndex > 0;
            const hasNext = currentLessonIndex < lessonExercises.length - 1;
            const prevExercise = hasPrev ? lessonExercises[currentLessonIndex - 1] : null;
            const nextExercise = hasNext ? lessonExercises[currentLessonIndex + 1] : null;
            let html = '<nav class="nav-exercices">';
            if (hasPrev) html += '<a href="conn.html?id=' + prevExercise.EvalID + '" class="nav-btn prev">‚Üê ' + (prevExercise.TitreExo || 'Exercice ' + prevExercise.NumExo) + '</a>';
            else html += '<a href="' + menuLink + '" class="nav-btn menu">‚Üê Retour au menu</a>';
            html += '<div class="nav-info">Exercice ' + (currentLessonIndex + 1) + ' / ' + lessonExercises.length + '</div>';
            if (hasNext) html += '<a href="conn.html?id=' + nextExercise.EvalID + '" class="nav-btn next">' + (nextExercise.TitreExo || 'Exercice ' + nextExercise.NumExo) + ' ‚Üí</a>';
            else html += '<a href="' + menuLink + '" class="nav-btn next">Terminer ‚úì</a>';
            html += '</nav>';
            return html;
        }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); const temp = array[i]; array[i] = array[j]; array[j] = temp; }
            return array;
        }
        async function init() {
            await loadSidebar();
            const urlParams = new URLSearchParams(window.location.search);
            const evalId = urlParams.get('id');
            if (!evalId) { renderError('Aucun ID d\'√©valuation fourni.'); return; }
            await loadEvaluation(evalId);
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
