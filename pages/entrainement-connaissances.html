<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entra√Ænement Connaissances | Espace cours</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/Activit-s-interactives_2nd-bac-pro/css/style.css">
    <style>
        /* === STYLES SP√âCIFIQUES √Ä CETTE PAGE === */

        /* En-t√™te vert (diff√©rent du violet par d√©faut) */
        .page-header { background: linear-gradient(135deg, #10b981, #059669); }

        /* Dropdown items */
        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; transition: all 0.15s; border-bottom: 1px solid var(--gray-100); }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--primary-bg); }
        .dropdown-item.selected { background: var(--primary-bg); color: var(--primary); }
        .dropdown-item.locked { opacity: 0.6; cursor: not-allowed; }
        .dropdown-item .item-icon { font-size: 18px; width: 24px; text-align: center; }
        .dropdown-item .item-info { flex: 1; }
        .dropdown-item .item-title { font-weight: 600; font-size: 14px; color: var(--gray-800); }
        .dropdown-item.selected .item-title { color: var(--primary); }
        .dropdown-item .item-subtitle { font-size: 12px; color: var(--gray-500); }
        .dropdown-item .item-count { background: var(--gray-100); padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; color: var(--gray-600); }
        .dropdown-item.selected .item-count { background: var(--primary); color: white; }

        /* Grille des connaissances */
        .conn-grid { display: flex; flex-direction: column; gap: 16px; }
        .conn-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; transition: all 0.3s; }
        .conn-card.hidden { display: none; }
        .conn-card:hover { box-shadow: var(--shadow-lg); }
        .conn-header { padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: background 0.2s; }
        .conn-header:hover { background: var(--gray-50); }
        .conn-header-left { display: flex; align-items: center; gap: 16px; }
        .conn-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; flex-shrink: 0; }
        .conn-icon.histoire { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .conn-icon.geographie { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .conn-icon.litterature { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .conn-icon.emc { background: linear-gradient(135deg, #ec4899, #db2777); }
        .conn-info h3 { font-size: 18px; font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
        .conn-meta { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--gray-500); }
        .conn-count { display: flex; align-items: center; gap: 4px; }
        .conn-status { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .conn-status.disponible { background: var(--accent-green-light); color: var(--accent-green); }
        .conn-status.locked { background: var(--gray-100); color: var(--gray-500); }
        .conn-toggle { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; color: var(--gray-400); transition: all 0.3s; }
        .conn-card.open .conn-toggle { transform: rotate(180deg); color: var(--primary); }

        /* Liste des sujets */
        .sujets-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; background: var(--gray-50); border-top: 1px solid var(--gray-100); }
        .conn-card.open .sujets-list { max-height: 1000px; }
        .sujets-container { padding: 16px 24px 20px; display: flex; flex-direction: column; gap: 10px; }
        .sujet-item { display: flex; align-items: center; gap: 14px; padding: 14px 18px; background: white; border-radius: 10px; text-decoration: none; transition: all 0.2s; border: 1px solid var(--gray-200); }
        .sujet-item:hover { border-color: var(--primary-light); transform: translateX(4px); box-shadow: var(--shadow-md); }
        .sujet-item.locked { opacity: 0.6; pointer-events: none; cursor: not-allowed; }
        .sujet-icon { width: 40px; height: 40px; background: var(--accent-green-light); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .sujet-item.locked .sujet-icon { background: var(--gray-100); }
        .sujet-info { flex: 1; }
        .sujet-info h4 { font-size: 15px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; }
        .sujet-badges { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .sujet-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 500; background: var(--accent-green-light); color: var(--accent-green); }
        .sujet-arrow { color: var(--gray-400); font-size: 16px; transition: transform 0.2s; }
        .sujet-item:hover .sujet-arrow { transform: translateX(4px); color: var(--primary); }

        /* √âtat verrouill√© */
        .conn-card.locked { opacity: 0.7; }
        .conn-card.locked .conn-header { cursor: default; }
        .conn-card.locked .conn-header:hover { background: transparent; }
        .conn-card.locked .conn-icon { background: linear-gradient(135deg, var(--gray-400), var(--gray-500)); }

        /* Responsive sp√©cifique */
        @media (max-width: 768px) {
            .conn-header { padding: 16px; }
            .conn-icon { width: 42px; height: 42px; font-size: 18px; }
            .conn-info h3 { font-size: 16px; }
            .sujets-container { padding: 12px 16px 16px; }
            .dropdown { width: 100%; }
            .dropdown-toggle { width: 100%; }
            .dropdown-menu { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <button class="menu-toggle" id="menuToggle">‚ò∞</button>
            <a href="/Activit-s-interactives_2nd-bac-pro/index.html" class="logo">
                <div class="logo-icon">üìö</div>
                <div class="logo-text">Espace cours <span>‚Ä¢ Mme Meyer</span></div>
            </a>
        </div>
    </header>
    <aside class="sidebar collapsed" id="sidebar">
        <div class="sidebar-inner" id="sidebarContent"></div>
    </aside>
    <div class="overlay" id="overlay"></div>
    <main class="main">
        <div class="main-inner">
            <nav class="breadcrumb">
                <a href="/Activit-s-interactives_2nd-bac-pro/index.html">üè† Accueil</a>
                <span class="separator">‚Ä∫</span>
                <span class="current">Entra√Ænement Connaissances</span>
            </nav>
            <div class="page-header">
                <h1>‚úÖ Entra√Ænement Connaissances</h1>
                <p>Entra√Æne-toi et v√©rifie tes connaissances sur chaque le√ßon</p>
            </div>
            <div class="filter-bar" id="filterBar" style="display: none;">
                <button class="filter-btn active" id="btnAll" onclick="filterCONN('all')">
                    üìö Tous <span class="btn-count" id="countAll">0</span>
                </button>
                <div class="dropdown" id="dropdown">
                    <button class="dropdown-toggle" onclick="toggleDropdown()">
                        <span id="dropdownLabel">Choisir une le√ßon</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu"></div>
                </div>
            </div>
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Chargement des entra√Ænements...</p>
            </div>
            <div class="empty-state" id="emptyState">
                <div class="icon">üì≠</div>
                <h3>Aucun entra√Ænement disponible</h3>
                <p>Les entra√Ænements seront bient√¥t disponibles.</p>
            </div>
            <div class="conn-grid" id="connGrid" style="display: none;"></div>
        </div>
    </main>

    <script>
        const BASE_PATH = '/Activit-s-interactives_2nd-bac-pro';
        const CURRENT_PAGE = 'entrainement-conn';
        
        // NOUVEAU Google Sheet ID
        const SHEET_ID = '1zn0MzEEz-nq-KoVSqghztMA_JZV36PECO4h35xM9or8';
        const SHEET_NAME = 'MENU_CONN';
        
        // Type √† filtrer : entrainement (ou vide pour r√©trocompatibilit√©)
        const TYPE_FILTER = 'entrainement';
        
        const MATIERE_ICONS = {
            'histoire': 'üìú',
            'g√©ographie': 'üåç',
            'geographie': 'üåç',
            'litt√©rature': 'üìö',
            'litterature': 'üìö',
            'emc': '‚öñÔ∏è'
        };

        let allConnData = [];
        let currentFilter = 'all';

        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const overlay = document.getElementById('overlay');

        function toggleSidebar() {
            const isCollapsed = sidebar.classList.contains('collapsed');
            if (isCollapsed) {
                sidebar.classList.remove('collapsed');
                menuToggle.classList.add('active');
                overlay.classList.add('visible');
            } else {
                sidebar.classList.add('collapsed');
                menuToggle.classList.remove('active');
                overlay.classList.remove('visible');
            }
            localStorage.setItem('sidebarOpen', !sidebar.classList.contains('collapsed'));
        }

        menuToggle.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);
        if (localStorage.getItem('sidebarOpen') === 'true') {
            sidebar.classList.remove('collapsed');
            menuToggle.classList.add('active');
        }

        async function loadSidebar() {
            try {
                const response = await fetch(`${BASE_PATH}/components/sidebar.html`);
                if (!response.ok) throw new Error('Sidebar not found');
                const html = await response.text();
                document.getElementById('sidebarContent').innerHTML = html;
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    if (item.dataset.page === CURRENT_PAGE) item.classList.add('active');
                });
                document.querySelectorAll('.sidebar-item.disabled, .sidebar-item[href="#"]').forEach(link => {
                    link.addEventListener('click', e => e.preventDefault());
                });
            } catch (error) {
                console.error('Erreur chargement sidebar:', error);
            }
        }

        async function loadCONN() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
                const response = await fetch(url);
                const text = await response.text();
                
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}') + 1;
                const jsonText = text.substring(jsonStart, jsonEnd);
                const json = JSON.parse(jsonText);

                if (!json.table || !json.table.rows) throw new Error('No data');

                const data = [];
                for (let i = 0; i < json.table.rows.length; i++) {
                    const row = json.table.rows[i].c;
                    if (!row) continue;

                    // Colonnes: NumLe√ßon, NumExo, TitreLe√ßon, TitreExo, Mati√®re, Statut, Type, EvalID
                    const numLecon = row[0]?.v ?? '';
                    const numExo = row[1]?.v ?? '';
                    const titreLecon = row[2]?.v || '';
                    const titreExo = row[3]?.v || '';
                    const matiere = row[4]?.v || '';
                    const statut = String(row[5]?.v || '').toLowerCase();
                    const type = String(row[6]?.v || '').toLowerCase().trim();
                    const evalId = row[7]?.v || '';

                    // Skip header row
                    if (String(numLecon).toLowerCase().includes('numle')) continue;
                    if (numLecon === '' && numExo === '') continue;

                    // FILTRER par type : entrainement OU vide (r√©trocompatibilit√©)
                    if (type !== '' && type !== TYPE_FILTER) continue;

                    data.push({
                        numLecon: String(numLecon).trim(),
                        numExo: parseInt(numExo) || 0,
                        titreLecon: String(titreLecon).trim(),
                        titreExo: String(titreExo).trim(),
                        matiere: String(matiere).trim().toLowerCase(),
                        statut: statut.includes('disponible') ? 'disponible' : '√† venir',
                        type: type,
                        evalId: String(evalId).trim()
                    });
                }

                if (data.length === 0) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                allConnData = transformToConnList(data);
                renderFilterBar(allConnData);
                renderCONN(allConnData);

            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function transformToConnList(data) {
            const connMap = {};
            
            data.forEach(item => {
                if (!connMap[item.numLecon]) {
                    connMap[item.numLecon] = {
                        numLecon: item.numLecon,
                        titre: '',
                        matiere: '',
                        statut: '√† venir',
                        sujets: []
                    };
                }

                if (item.numExo === 0) {
                    // Ligne d'en-t√™te explicite
                    connMap[item.numLecon].titre = item.titreLecon;
                    connMap[item.numLecon].matiere = item.matiere;
                    connMap[item.numLecon].statut = item.statut;
                } else {
                    // C'est un exercice
                    connMap[item.numLecon].sujets.push({
                        numSujet: item.numExo,
                        titre: item.titreExo || `Sujet ${item.numExo}`,
                        statut: item.statut,
                        evalId: item.evalId
                    });
                    
                    // Si pas encore de titre/mati√®re, utiliser ceux de l'exercice
                    if (!connMap[item.numLecon].titre && item.titreLecon) {
                        connMap[item.numLecon].titre = item.titreLecon;
                    }
                    if (!connMap[item.numLecon].matiere && item.matiere) {
                        connMap[item.numLecon].matiere = item.matiere;
                    }
                    // La le√ßon est disponible si au moins un exercice est disponible
                    if (item.statut === 'disponible') {
                        connMap[item.numLecon].statut = 'disponible';
                    }
                }
            });

            return Object.values(connMap).sort((a, b) => {
                if (a.matiere !== b.matiere) return a.matiere.localeCompare(b.matiere);
                return a.numLecon.localeCompare(b.numLecon);
            });
        }

        function renderFilterBar(connList) {
            const totalSujets = connList.reduce((sum, conn) => sum + conn.sujets.length, 0);
            document.getElementById('countAll').textContent = totalSujets;
            
            const dropdownMenu = document.getElementById('dropdownMenu');
            let menuHtml = connList.map(conn => {
                const isLocked = conn.statut !== 'disponible';
                const icon = getIconForMatiere(conn.matiere);
                const sujetCount = conn.sujets.length;
                const shortTitle = conn.titre || conn.numLecon;
                
                return `
                    <div class="dropdown-item ${isLocked ? 'locked' : ''}" 
                         data-lecon="${conn.numLecon}" 
                         onclick="${isLocked ? '' : `selectCONN('${conn.numLecon}', '${icon}', '${shortTitle.replace(/'/g, "\\'")}')`}">
                        <span class="item-icon">${isLocked ? 'üîí' : icon}</span>
                        <div class="item-info">
                            <div class="item-title">${conn.numLecon} - ${shortTitle}</div>
                            <div class="item-subtitle">${sujetCount} sujet${sujetCount > 1 ? 's' : ''}</div>
                        </div>
                        <span class="item-count">${sujetCount}</span>
                    </div>
                `;
            }).join('');
            
            dropdownMenu.innerHTML = menuHtml;
            document.getElementById('filterBar').style.display = 'flex';
        }

        function getIconForMatiere(matiere) {
            const normalized = matiere.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return MATIERE_ICONS[normalized] || 'üìã';
        }

        function toggleDropdown() {
            document.getElementById('dropdown').classList.toggle('open');
        }

        function closeDropdown() {
            document.getElementById('dropdown').classList.remove('open');
        }

        function selectCONN(numLecon, icon, title) {
            currentFilter = numLecon;
            document.getElementById('dropdownLabel').innerHTML = `${icon} ${numLecon} - ${title}`;
            document.querySelector('.dropdown-toggle').classList.add('has-selection');
            document.getElementById('btnAll').classList.remove('active');
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.lecon === numLecon) item.classList.add('selected');
            });
            closeDropdown();
            applyFilter(numLecon);
        }

        function filterCONN(filter) {
            if (filter === 'all') {
                currentFilter = 'all';
                document.getElementById('btnAll').classList.add('active');
                document.getElementById('dropdownLabel').textContent = 'Choisir une le√ßon';
                document.querySelector('.dropdown-toggle').classList.remove('has-selection');
                document.querySelectorAll('.dropdown-item').forEach(item => item.classList.remove('selected'));
                closeDropdown();
                applyFilter('all');
            }
        }

        function applyFilter(filter) {
            document.querySelectorAll('.conn-card').forEach(card => {
                const cardLecon = card.dataset.lecon;
                if (filter === 'all') {
                    card.classList.remove('hidden');
                    card.classList.remove('open');
                } else {
                    if (cardLecon === filter) {
                        card.classList.remove('hidden');
                        if (!card.classList.contains('locked')) card.classList.add('open');
                    } else {
                        card.classList.add('hidden');
                    }
                }
            });
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('dropdown');
            if (dropdown && !dropdown.contains(e.target)) closeDropdown();
        });

        function renderCONN(connList) {
            const container = document.getElementById('connGrid');
            container.innerHTML = '';
            connList.forEach(conn => {
                const card = createCONNCard(conn);
                container.appendChild(card);
            });
            document.getElementById('loading').style.display = 'none';
            container.style.display = 'flex';
        }

        function createCONNCard(conn) {
            const card = document.createElement('div');
            card.className = 'conn-card';
            card.dataset.lecon = conn.numLecon;
            
            const isLocked = conn.statut !== 'disponible';
            if (isLocked) card.classList.add('locked');

            const sujetCount = conn.sujets.length;
            const icon = getIconForMatiere(conn.matiere);
            const matiereClass = conn.matiere.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            card.innerHTML = `
                <div class="conn-header" onclick="${isLocked ? '' : 'toggleCONN(this.parentElement)'}">
                    <div class="conn-header-left">
                        <div class="conn-icon ${matiereClass}">${icon}</div>
                        <div class="conn-info">
                            <h3>${conn.titre || conn.numLecon}</h3>
                            <div class="conn-meta">
                                <span class="conn-count">${isLocked ? 'üîí' : 'üìù'} ${sujetCount} sujet${sujetCount > 1 ? 's' : ''}</span>
                                <span class="conn-status ${isLocked ? 'locked' : 'disponible'}">${isLocked ? 'üîí √Ä venir' : '‚úÖ Disponible'}</span>
                            </div>
                        </div>
                    </div>
                    ${!isLocked ? '<div class="conn-toggle">‚ñº</div>' : ''}
                </div>
                ${!isLocked ? createSujetsList(conn.sujets, conn.numLecon) : ''}
            `;
            return card;
        }

        function createSujetsList(sujets, numLecon) {
            if (sujets.length === 0) {
                return `<div class="sujets-list"><div class="sujets-container"><p style="color: var(--gray-500); text-align: center; padding: 20px;">Aucun sujet disponible pour le moment.</p></div></div>`;
            }

            sujets.sort((a, b) => a.numSujet - b.numSujet);

            const items = sujets.map(sujet => {
                const isLocked = sujet.statut !== 'disponible';
                
                // UTILISER EvalID pour le lien vers l'exercice
                let href = '#';
                if (!isLocked && sujet.evalId) {
                    href = `exercices/conn.html?id=${sujet.evalId}`;
                } else if (!isLocked) {
                    // Fallback ancien format
                    href = `exercices/templates/conn.html?chap=${numLecon}&sujet=${sujet.numSujet}`;
                }

                return `
                    <a href="${href}" class="sujet-item ${isLocked ? 'locked' : ''}">
                        <div class="sujet-icon">${isLocked ? 'üîí' : '‚úèÔ∏è'}</div>
                        <div class="sujet-info">
                            <h4>${sujet.titre}</h4>
                            <div class="sujet-badges">
                                <span class="sujet-badge">üìã Entra√Ænement</span>
                            </div>
                        </div>
                        ${!isLocked ? '<span class="sujet-arrow">‚Üí</span>' : ''}
                    </a>
                `;
            }).join('');

            return `<div class="sujets-list"><div class="sujets-container">${items}</div></div>`;
        }

        function toggleCONN(card) {
            card.classList.toggle('open');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar();
            loadCONN();
        });
    </script>
</body>
</html>
